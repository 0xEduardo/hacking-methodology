# Subdomain Takeover

> **Summary**: Subdomain takeover occurs when a subdomain points (via CNAME, A, NS, or other DNS records) to an external service that has been deprovisioned, allowing an attacker to claim the resource and serve content on the victim's subdomain.
> **Impact**: Phishing under a trusted domain, session cookie theft, OAuth token hijacking, CSP/CORS bypass, email spoofing.
> **Typical Severity**: High | Critical

## How It Works

1. An organization creates a DNS record (typically CNAME) pointing `sub.example.com` to a third-party service (e.g., `example.github.io`, `example.herokuapp.com`).
2. The organization deprovisions the resource on the third-party service but forgets to remove the DNS record.
3. The CNAME still resolves, but the third-party service returns an error or unclaimed resource page.
4. An attacker registers the same resource name on the third-party service and now controls content served under `sub.example.com`.

### DNS Record Types Vulnerable

| Record Type | Scenario |
|-------------|----------|
| **CNAME** | Points to a deprovisioned third-party service (most common) |
| **A / AAAA** | Points to a released elastic IP or decommissioned server |
| **NS** | Delegated nameserver no longer controlled by the org (highest impact) |
| **MX** | Mail exchange pointing to unclaimed service -- enables email interception |
| **Wildcard** | `*.example.com` CNAME to an attacker-claimable service amplifies to infinite subdomains |

## Detection

### Indicators

- HTTP response contains a service-specific error page (e.g., "There isn't a GitHub Pages site here", "No such app" from Heroku)
- DNS CNAME resolves but the target returns NXDOMAIN or connection refused
- TLS certificate mismatch on the subdomain
- Historical DNS records show previously used third-party services

### Automated Detection

```bash
# Subjack -- check for takeover on a list of subdomains
subjack -w <SUBDOMAINS_LIST> -t 100 -timeout 30 -o <OUTPUT_FILE> -ssl

# Nuclei -- run takeover-specific templates
nuclei -l <SUBDOMAINS_LIST> -tags takeover -o <OUTPUT_FILE>

# Subzy -- fast subdomain takeover checker
subzy run --targets <SUBDOMAINS_LIST> --output <OUTPUT_FILE>

# Subdominator -- modern takeover detection
subdominator -l <SUBDOMAINS_LIST> -o <OUTPUT_FILE>

# dnsx -- resolve CNAMEs for manual review
dnsx -l <SUBDOMAINS_LIST> -cname -resp -o <CNAME_OUTPUT>

# BBOT -- full recon pipeline with takeover checks
bbot -t <TARGET_DOMAIN> -p subdomain-enum -m subdomain_takeover
```

### Manual Detection

1. Resolve the subdomain and inspect the CNAME chain:
```bash
dig <SUBDOMAIN> CNAME +short
host <SUBDOMAIN>
```
2. Visit the subdomain in a browser and look for service-specific error fingerprints.
3. Check if the CNAME target is claimable by attempting to register the resource on the third-party platform.
4. For NS takeover, check if delegated nameservers are expired domains:
```bash
dig <SUBDOMAIN> NS +short
whois <NAMESERVER_DOMAIN>
```

## Exploitation

### Prerequisites

- A subdomain with a dangling DNS record pointing to a claimable external resource
- An account on the target third-party service
- Ability to register or claim the specific resource name

### Step-by-Step

1. **Enumerate subdomains** of the target using passive and active recon.
   - Success: A list of subdomains with resolved DNS records.
2. **Identify dangling records** by resolving CNAMEs and matching against known vulnerable fingerprints.
   - Success: One or more subdomains returning service error pages or NXDOMAIN on the CNAME target.
3. **Verify claimability** by attempting to register the resource name on the third-party service.
   - Success: The service allows you to create the resource (e.g., a GitHub Pages repo, an S3 bucket, a Heroku app).
4. **Claim the resource** and deploy a proof-of-concept page (e.g., a simple HTML file with a unique string).
   - Success: Browsing `https://<SUBDOMAIN>` displays your controlled content.
5. **Obtain a TLS certificate** via Let's Encrypt to make the takeover fully convincing.
   - Success: HTTPS works on the taken-over subdomain with a valid certificate.

### Vulnerable Service Fingerprints

| Service | CNAME Pattern | Error Fingerprint |
|---------|---------------|-------------------|
| **GitHub Pages** | `*.github.io` | "There isn't a GitHub Pages site here." |
| **Heroku** | `*.herokuapp.com` | "No such app" |
| **AWS S3** | `*.s3.amazonaws.com` | "NoSuchBucket" |
| **AWS CloudFront** | `*.cloudfront.net` | "Bad Request" / ERROR: The request could not be satisfied |
| **Azure** | `*.azurewebsites.net`, `*.cloudapp.azure.com` | "404 Web Site not found" |
| **Shopify** | CNAME to `shops.myshopify.com` | "Sorry, this shop is currently unavailable." |
| **Fastly** | CNAME to `*.fastly.net` | "Fastly error: unknown domain" |
| **Pantheon** | `*.pantheonsite.io` | "404 error unknown site!" |
| **Tumblr** | CNAME to `domains.tumblr.com` | "There's nothing here." |
| **Zendesk** | CNAME to `*.zendesk.com` | "Help Center Closed" |
| **Unbounce** | CNAME to `unbouncepages.com` | "The requested URL was not found" |
| **Ghost** | CNAME to `*.ghost.io` | "The thing you were looking for is no longer here" |
| **Netlify** | CNAME to `*.netlify.app` | Page not found (Netlify default) |
| **Vercel** | CNAME to `cname.vercel-dns.com` | "The deployment could not be found" |
| **Surge.sh** | CNAME to `*.surge.sh` | "project not found" |
| **Cargo** | CNAME to `*.cargocollective.com` | "404 Not Found" |
| **WordPress.com** | CNAME to `*.wordpress.com` | "Do you want to register" |
| **Fly.io** | CNAME to `*.fly.dev` | "404 Not Found" |
| **Bitbucket** | CNAME to `*.bitbucket.io` | "Repository not found" |

For the most up-to-date list, consult: https://github.com/EdOverflow/can-i-take-over-xyz

### Proof of Concept

For a GitHub Pages takeover:
1. Identify `sub.example.com` with CNAME pointing to `orgname.github.io`.
2. Create a GitHub repository named `orgname.github.io` (or the specific repo if using project pages).
3. Add an `index.html` with PoC content and a `CNAME` file containing `sub.example.com`.
4. Enable GitHub Pages in the repo settings.
5. Browse `https://sub.example.com` to confirm the takeover.

For an S3 bucket takeover:
```bash
# Create the bucket with the exact name from the CNAME
aws s3 mb s3://<BUCKET_NAME> --region <REGION>

# Upload a PoC file
echo "<h1>Subdomain Takeover PoC</h1>" > index.html
aws s3 cp index.html s3://<BUCKET_NAME>/index.html --acl public-read

# Enable static website hosting
aws s3 website s3://<BUCKET_NAME> --index-document index.html
```

## Bypasses

### Wildcard DNS Takeover

When `*.example.com` is a CNAME wildcard to a claimable service, any non-existent subdomain becomes takeover-able. This amplifies impact to unlimited subdomains.

### NS Delegation Takeover

If the NS records for a subdomain zone (e.g., `sub.example.com NS ns1.expired-domain.com`) point to an expired or purchasable domain:
1. Purchase the expired nameserver domain.
2. Set up a DNS server on it.
3. Serve arbitrary DNS records for the entire `sub.example.com` zone.
4. Impact: Full control over all records under the delegated zone, including A, MX, TXT (SPF/DKIM).

### Second-Order Subdomain Takeover

- The target subdomain itself is not directly vulnerable, but it loads resources (JS, CSS, iframes) from a subdomain that IS vulnerable to takeover.
- Takeover the dependency subdomain to inject malicious content into the parent.

### Domain Verification Bypass

Some services (e.g., GitLab, Google) require domain verification via DNS TXT records. If the verification was done once and the DNS record was later removed, the binding may persist, preventing takeover. Check if the service allows re-verification or if the binding can be broken.

## Escalation

### Cookie Theft
If `example.com` sets cookies with `Domain=.example.com`, the taken-over subdomain `sub.example.com` can read those cookies:
- Host a page that exfiltrates `document.cookie` to an attacker-controlled server.
- Steal session tokens, CSRF tokens, or authentication cookies.
- See: [Cookie Based Attacks](cookie-based-attacks.md)

### OAuth Token Hijacking
If the taken-over subdomain is listed as an allowed `redirect_uri` in an OAuth configuration:
1. Craft an OAuth authorization URL with `redirect_uri=https://sub.example.com/callback`.
2. Victim authorizes the app, and the OAuth code/token is sent to the attacker's controlled subdomain.
3. See: [OAuth](../authentication/oauth.md)

### CORS Bypass
If the main application allows CORS from `*.example.com`:
- The taken-over subdomain can make cross-origin requests and read responses from the main domain.
- See: [CORS](cors.md)

### CSP Bypass
If the Content Security Policy includes `*.example.com` in `script-src`:
- Serve malicious JavaScript from the taken-over subdomain.
- Bypass CSP restrictions on the main application.
- See: [XSS](xss.md)

### CSRF / SameSite Cookie Bypass
- The taken-over subdomain is considered same-site to the main domain.
- Cookies with `SameSite=Lax` or `SameSite=Strict` will be sent on requests from the subdomain to the main domain.
- This enables CSRF attacks that would otherwise be blocked by SameSite protections.
- See: [CSRF](csrf.md)

### Email Spoofing (MX Takeover)
If MX records point to an unclaimed service:
- Receive emails sent to addresses at the subdomain.
- Send emails from the subdomain, potentially passing SPF checks.
- Enhances phishing credibility significantly.

### Phishing
- Host a convincing phishing page on the taken-over subdomain.
- Obtain a valid Let's Encrypt TLS certificate for full HTTPS.
- The subdomain belongs to the legitimate organization, making phishing extremely effective.

## Tools

| Tool | Usage |
|------|-------|
| [subjack](https://github.com/haccer/subjack) | `subjack -w <SUBDOMAINS> -t 100 -ssl` |
| [nuclei](https://github.com/projectdiscovery/nuclei) | `nuclei -l <SUBDOMAINS> -tags takeover` |
| [subzy](https://github.com/PentestPad/subzy) | `subzy run --targets <SUBDOMAINS>` |
| [Subdominator](https://github.com/Stratus-Security/Subdominator) | `subdominator -l <SUBDOMAINS>` |
| [can-i-take-over-xyz](https://github.com/EdOverflow/can-i-take-over-xyz) | Reference for vulnerable services and fingerprints |
| [dnsReaper](https://github.com/punk-security/dnsReaper) | `dnsreaper scan --domains <DOMAIN>` |
| [BBOT](https://github.com/blacklanternsecurity/bbot) | `bbot -t <DOMAIN> -p subdomain-enum` |
| [dnsx](https://github.com/projectdiscovery/dnsx) | `dnsx -l <SUBDOMAINS> -cname -resp` |
| [mx-takeover](https://github.com/musana/mx-takeover) | MX record takeover detection |

## Mitigation

- Remove dangling DNS records when deprovisioning external services (DNS cleanup should be the first step in resource destruction).
- Implement regular automated scanning for orphaned DNS records.
- Use domain verification features offered by cloud providers.
- Monitor Certificate Transparency logs for unauthorized certificate issuance on your subdomains.

## Agent Workflow
> Step-by-step instructions for an AI agent to test for subdomain takeover.

### Phase 1: Discovery
1. Run subdomain enumeration against `<TARGET_DOMAIN>` using multiple sources:
   ```bash
   subfinder -d <TARGET_DOMAIN> -all -o <SUBFINDER_OUTPUT>
   amass enum -passive -d <TARGET_DOMAIN> -o <AMASS_OUTPUT>
   ```
2. Merge and deduplicate all discovered subdomains into `<ALL_SUBDOMAINS>`.
3. Resolve DNS records for each subdomain, extracting CNAME, A, NS, and MX records:
   ```bash
   dnsx -l <ALL_SUBDOMAINS> -cname -resp -o <CNAME_OUTPUT>
   dnsx -l <ALL_SUBDOMAINS> -ns -resp -o <NS_OUTPUT>
   ```
4. Filter subdomains with CNAMEs pointing to known third-party services (GitHub, Heroku, S3, Azure, Shopify, Fastly, etc.).
5. Identify NS delegations pointing to potentially expired or purchasable domains.

### Phase 2: Validation
1. For each CNAME pointing to a third-party service, match the CNAME target against the fingerprint table (e.g., `*.github.io`, `*.herokuapp.com`, `*.s3.amazonaws.com`).
2. Visit each candidate subdomain via HTTP/HTTPS and check the response body for service-specific error fingerprints:
   - GitHub Pages: `"There isn't a GitHub Pages site here."`
   - Heroku: `"No such app"`
   - S3: `"NoSuchBucket"`
   - Azure: `"404 Web Site not found"`
   - Shopify: `"Sorry, this shop is currently unavailable."`
3. Run automated takeover checkers for confirmation:
   ```bash
   subjack -w <CANDIDATE_SUBDOMAINS> -t 100 -timeout 30 -ssl -o <SUBJACK_OUTPUT>
   nuclei -l <CANDIDATE_SUBDOMAINS> -tags takeover -o <NUCLEI_OUTPUT>
   ```
4. For NS takeover candidates, check `whois` on each delegated nameserver domain for expiration status.
5. Cross-reference with https://github.com/EdOverflow/can-i-take-over-xyz to confirm the service is currently exploitable.

### Phase 3: Exploitation
1. Register an account on the vulnerable third-party service if not already done.
2. Claim the resource name matching the CNAME target (e.g., create a GitHub repo named `<ORG>.github.io`, create an S3 bucket named `<BUCKET_NAME>`, register a Heroku app named `<APP_NAME>`).
3. Deploy a proof-of-concept `index.html` containing a unique identifier string (e.g., `<h1>Subdomain Takeover PoC - <UNIQUE_ID></h1>`).
4. For GitHub Pages, add a `CNAME` file containing `<SUBDOMAIN>`.
5. Browse `https://<SUBDOMAIN>` and confirm the PoC content is served.
6. Optionally obtain a TLS certificate via Let's Encrypt for HTTPS validation.

### Phase 4: Escalation
1. Check if `<TARGET_DOMAIN>` sets cookies with `Domain=.<TARGET_DOMAIN>` -- if so, the taken-over subdomain can read/exfiltrate session cookies.
2. Check if the taken-over subdomain is an allowed `redirect_uri` in any OAuth/SSO configuration for the target.
3. Check if the application's CORS policy allows `*.TARGET_DOMAIN` -- if so, the subdomain can make authenticated cross-origin requests.
4. Check if the CSP `script-src` includes `*.TARGET_DOMAIN` -- if so, serve malicious JS from the taken-over subdomain.
5. For NS takeover, verify full control over the zone (A, MX, TXT records) to enable email spoofing and SPF bypass.
6. Document all chaining opportunities: cookie theft, OAuth hijack, CORS bypass, CSP bypass, phishing.

## Decision Tree

```
Start: Enumerate subdomains and resolve DNS
  |
  +---> CNAME points to third-party service?
  |       +---> Yes: Check if resource is unclaimed (service fingerprint match)
  |       |       +---> Unclaimed: CNAME Takeover (claim resource)
  |       |       +---> Claimed: Not directly vulnerable (check for second-order)
  |       +---> No: Check NS records
  |
  +---> NS delegated to external domain?
  |       +---> Domain expired/purchasable? --> NS Takeover (register domain)
  |       +---> Domain active? --> Not vulnerable via NS
  |
  +---> A record points to released IP?
  |       +---> Claim the IP (elastic IP / VPS)
  |
  +---> Second-order: Does the target page load resources from a vulnerable subdomain?
          +---> Yes: Take over the dependency subdomain
          +---> No: Not vulnerable
```

## Success Criteria
- [ ] Controlled HTML content is served at `https://<SUBDOMAIN>` and is accessible by any user
- [ ] The PoC page renders with a valid TLS certificate under the target domain
- [ ] If escalating: session cookies from the parent domain are readable from the taken-over subdomain
- [ ] If escalating: OAuth tokens or CORS-authenticated responses can be intercepted

## References

- https://github.com/EdOverflow/can-i-take-over-xyz
- https://0xpatrik.com/subdomain-takeover/
- https://www.hackerone.com/blog/guide-subdomain-takeovers-20
- https://www.stratussecurity.com/post/subdomain-takeover-guide
- https://developer.mozilla.org/en-US/docs/Web/Security/Subdomain_takeovers
- https://book.hacktricks.wiki/en/pentesting-web/domain-subdomain-takeover.html
